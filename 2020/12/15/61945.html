<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="rabbitmq笔记(入门), 刘民锴的个人博客">
    <meta name="description" content="刘民锴使用hexo和githubpages 搭建的个人博客 主要用于记录学习笔记 和 技术分享">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>


    <title>rabbitmq笔记(入门) | 刘民锴的个人博客</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">刘民锴的个人博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-sticky-note" style="zoom: 0.6;"></i>
      
      <span>Essay</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">刘民锴的个人博客</div>
        <div class="logo-desc">
            
            刘民锴使用hexo和githubpages 搭建的个人博客 主要用于记录学习笔记 和 技术分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-sticky-note"></i>
			
			Essay
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/kaiminliu" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/kaiminliu" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">rabbitmq笔记(入门)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/message-queue/">
                                <span class="chip bg-color">message queue</span>
                            </a>
                        
                            <a href="/tags/rabbitmq/">
                                <span class="chip bg-color">rabbitmq</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                学习笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-12-15
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-12-19
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    13.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    67 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>笔记来自：B站编程不良人，稍作修改、补充</p>
</blockquote>
<h2><span id="1-mq-yin-yan">1.MQ引言</span><a href="#1-mq-yin-yan" class="header-anchor">.</a></h2><h3><span id="1-1-shi-me-shi-mq">1.1 什么是MQ</span><a href="#1-1-shi-me-shi-mq" class="header-anchor">.</a></h3><p><code>MQ</code>(Message Quene) :  翻译为 <code>消息队列</code>,通过典型的 <code>生产者</code>和<code>消费者</code>模型,生产者不断向消息队列中生产消息，消费者不断的从队列中获取消息。因为消息的生产和消费都是异步的，而且只关心消息的发送和接收，没有业务逻辑的侵入,轻松的实现系统间解耦。别名为 <code>消息中间件</code>    通过利用高效可靠的消息传递机制进行平台无关的数据交流，并基于数据通信来进行分布式系统的集成。</p>
<h3><span id="1-2-mq-you-na-xie">1.2 MQ有哪些</span><a href="#1-2-mq-you-na-xie" class="header-anchor">.</a></h3><p>当今市面上有很多主流的消息中间件，如老牌的<code>ActiveMQ</code>、<code>RabbitMQ</code>，炙手可热的<code>Kafka</code>，阿里巴巴自主开发<code>RocketMQ</code>等。</p>
<h3><span id="1-3-bu-tong-mq-te-dian">1.3 不同MQ特点</span><a href="#1-3-bu-tong-mq-te-dian" class="header-anchor">.</a></h3><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 1.ActiveMQ</span>
<span class="token attr-name">    ActiveMQ</span> <span class="token attr-value">是Apache出品，最流行的，能力强劲的开源消息总线。它是一个完全支持JMS规范的的消息中间件。丰富的API,多种集群架构模式让ActiveMQ在业界成为老牌的消息中间件,在中小型企业颇受欢迎!</span>
<span class="token attr-name">        JMS</span><span class="token punctuation">:</span><span class="token attr-value">Java消息服务（Java Message Service）应用程序接口    </span>
<span class="token comment" spellcheck="true"># 2.Kafka</span>
    Kafka是LinkedIn开源的分布式发布-订阅消息系统，目前归属于Apache顶级项目。Kafka主要特点是基于Pull的模式来处理消息消费，追求高吞吐量，一开始的目的就是用于日志收集和传输。0.8版本开始支持复制，不支持事务，对消息的重复、丢失、错误没有严格要求，
    适合产生大量数据的互联网服务的数据收集业务。

<span class="token comment" spellcheck="true"># 3.RocketMQ</span>
    RocketMQ是阿里开源的消息中间件，它是纯Java开发，具有高吞吐量、高可用性、适合大规模分布式系统应用的特点。RocketMQ思路起源于Kafka，但并不是Kafka的一个Copy，它对消息的可靠传输及事务性做了优化，目前在阿里集团被广泛应用于交易、充值、流计算、消息推送、日志流式处理、binglog分发等场景。

<span class="token comment" spellcheck="true"># 4.RabbitMQ</span>
    RabbitMQ是使用Erlang语言开发的开源消息队列系统，基于AMQP协议来实现。AMQP的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全。AMQP协议更多用在企业系统内对数据一致性、稳定性和可靠性要求很高的场景，对性能和吞吐量的要求还在其次。
<span class="token attr-name">        AMQP</span><span class="token punctuation">:</span><span class="token attr-value">高级消息队列协议(Advanced Message Queuing Protocol) -- 一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同的开发语言等条件的限制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>RabbitMQ比Kafka可靠，Kafka更适合IO高吞吐的处理，一般应用在大数据日志处理或对实时性（少量延迟），可靠性（少量丢数据）要求稍低的场景使用，比如ELK日志收集。</p>
<ul>
<li>数据可靠性==&gt; RabbitMQ</li>
<li>数据高吞吐==&gt; Kafka</li>
</ul>
</blockquote>
<h2><span id="2-rabbitmq-de-yin-yan">2.RabbitMQ 的引言</span><a href="#2-rabbitmq-de-yin-yan" class="header-anchor">.</a></h2><h3><span id="2-1-rabbitmq">2.1 RabbitMQ</span><a href="#2-1-rabbitmq" class="header-anchor">.</a></h3><blockquote>
<p>基于<code>AMQP</code>协议，erlang语言开发，是部署最广泛的开源消息中间件,是最受欢迎的开源消息中间件之一。</p>
</blockquote>
<p><code>官网</code>: <a href="https://www.rabbitmq.com/" target="_blank" rel="noopener">https://www.rabbitmq.com/</a></p>
<p><code>官方教程</code>: <a href="https://www.rabbitmq.com/#getstarted" target="_blank" rel="noopener">https://www.rabbitmq.com/#getstarted</a></p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"> # AMQP 协议</span>
<span class="token attr-name"> `AMQP（advanced</span> <span class="token attr-value">message queuing protocol）`在2003年时被提出，最早用于解决金融领不同平台之间的消息传递交互问题。顾名思义，AMQP是一种协议，更准确的说是一种`binary wire-level protocol`（链接协议）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式。这使得实现了AMQP的provider天然性就是跨平台的。以下是AMQP协议模型:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201216161446.png" alt="AMQP协议模型"></p>
<h3><span id="2-2-rabbitmq-de-an-zhuang">2.2 RabbitMQ 的安装</span><a href="#2-2-rabbitmq-de-an-zhuang" class="header-anchor">.</a></h3><h4><span id="2-2-1-xia-zai">2.2.1 下载</span><a href="#2-2-1-xia-zai" class="header-anchor">.</a></h4><p><code>官网下载地址</code>: <a href="https://www.rabbitmq.com/download.html" target="_blank" rel="noopener">https://www.rabbitmq.com/download.html</a></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201216224549.png" alt="下载CentOS版本"></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201216224549.png" alt></p>
<p>下载最新的RabbitMQ，在安装之前还需下载一些依赖包 ：</p>
<ul>
<li>erlang [<a href="https://github.com/rabbitmq/erlang-rpm/releases]" target="_blank" rel="noopener">https://github.com/rabbitmq/erlang-rpm/releases]</a> [RabbitMQ3.8.9对应版本erlang最少22.3]</li>
<li>socat [<a href="https://pkgs.org/download/socat]" target="_blank" rel="noopener">https://pkgs.org/download/socat]</a></li>
<li>logrotate [<a href="https://github.com/logrotate/logrotate/releases/]" target="_blank" rel="noopener">https://github.com/logrotate/logrotate/releases/]</a></li>
</ul>
<h6><span id="zhu-yi-ban-ben-dui-ying">注意：版本对应</span><a href="#zhu-yi-ban-ben-dui-ying" class="header-anchor">.</a></h6><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201216224605.png" alt="3.8.9对应版本22.3"></p>
<h4><span id="2-2-2-xia-zai-de-an-zhuang-bao">2.2.2 下载的安装包</span><a href="#2-2-2-xia-zai-de-an-zhuang-bao" class="header-anchor">.</a></h4><ul>
<li>erlang-23.1.5-1.el7.x86_64.rpm</li>
<li>socat-1.7.3.2-2.el7.x86_64.rpm</li>
<li>rabbitmq-server-3.8.9-1.el7.noarch.rpm</li>
</ul>
<h4><span id="2-2-3-an-zhuang-bu-zou">2.2.3 安装步骤</span><a href="#2-2-3-an-zhuang-bu-zou" class="header-anchor">.</a></h4><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 创建存放安装包暂存目录</span>
<span class="token attr-name">mkdir</span> <span class="token attr-value">/app</span>
<span class="token attr-name">cd</span> <span class="token attr-value">/app</span>

<span class="token comment" spellcheck="true"># 1.将安装包上传到 /app 上</span>
<span class="token comment" spellcheck="true">## 可使用xftp</span>

<span class="token comment" spellcheck="true"># 2.安装</span>
<span class="token attr-name">rpm</span> <span class="token attr-value">-ivh erlang-23.1.5-1.el7.x86_64.rpm</span>
<span class="token attr-name">rpm</span> <span class="token attr-value">-ivh socat-1.7.3.2-2.el7.x86_64.rpm</span>
<span class="token attr-name">rpm</span> <span class="token attr-value">-ivh rabbitmq-server-3.8.9-1.el7.noarch.rpm</span>

<span class="token comment" spellcheck="true"># 3.复制配置文件</span>
<span class="token comment" spellcheck="true">## cp /usr/share/doc/rabbitmq-server-3.8.9/rabbitmq.config.example /etc/rabbitmq/rabbitmq.config</span>
<span class="token comment" spellcheck="true">### 3.8.9在该目录下没有这个文件，所以去github上拷贝了一份,复制到rabbitmq.conf，文件内容在结尾</span>
<span class="token comment" spellcheck="true">### https://github.com/rabbitmq/rabbitmq-server/tree/v3.8.x/deps/rabbit/docs</span>
<span class="token attr-name">vim</span> <span class="token attr-value">/etc/rabbitmq/rabbitmq.conf</span>
<span class="token comment" spellcheck="true">### 编辑rabbitmq.conf 修改81行，取消注释</span>
<span class="token attr-name">loopback_users.guest</span><span class="token punctuation">=</span> <span class="token attr-value">false</span>

<span class="token comment" spellcheck="true"># 4.配置开机自启</span>
<span class="token attr-name">chkconfig</span> <span class="token attr-value">rabbitmq-server on</span>

<span class="token comment" spellcheck="true"># 5.开启rabbitmq</span>
<span class="token attr-name">systemctl</span> <span class="token attr-value">start rabbitmq-server</span>
<span class="token comment" spellcheck="true"># 查看状态</span>
<span class="token attr-name">systemctl</span> <span class="token attr-value">status rabbitmq-server</span>

<span class="token comment" spellcheck="true"># 6.执行如下命令,启动rabbitmq中的插件管理</span>
<span class="token comment" spellcheck="true">## 192.168.111.11:15672访问图形化管理界面</span>
<span class="token attr-name">rabbitmq-plugins</span> <span class="token attr-value">enable rabbitmq_management</span>

<span class="token comment" spellcheck="true"># 7.如果访问不到：需要关闭防火墙</span>
<span class="token attr-name">systemctl</span> <span class="token attr-value">stop firewalld</span>
<span class="token comment" spellcheck="true">## 关闭开机自启</span>
<span class="token attr-name">systemctl</span> <span class="token attr-value">disable firewalld</span>

<span class="token comment" spellcheck="true"># 8.访问图形化界面</span>
<span class="token attr-name">192.168.111.11</span><span class="token punctuation">:</span><span class="token attr-value">15672</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="2-2-4-deng-lu">2.2.4登录</span><a href="#2-2-4-deng-lu" class="header-anchor">.</a></h4><p>username：guest</p>
<p>password：guest</p>
<blockquote>
<p>但是登录失败：<code>User can only log in via localhost</code></p>
<p>原因：<code>rabbitmq从3.3.0开始禁止使用guest/guest权限通过除localhost外的访问</code></p>
</blockquote>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 解决方法</span>
<span class="token attr-name">vim</span> <span class="token attr-value">/etc/rabbitmq/rabbitmq.conf</span>

<span class="token comment" spellcheck="true">### 编辑rabbitmq.conf 修改81行，取消注释</span>
<span class="token attr-name">loopback_users.guest</span><span class="token punctuation">=</span> <span class="token attr-value">false</span>


<span class="token comment" spellcheck="true">#### 以前的配置文件rabbitmq.config</span>
<span class="token comment" spellcheck="true"># </span>
<span class="token comment" spellcheck="true"># {loopback_users, [&lt;&lt;”guest”>>]}  改为   {loopback_users, []}，</span>
<span class="token comment" spellcheck="true"># </span>
<span class="token comment" spellcheck="true">#### </span>

<span class="token comment" spellcheck="true">### 然后重启服务</span>
<span class="token attr-name">systemctl</span> <span class="token attr-value">restart rabbitmq-server</span>

<span class="token comment" spellcheck="true">### 再次访问，并登录</span>
<span class="token attr-name">192.168.111.11</span><span class="token punctuation">:</span><span class="token attr-value">15672</span>
<span class="token attr-name">username</span><span class="token punctuation">:</span> <span class="token attr-value">guest</span>
<span class="token attr-name">password</span><span class="token punctuation">:</span> <span class="token attr-value">guest</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217120042.png" alt></p>
<h4><span id="2-2-5-quan-xian-pei-zhi-ming-ling-yong-hu-biao-qian">2.2.5 权限配置命令，用户标签</span><a href="#2-2-5-quan-xian-pei-zhi-ming-ling-yong-hu-biao-qian" class="header-anchor">.</a></h4><p><strong>用户权限命令</strong></p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">rabbitmqctl</span> <span class="token attr-value">list_users  // 查看当前所有用户</span>
<span class="token attr-name">rabbitmqctl</span> <span class="token attr-value">list_user_permissions guest //查看默认guest用户的权限</span>
<span class="token attr-name">rabbitmqctl</span> <span class="token attr-value">delete_user guest // 由于RabbitMQ默认的账号用户名和密码都是guest。为了安全起见, 先删掉默认用户</span>
<span class="token attr-name">rabbitmqctl</span> <span class="token attr-value">add_user username password //添加新用户</span>
<span class="token attr-name">rabbitmqctl</span> <span class="token attr-value">set_user_tags username administrator // 设置用户tag</span>
<span class="token attr-name">rabbitmqctl</span> <span class="token attr-value">set_permissions -p / username ".*" ".*" ".*" //赋予用户默认vhost的全部操作权限</span>
<span class="token attr-name">rabbitmqctl</span> <span class="token attr-value">list_user_permissions username // 查看用户的权限</span>

<span class="token comment" spellcheck="true"># 其他命令</span>
<span class="token attr-name">https</span><span class="token punctuation">:</span><span class="token attr-value">//www.rabbitmq.com/rabbitmqctl.8.html</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>用户标签</strong>：</p>
<blockquote>
<p>这些标签，由上到下，上面的权限包括下面的，因此，选用标签只需一个即可</p>
</blockquote>
<ul>
<li><p><strong><code>administrator</code></strong>：<strong>用户可以执行监视所能做的一切，管理用户、vhost和权限，关闭其他用户的连接，以及管理所有vhost的策略和参数。</strong></p>
<ul>
<li>创建和删除虚拟主机</li>
<li>查看、创建和删除用户</li>
<li>查看、创建和删除权限</li>
<li>关闭其他用户的连接</li>
</ul>
</li>
<li><p><code>monitoring</code>：用户可以访问管理插件并查看所有连接和通道以及节点相关信息</p>
<ul>
<li>列出所有虚拟主机，包括无法使用消息传递协议访问的虚拟主机</li>
<li></li>
<li>查看节点级数据，如内存使用和集群</li>
<li>查看所有虚拟主机的真实全局统计信息</li>
</ul>
</li>
<li><p><code>policymaker</code>：用户可以访问管理插件并管理他们有权访问的vhost的策略和参数。</p>
<ul>
<li>查看、创建和删除可通过AMQP登录的虚拟主机的策略和参数</li>
</ul>
</li>
<li><p><code>management</code>：用户可以访问管理插件</p>
<ul>
<li>列出他们可以通过AMQP登录的虚拟主机</li>
<li>查看其虚拟主机中的所有队列、交换和绑定</li>
<li>查看并关闭自己的频道和连接</li>
<li>查看涵盖其所有虚拟主机的“全局”统计信息，包括其中其他用户的活动</li>
</ul>
</li>
<li><p><code>impersonator</code>（不了解）</p>
</li>
<li><p><code>none</code>：无法访问管理插件</p>
</li>
</ul>
<h2><span id="3-rabiitmq-pei-zhi">3. RabiitMQ 配置</span><a href="#3-rabiitmq-pei-zhi" class="header-anchor">.</a></h2><h3><span id="3-1rabbitmq-guan-li-ming-ling-xing">3.1RabbitMQ 管理命令行</span><a href="#3-1rabbitmq-guan-li-ming-ling-xing" class="header-anchor">.</a></h3><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 1.服务启动相关</span>
<span class="token attr-name">    systemctl</span> <span class="token attr-value">start|restart|stop|status rabbitmq-server</span>

<span class="token comment" spellcheck="true"># 2.管理命令行  用来在不使用web管理界面情况下命令操作RabbitMQ</span>
<span class="token attr-name">    rabbitmqctl</span> <span class="token attr-value"> help  可以查看更多命令</span>

<span class="token comment" spellcheck="true"># 3.插件管理命令行</span>
<span class="token attr-name">    rabbitmq-plugins</span> <span class="token attr-value">enable|list|disable </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3><span id="3-2-web-guan-li-jie-mian-jie-shao">3.2 web管理界面介绍</span><a href="#3-2-web-guan-li-jie-mian-jie-shao" class="header-anchor">.</a></h3><h4><span id="3-2-1-overview-gai-lan">3.2.1 overview概览</span><a href="#3-2-1-overview-gai-lan" class="header-anchor">.</a></h4><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217124410.png" alt></p>
<ul>
<li><code>connections：无论生产者还是消费者，都需要与RabbitMQ建立连接后才可以完成消息的生产和消费，在这里可以查看连接情况</code></li>
<li><code>channels：通道，建立连接后，会形成通道，消息的投递获取依赖通道。</code></li>
<li><code>Exchanges：交换机，用来实现消息的路由</code></li>
<li><code>Queues：队列，即消息队列，消息存放在队列中，等待消费，消费后被移除队列。</code></li>
</ul>
<h4><span id="3-2-2-admin-yong-hu-he-xu-ni-zhu-ji-guan-li">3.2.2 Admin用户和虚拟主机管理</span><a href="#3-2-2-admin-yong-hu-he-xu-ni-zhu-ji-guan-li" class="header-anchor">.</a></h4><h5><span id="1-tian-jia-yong-hu">1. 添加用户</span><a href="#1-tian-jia-yong-hu" class="header-anchor">.</a></h5><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217124550.png" alt></p>
<p>上面的Tags选项，其实是指定用户的角色，可选的有以下几个：</p>
<ul>
<li><p><code>超级管理员(administrator)</code></p>
<p>可登陆管理控制台，可查看所有的信息，并且可以对用户，策略(policy)进行操作。</p>
</li>
<li><p><code>监控者(monitoring)</code></p>
<p>可登陆管理控制台，同时可以查看rabbitmq节点的相关信息(进程数，内存使用情况，磁盘使用情况等)</p>
</li>
<li><p><code>策略制定者(policymaker)</code></p>
<p>可登陆管理控制台, 同时可以对policy进行管理。但无法查看节点的相关信息(上图红框标识的部分)。</p>
</li>
<li><p><code>普通管理者(management)</code></p>
<p>仅可登陆管理控制台，无法看到节点信息，也无法对策略进行管理。</p>
</li>
<li><p><code>其他</code></p>
<p>无法登陆管理控制台，通常就是普通的生产者和消费者。</p>
</li>
</ul>
<h5><span id="2-chuang-jian-xu-ni-zhu-ji">2. 创建虚拟主机</span><a href="#2-chuang-jian-xu-ni-zhu-ji" class="header-anchor">.</a></h5><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 虚拟主机</span>
<span class="token attr-name">    为了让各个用户可以互不干扰的工作，RabbitMQ添加了虚拟主机（Virtual</span> <span class="token attr-value">Hosts）的概念。其实就是一个独立的访问路径，不同用户使用不同路径，各自有自己的队列、交换机，互相不会影响。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p> <img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217124848.png" alt></p>
<h5><span id="3-bang-ding-xu-ni-zhu-ji-he-yong-hu">3. 绑定虚拟主机和用户</span><a href="#3-bang-ding-xu-ni-zhu-ji-he-yong-hu" class="header-anchor">.</a></h5><p>创建好虚拟主机，我们还要给用户添加访问权限：</p>
<p>点击添加好的虚拟主机：</p>
<p> <img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217124901.png" alt></p>
<p>进入虚拟机设置界面:</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217124905.png" alt></p>
<hr>
<h2><span id="4-rabbitmq-de-di-yi-ge-cheng-xu">4.RabbitMQ 的第一个程序</span><a href="#4-rabbitmq-de-di-yi-ge-cheng-xu" class="header-anchor">.</a></h2><h3><span id="4-0-amqp-xie-yi-de-hui-gu">4.0 AMQP协议的回顾</span><a href="#4-0-amqp-xie-yi-de-hui-gu" class="header-anchor">.</a></h3><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217124915.png" alt></p>
<h3><span id="4-1-rabbitmq-zhi-chi-de-xiao-xi-mo-xing">4.1 RabbitMQ支持的消息模型</span><a href="#4-1-rabbitmq-zhi-chi-de-xiao-xi-mo-xing" class="header-anchor">.</a></h3><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217125715.png" alt></p>
<h3><span id="4-2-chuang-jian-yi-ge-pu-tong-maven-xiang-mu">4.2 创建一个普通maven项目</span><a href="#4-2-chuang-jian-yi-ge-pu-tong-maven-xiang-mu" class="header-anchor">.</a></h3><p>过程略</p>
<h4><span id="bian-xie-rabbitmq-gong-ju-lei">编写RabbitMQ工具类</span><a href="#bian-xie-rabbitmq-gong-ju-lei" class="header-anchor">.</a></h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span>  ConnectionFactory connectionFactory<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.111.11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/java"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"liuyou"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"lmk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Connection <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>Connection connection<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> TimeoutException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3><span id="4-3-yin-ru-yi-lai">4.3 引入依赖</span><a href="#4-3-yin-ru-yi-lai" class="header-anchor">.</a></h3><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.rabbitmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>amqp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3><span id="4-3-di-yi-chong-mo-xing-zhi-lian">4.3 第一种模型(直连)</span><a href="#4-3-di-yi-chong-mo-xing-zhi-lian" class="header-anchor">.</a></h3><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217134821.png" alt="(P) -&gt; [|||] -&gt; (C)"></p>
<p>在上图的模型中，有以下概念：</p>
<ul>
<li>P：生产者，也就是要发送消息的程序</li>
<li>C：消费者：消息的接受者，会一直等待消息到来。</li>
<li>queue：消息队列，图中红色部分。类似一个邮箱，可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。</li>
</ul>
<h4><span id="1-kai-fa-sheng-chan-zhe">1.开发生产者</span><a href="#1-kai-fa-sheng-chan-zhe" class="header-anchor">.</a></h4><pre class="line-numbers language-java"><code class="language-java">String queue <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
String message <span class="token operator">=</span> <span class="token string">"hello,rabbitmq"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 1、连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 2、通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 3、队列</span>
<span class="token comment" spellcheck="true">// 参数1：queue 队列名</span>
<span class="token comment" spellcheck="true">// 参数2：durable 是否持久化队列</span>
<span class="token comment" spellcheck="true">// 参数3：exclusive 是否独占队列</span>
<span class="token comment" spellcheck="true">// 参数4：autoDelete 是否删除队列（在服务器不使用时）</span>
<span class="token comment" spellcheck="true">// 参数5：arguments 其他属性</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 4、消息发送</span>
<span class="token comment" spellcheck="true">// 参数1：exchange 交换名字，这里不使用("")</span>
<span class="token comment" spellcheck="true">// 参数2：routingKey 路由key --> 这里使用 队列名(因为没有交换机)</span>
<span class="token comment" spellcheck="true">// 参数3：props 额外配置</span>
<span class="token comment" spellcheck="true">// 参数4：body 要发送的消息</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span>queue<span class="token punctuation">,</span>null<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// 5、关闭连接</span>
RabbitMQUtil<span class="token punctuation">.</span><span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="2-kai-fa-xiao-fei-zhe">2.开发消费者</span><a href="#2-kai-fa-xiao-fei-zhe" class="header-anchor">.</a></h4><pre class="line-numbers language-java"><code class="language-java">String queue <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 3.队列 （避免队列不存在）</span>
<span class="token comment" spellcheck="true">// 参数1：队列名  参数2：是否持久化  参数3：是否独占   参数4：是否自动删除  参数5：其他属性</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 4.消费信息</span>
<span class="token comment" spellcheck="true">// 参数1：队列名  参数2：autoAck是否自动确认  参数3：consumer实现对象（包含消息处理细节）</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p><code>autoAck</code> ：确认消息（队列消息会被清除），如果为<code>true</code>，自动确认(不管信息是否消费，取走的消息可能未被消费)；<code>false</code>，手动确认，一般待数据处理后执行 <code>channel.basicAck(envelope.getDeliveryTag(),false);</code> 手动确认，如果未手动确认，这些消息会保留在队列里</p>
</blockquote>
<blockquote>
<p><code>autodelete</code>队列自动删除的条件，有消费者订阅本队列，然后所有消费者都解除订阅此队列，autoDelete=true时，此队列会自动删除，即使此队列中还有消息。</p>
</blockquote>
<h4><span id="3-ce-shi">3.测试</span><a href="#3-ce-shi" class="header-anchor">.</a></h4><p>①运行<code>Producer</code></p>
<p><code>192.168.111.11:15672</code>查看队列信息</p>
<p>队列hello中，有3个刚生成的消息</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217171451.png" alt></p>
<p>②运行<code>Consumer</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217171753.png" alt="消费了三个消息"></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217171750.png" alt="队列消息被全部消费"></p>
<h5><span id="ce-shi-jie-lun">测试结论</span><a href="#ce-shi-jie-lun" class="header-anchor">.</a></h5><ul>
<li>消费者取出消息，就马上进行了确认（<code>autoAck=true</code>），队列信息就清空<ul>
<li>存在问题：可能这些取走的消息没有消费完（消费者宕机），造成消息浪费</li>
<li>解决办法：<code>autoAck=false</code>，采用手动确认</li>
</ul>
</li>
</ul>
<h3><span id="4-4-di-er-chong-mo-xing-work-quene">4.4 第二种模型(work quene)</span><a href="#4-4-di-er-chong-mo-xing-work-quene" class="header-anchor">.</a></h3><p><code>Work queues</code>，也被称为（<code>Task queues</code>），任务模型。当消息处理比较耗时的时候，可能生产消息的速度会远远大于消息的消费速度。长此以往，消息就会堆积越来越多，无法及时处理。此时就可以使用work 模型：<strong>让多个消费者绑定到一个队列，共同消费队列中的消息</strong>。队列中的消息一旦消费，就会消失，因此任务是不会被重复执行的。</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135003.png" alt="一个生产者，一个队列，多个消费者"></p>
<h4><span id="qing-kuang-yi-liang-xiao-fei-zhe-chu-li-neng-li-jun-heng">情况一：两消费者处理能力均衡</span><a href="#qing-kuang-yi-liang-xiao-fei-zhe-chu-li-neng-li-jun-heng" class="header-anchor">.</a></h4><p>角色：</p>
<ul>
<li>P：生产者：任务的发布者</li>
<li>C1：消费者-1，领取任务并且完成任务</li>
<li>C2：消费者-2：领取任务并且完成任务</li>
</ul>
<h5><span id="1-kai-fa-sheng-chan-zhe">1. 开发生产者</span><a href="#1-kai-fa-sheng-chan-zhe" class="header-anchor">.</a></h5><h6><span id="p"><code>P</code></span><a href="#p" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String queue <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>
String message <span class="token operator">=</span> <span class="token string">"测试workqueue,一生成者，一队列，多个消费者"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.队列</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.发送消息</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> queue<span class="token punctuation">,</span>null<span class="token punctuation">,</span><span class="token punctuation">(</span>message <span class="token operator">+</span> <span class="token string">" 消息-"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//5.关闭连接</span>
RabbitMQUtil<span class="token punctuation">.</span><span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="2-kai-fa-xiao-fei-zhe">2.开发消费者</span><a href="#2-kai-fa-xiao-fei-zhe" class="header-anchor">.</a></h5><h6><span id="c1"><code>C1</code></span><a href="#c1" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String queue <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.队列 （避免队列不存在）</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.消费</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者1 == "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前 deliveryTag : "</span> <span class="token operator">+</span> envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 手动确认</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6><span id="c2"><code>C2</code></span><a href="#c2" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String queue <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.队列 （避免队列不存在）</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.消费</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者2 == "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前 deliveryTag : "</span> <span class="token operator">+</span> envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 手动确认</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="3-ce-shi">3.测试</span><a href="#3-ce-shi" class="header-anchor">.</a></h5><p>①运行<code>C1</code></p>
<p>②运行<code>C2</code></p>
<p>③运行<code>P</code></p>
<p><code>Consumer1</code>消费全是偶数位的消息</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155425.png" alt></p>
<p><code>Consumer2</code>消费全是奇数位的消息</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155419.png" alt></p>
<h6><span id="ce-shi-jie-lun">测试结论</span><a href="#ce-shi-jie-lun" class="header-anchor">.</a></h6><ul>
<li>两个消费者，平均交替消费队列里的消息（<strong>提前分配</strong>，不管谁处理快都是平均的）<ul>
<li>存在问题：如果两消费者，消费能力不均？<ul>
<li>能否使用能者多劳（不平均分配，按需分配或按处理能力分配）</li>
</ul>
</li>
<li>造成原理：<ul>
<li>默认情况下，<code>RabbitMQ</code>将按顺序将每个消息发送给下一个使用者。平均而言，每个消费者都会收到相同数量的消息。这种分发消息的方式称为<code>循环</code></li>
</ul>
</li>
<li>解决办法：<ul>
<li>由于会提前分配好全部消息给不同消费者，我们需要① <strong>设置每个通道一次只能获取一个消息</strong>（每个消费者一次只能获取一个，获取能力强的，获取的消息就多）②<strong>关闭自动确认，使用手动确认</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4><span id="qing-kuang-er-liang-xiao-fei-zhe-chu-li-neng-li-bu-jun">情况二：两消费者处理能力不均</span><a href="#qing-kuang-er-liang-xiao-fei-zhe-chu-li-neng-li-bu-jun" class="header-anchor">.</a></h4><blockquote>
<p>实现效果：能者多劳</p>
</blockquote>
<p>角色：</p>
<ul>
<li>P：生产者：任务的发布者</li>
<li>C1：消费者-1，领取任务并且完成任务，处理快</li>
<li>C2：消费者-2：领取任务并且完成任务，处理慢</li>
</ul>
<p><code>P</code>我们不做修改</p>
<p><code>C</code> 中添加 <code>channel.basicQos(1);</code></p>
<h5><span id="c1"><code>C1</code></span><a href="#c1" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java">String queue <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//一次只接受一条未确认的消息</span>

<span class="token comment" spellcheck="true">//3.队列 （避免队列不存在）</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.消费</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 处理能力快 1秒处理一个</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者1 == "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 手动确认</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="c2"><code>C2</code></span><a href="#c2" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java">String queue <span class="token operator">=</span> <span class="token string">"workqueue"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//一次只接受一条未确认的消息</span>

<span class="token comment" spellcheck="true">//3.队列 （避免队列不存在）</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.消费</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 处理能力慢 5秒处理一个</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者2 == "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"当前 deliveryTag : "</span> <span class="token operator">+</span> envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 手动确认</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="ce-shi-tong-qing-kuang-yi">测试（同情况一）</span><a href="#ce-shi-tong-qing-kuang-yi" class="header-anchor">.</a></h5><p><strong>测试结果</strong></p>
<p><code>C1</code>处理快，处理了16个</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155409.png" alt="C1处理快，处理了16个"></p>
<p><code>C2</code>处理慢，只处理了4个</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155402.png" alt="C2处理慢，只处理了4个"></p>
<h3><span id="4-5-di-san-chong-mo-xing-fanout">4.5 第三种模型(fanout)</span><a href="#4-5-di-san-chong-mo-xing-fanout" class="header-anchor">.</a></h3><p><code>fanout 扇出 也称为广播</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135056.png" alt="img"></p>
<p>在广播模式下，消息发送流程是这样的：</p>
<ul>
<li>可以有多个消费者</li>
<li>每个<strong>消费者有自己的queue</strong>（队列）</li>
<li>每个<strong>队列都要绑定到Exchange</strong>（交换机）</li>
<li><strong>生产者发送的消息，只能发送到交换机</strong>，交换机来决定要发给哪个队列，生产者无法决定。</li>
<li>交换机把消息发送给绑定过的所有队列</li>
<li>队列的消费者都能拿到消息。<mark>实现一条消息被多个消费者消费</mark></li>
</ul>
<h4><span id="1-kai-fa-xiao-fei-zhe">1.开发消费者</span><a href="#1-kai-fa-xiao-fei-zhe" class="header-anchor">.</a></h4><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">;</span>
String message <span class="token operator">=</span> <span class="token string">"测试fanout 广播: 1个消息--> 发给绑定交换机fanout的消费者"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机</span>
<span class="token comment" spellcheck="true">// 参数1：交换机名字  参数2：交换机类型  参数3：是否持久化  参数4：是否自动删除  参数5：其他</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span><span class="token string">"fanout"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.发送消息</span>
<span class="token comment" spellcheck="true">// 参数1：exchange 交换机名</span>
<span class="token comment" spellcheck="true">// 参数2：routingKey 路由key（广播类型永不上）</span>
<span class="token comment" spellcheck="true">// 参数3：其他</span>
<span class="token comment" spellcheck="true">// 参数4：要发送的消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span>null<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.关闭连接</span>
RabbitMQUtil<span class="token punctuation">.</span><span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="2-kai-fa-sheng-chan-zhe">2.开发生产者</span><a href="#2-kai-fa-sheng-chan-zhe" class="header-anchor">.</a></h4><h5><span id="c1"><code>C1</code></span><a href="#c1" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机 （避免交换机不存在--需保证与生产者端条件一致）</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span><span class="token string">"fanout"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.临时队列（临时使用，用完自动删除）</span>
String queue <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.绑定队列</span>
<span class="token comment" spellcheck="true">// 参数1：队列名  参数2：交换机名  参数3：路由key  参数4：其他</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//6.接收消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者1 接收fanout消息 ："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="c2"><code>C2</code></span><a href="#c2" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机 （避免交换机不存在--需保证与生产者端条件一致）</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span><span class="token string">"fanout"</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">,</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.临时队列（临时使用，用完自动删除）</span>
String queue <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.绑定队列</span>
<span class="token comment" spellcheck="true">// 参数1：队列名  参数2：交换机名  参数3：路由key  参数4：其他</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//6.接收消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者2 接收fanout消息 ："</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="3-ce-shi">3.测试</span><a href="#3-ce-shi" class="header-anchor">.</a></h4><h5><span id="yun-xing-suo-you-xiao-fei-zhe">①运行所有消费者</span><a href="#yun-xing-suo-you-xiao-fei-zhe" class="header-anchor">.</a></h5><h5><span id="yun-xing-sheng-chan-zhe">②运行生产者</span><a href="#yun-xing-sheng-chan-zhe" class="header-anchor">.</a></h5><h5><span id="ce-shi-jie-guo">测试结果</span><a href="#ce-shi-jie-guo" class="header-anchor">.</a></h5><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155344.png" alt>)<img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155347.png" alt></p>
<h3><span id="4-6-di-si-chong-mo-xing-routing">4.6 第四种模型(Routing)</span><a href="#4-6-di-si-chong-mo-xing-routing" class="header-anchor">.</a></h3><h4><span id="4-6-1-routing-zhi-ding-yue-mo-xing-direct-zhi-lian">4.6.1 Routing 之订阅模型-Direct(直连)</span><a href="#4-6-1-routing-zhi-ding-yue-mo-xing-direct-zhi-lian" class="header-anchor">.</a></h4><p><code>在Fanout模式中，一条消息，会被所有订阅的队列都消费。但是，在某些场景下，我们希望不同的消息被不同的队列消费。这时就要用到Direct类型的Exchange。</code></p>
<p> 在Direct模型下：</p>
<ul>
<li>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由key）</li>
<li>消息的发送方在 向 Exchange发送消息时，也必须指定消息的 <code>RoutingKey</code>。</li>
<li>Exchange不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</li>
</ul>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135141.png" alt="img"></p>
<p>图解：</p>
<ul>
<li><code>P</code>：生产者，向<code>Exchange</code>发送消息，发送消息时，会指定一个routing key。</li>
<li><code>X</code>：<code>Exchange</code>（交换机），接收生产者的消息，然后把消息递交给 与<code>routing key</code>完全匹配的队列</li>
<li><code>C1</code>：消费者，其所在队列指定了需要<code>routing key</code> 为 error 的消息</li>
<li><code>C2</code>：消费者，其所在队列指定了需要<code>routing key</code> 为 info、error、warning 的消息</li>
</ul>
<h5><span id="1-kai-fa-sheng-chan-zhe">1.开发生产者</span><a href="#1-kai-fa-sheng-chan-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"direct"</span><span class="token punctuation">;</span>
String routingKey <span class="token operator">=</span> <span class="token string">"info"</span><span class="token punctuation">;</span>
String message <span class="token operator">=</span> <span class="token string">"测试 routing之direct：在fanout基础上，加上routingkey，消息绑定该key，只有绑定该key的消费者才能获取该数据"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机 direct 直连</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> BuiltinExchangeType<span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.发送消息，绑定routingKey，只有绑定该key的消费者才能获取消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> null<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.关闭连接</span>
RabbitMQUtil<span class="token punctuation">.</span><span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="2-kai-fa-xiao-fei-zhe">2.开发消费者</span><a href="#2-kai-fa-xiao-fei-zhe" class="header-anchor">.</a></h5><h6><span id="c1"><code>C1</code></span><a href="#c1" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"direct"</span><span class="token punctuation">;</span>
String routingKey <span class="token operator">=</span> <span class="token string">"info"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> BuiltinExchangeType<span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.临时队列</span>
String queue <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.绑定队列 == 绑定 info</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//6.消费消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者1 == "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6><span id="c2"><code>C2</code></span><a href="#c2" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"direct"</span><span class="token punctuation">;</span>
String routingKey <span class="token operator">=</span> <span class="token string">"debug"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> BuiltinExchangeType<span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.临时队列</span>
String queue <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.绑定队列 == 绑定 debug</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//6.消费消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者2 == "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6><span id="c3"><code>C3</code></span><a href="#c3" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"direct"</span><span class="token punctuation">;</span>
String routingKey1 <span class="token operator">=</span> <span class="token string">"error"</span><span class="token punctuation">;</span>
String routingKey2 <span class="token operator">=</span> <span class="token string">"info"</span><span class="token punctuation">;</span>
String routingKey3 <span class="token operator">=</span> <span class="token string">"debug"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> BuiltinExchangeType<span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.临时队列</span>
String queue <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.绑定队列 == 绑定 info，debug，error</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey1<span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey2<span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//6.消费消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者3 == "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="3-ce-shi">3.测试</span><a href="#3-ce-shi" class="header-anchor">.</a></h5><h6><span id="yun-xing-suo-you-xiao-fei-zhe">①运行所有消费者</span><a href="#yun-xing-suo-you-xiao-fei-zhe" class="header-anchor">.</a></h6><ul>
<li><code>C1</code>（<code>info</code>）</li>
<li><code>C2</code>（<code>debug</code>）</li>
<li><code>C3</code>（<code>info、debug、error</code>）</li>
</ul>
<h6><span id="yun-xing-sheng-chan-zhe">②运行生产者</span><a href="#yun-xing-sheng-chan-zhe" class="header-anchor">.</a></h6><ul>
<li>消息（<code>info</code>）</li>
</ul>
<h6><span id="yun-xing-jie-guo">③运行结果</span><a href="#yun-xing-jie-guo" class="header-anchor">.</a></h6><p><code>C1</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155249.png" alt></p>
<p><code>C2</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155246.png" alt></p>
<p><code>C3</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155243.png" alt></p>
<h4><span id="4-6-2-routing-zhi-ding-yue-mo-xing-topic">4.6.2 Routing 之订阅模型-Topic</span><a href="#4-6-2-routing-zhi-ding-yue-mo-xing-topic" class="header-anchor">.</a></h4><p><code>Topic</code>类型的<code>Exchange</code>与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候使用通配符！这种模型<code>Routingkey</code> 一般都是由一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135322.png" alt="img"></p>
<pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> 通配符</span>
<span class="token code keyword">    * (star) can substitute for exactly one word.    匹配不多不少恰好1个词</span>
<span class="token code keyword">    # (hash) can substitute for zero or more words.  匹配零个或多个词</span>
<span class="token title important"><span class="token punctuation">#</span> 如:</span>
<span class="token code keyword">    audit.#    匹配audit.irs.corporate或者 audit.irs 等</span>
<span class="token code keyword">    audit.*   只能匹配 audit.irs</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="1-kai-fa-sheng-chan-zhe">1.开发生产者</span><a href="#1-kai-fa-sheng-chan-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"topic"</span><span class="token punctuation">;</span>
String message <span class="token operator">=</span> <span class="token string">"测试 routing之topic，在direct基础上，消费者可以使用 通配符匹配routingKey"</span><span class="token punctuation">;</span>
String routingKey <span class="token operator">=</span> <span class="token string">"liu"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> BuiltinExchangeType<span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.发送消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> null<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.关闭连接</span>
RabbitMQUtil<span class="token punctuation">.</span><span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="2-kai-fa-xiao-fei-zhe">2.开发消费者</span><a href="#2-kai-fa-xiao-fei-zhe" class="header-anchor">.</a></h5><h6><span id="c1-cai-yong-zhi-pi-pei-yi-ge-dan-ci"><code>C1</code> 采用 * ，只匹配一个单词</span><a href="#c1-cai-yong-zhi-pi-pei-yi-ge-dan-ci" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"topic"</span><span class="token punctuation">;</span>
String routingKey <span class="token operator">=</span> <span class="token string">"*.liu.*"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> BuiltinExchangeType<span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.临时队列</span>
String queue <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.绑定队列 routingkey 采用 * ，只匹配一个单词</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//6.消费消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者1 + 采用*匹配 = "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 手动确认</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6><span id="c2-cai-yong-ke-pi-pei-ling-ge-huo-duo-ge-dan-ci"><code>C2</code> 采用 # ，可匹配零个或多个单词</span><a href="#c2-cai-yong-ke-pi-pei-ling-ge-huo-duo-ge-dan-ci" class="header-anchor">.</a></h6><pre class="line-numbers language-java"><code class="language-java">String exchange <span class="token operator">=</span> <span class="token string">"topic"</span><span class="token punctuation">;</span>
String routingKey <span class="token operator">=</span> <span class="token string">"rabbit.#"</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//1.连接</span>
Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//2.通道</span>
Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//3.交换机</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> BuiltinExchangeType<span class="token punctuation">.</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//4.临时队列</span>
String queue <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//5.绑定队列 routingkey 采用 # ，可匹配零个或多个单词</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//6.消费消息</span>
channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DefaultConsumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDelivery</span><span class="token punctuation">(</span>String consumerTag<span class="token punctuation">,</span> Envelope envelope<span class="token punctuation">,</span> AMQP<span class="token punctuation">.</span>BasicProperties properties<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者2 + 采用#匹配 = "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>envelope<span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 手动确认</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="3-ce-shi">3.测试</span><a href="#3-ce-shi" class="header-anchor">.</a></h5><h6><span id="yun-xing-suo-you-xiao-fei-zhe">①运行所有消费者</span><a href="#yun-xing-suo-you-xiao-fei-zhe" class="header-anchor">.</a></h6><ul>
<li><code>C1</code>(<code>*.liu.*</code>)</li>
<li><code>C2</code>(<code>rabbit.#</code>)</li>
</ul>
<h6><span id="yun-xing-sheng-chan-zhe">②运行生产者</span><a href="#yun-xing-sheng-chan-zhe" class="header-anchor">.</a></h6><ul>
<li><code>P</code>(<code>rabbit.liu.you</code>)</li>
</ul>
<h6><span id="yun-xing-jie-guo">③运行结果</span><a href="#yun-xing-jie-guo" class="header-anchor">.</a></h6><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155230.png" alt></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155226.png" alt></p>
<h3><span id="4-7-di-wu-chong-mo-xing-rpc">4.7 第五种模型 (RPC)</span><a href="#4-7-di-wu-chong-mo-xing-rpc" class="header-anchor">.</a></h3><p><code>在第二个教程中，我们学习了如何使用工作队列在多个工作人员之间分配耗时的任务。
但是如果我们需要在远程计算机上运行一个函数并等待结果呢？好吧，那是另一回事了。这种模式通常称为远程过程调用或RPC。在本教程中，我们将使用RabbitMQ构建一个RPC系统：一个客户端和一个可伸缩的RPC服务器。由于我们没有任何值得分发的耗时任务，我们将创建一个返回Fibonacci数的虚拟RPC服务。</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135405.png" alt="img"></p>
<p>图解：</p>
<ul>
<li><code>C</code>：客户端，使用远程调用的那一方</li>
<li><code>S</code>：服务端，远程调用服务提供方</li>
<li><code>Request</code>：请求（携带<code>correlation_id</code>和 <code>用于回调临时队列名</code>）<ul>
<li><code>correlation_id</code>：该id是确认标识，它会跟着回调响应传回客户端，客户端根据回调相关id和本地id进行对比，相等：取出</li>
</ul>
</li>
<li><code>Reply</code>：回调（携带 <code>correlation_id</code>和 <code>远程方法返回值</code>）</li>
</ul>
<h4><span id="0-da-jian-huan-jing">0.搭建环境</span><a href="#0-da-jian-huan-jing" class="header-anchor">.</a></h4><h5><span id="chuang-jian-liang-ge-mo-kuai-rpcclient-he-rpcserver">①创建两个模块：<code>RPCClient</code> 和 <code>RPCServer</code></span><a href="#chuang-jian-liang-ge-mo-kuai-rpcclient-he-rpcserver" class="header-anchor">.</a></h5><h5><span id="yi-lai-yin-ru">②依赖引入</span><a href="#yi-lai-yin-ru" class="header-anchor">.</a></h5><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.rabbitmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>amqp-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="liang-mo-kuai-du-bian-xie-xiang-tong-de-rabbitmqutil-gong-ju-lei">③两模块都编写相同的<code>RabbitMQUtil</code>工具类</span><a href="#liang-mo-kuai-du-bian-xie-xiang-tong-de-rabbitmqutil-gong-ju-lei" class="header-anchor">.</a></h5><blockquote>
<p>该工具类 采用 虚拟主机为 <code>/rpc</code></p>
</blockquote>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQUtil</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span>  ConnectionFactory connectionFactory<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        connectionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span><span class="token string">"192.168.111.11"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span><span class="token number">5672</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setVirtualHost</span><span class="token punctuation">(</span><span class="token string">"/rpc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">"liuyou"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        connectionFactory<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">"lmk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Connection <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> connectionFactory<span class="token punctuation">.</span><span class="token function">newConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>Connection connection<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> TimeoutException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="1-kai-fa-fu-wu-duan">1.开发服务端</span><a href="#1-kai-fa-fu-wu-duan" class="header-anchor">.</a></h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCServer_f</span> <span class="token punctuation">{</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 运行rpc server</span>
        <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 请求队列名</span>
        String requestQueue <span class="token operator">=</span> <span class="token string">"rpc_queue_req"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//1.连接</span>
        Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//2.通道</span>
        Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        channel<span class="token punctuation">.</span><span class="token function">basicQos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//3.队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>requestQueue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//4.清空队列</span>
        channel<span class="token punctuation">.</span><span class="token function">queuePurge</span><span class="token punctuation">(</span>requestQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//5.处理调用请求（consume）</span>
        Object monitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 锁</span>
        DeliverCallback deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">// 处理内容</span>
            <span class="token comment" spellcheck="true">//5.1 构建回调配置</span>
            AMQP<span class="token punctuation">.</span>BasicProperties replyProps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span>
                    <span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">correlationId</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorrelationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 使用</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"client相关id："</span> <span class="token operator">+</span> delivery<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorrelationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"client临时队列名："</span> <span class="token operator">+</span> delivery<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReplyTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//5.2 获取message</span>
            String message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//5.3 调用call() =======================</span>
            String call <span class="token operator">=</span> RPCServer_f<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// =====================================</span>

            <span class="token comment" spellcheck="true">//5.4 将调用处理结果 通过制定队列传回</span>
            channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> delivery<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReplyTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> replyProps<span class="token punctuation">,</span> call<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// RabbitMq consumer worker thread notifies the RPC server owner thread</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>monitor<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 防止多个consumer同时消费</span>
                monitor<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>requestQueue<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> consumerTag <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 被远程调用的方法 ===================
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">call</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"RPCServer的call()被远程调用，显示内容："</span> <span class="token operator">+</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="2-kai-fa-ke-hu-duan">2.开发客户端</span><a href="#2-kai-fa-ke-hu-duan" class="header-anchor">.</a></h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCClient_f</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        String message <span class="token operator">=</span> <span class="token string">"rabbit_java"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 调用</span>
        Object call <span class="token operator">=</span> <span class="token function">call</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/** 
     * 使用该方法调用 服务端的call()方法 ========================
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">call</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 请求队列名</span>
        String requestQueue <span class="token operator">=</span> <span class="token string">"rpc_queue_req"</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//1.连接</span>
        Connection connection <span class="token operator">=</span> RabbitMQUtil<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//2.通道</span>
        Channel channel <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//3.回调队列名(临时队列名)</span>
        String replyQueueName <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//4.关联id correlationId</span>
        String correlationId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//5.构建配置信息</span>
        AMQP<span class="token punctuation">.</span>BasicProperties properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span>
                <span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">correlationId</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">replyTo</span><span class="token punctuation">(</span>replyQueueName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//6.发送调用请求</span>
        channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> requestQueue<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//7.创建阻塞队列：解决多线程中数据的安全传输问题</span>
        BlockingQueue<span class="token operator">&lt;</span>String<span class="token operator">></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//8.接收回调的数据</span>
        DeliverCallback deliverCallback <span class="token operator">=</span> <span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> delivery<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorrelationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 数据入队</span>
                response<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"相关ID ："</span> <span class="token operator">+</span> delivery<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorrelationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>delivery<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 手动确认</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 消费（接收服务端传回的数据，并处理）</span>
        channel<span class="token punctuation">.</span><span class="token function">basicConsume</span><span class="token punctuation">(</span>replyQueueName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> deliverCallback<span class="token punctuation">,</span> consumerTag <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//9.从队列中获取结果</span>
        String take <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//10.关闭连接</span>
        RabbitMQUtil<span class="token punctuation">.</span><span class="token function">closeConnectionAndChannel</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> take<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="3-ce-shi">3.测试</span><a href="#3-ce-shi" class="header-anchor">.</a></h4><h5><span id="yun-xing-fu-wu-duan">①运行服务端</span><a href="#yun-xing-fu-wu-duan" class="header-anchor">.</a></h5><h5><span id="yun-xing-ke-hu-duan">②运行客户端</span><a href="#yun-xing-ke-hu-duan" class="header-anchor">.</a></h5><h5><span id="yun-xing-jie-guo">③运行结果</span><a href="#yun-xing-jie-guo" class="header-anchor">.</a></h5><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201219170710.png" alt="客户端"></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201219170727.png" alt="服务端"></p>
<h2><span id="5-springboot-zhong-shi-yong-rabbitmq">5. SpringBoot中使用RabbitMQ</span><a href="#5-springboot-zhong-shi-yong-rabbitmq" class="header-anchor">.</a></h2><h3><span id="5-0-da-jian-chu-shi-huan-jing">5.0 搭建初始环境</span><a href="#5-0-da-jian-chu-shi-huan-jing" class="header-anchor">.</a></h3><h4><span id="1-chuang-jian-springboot-xiang-mu">1.创建springboot项目</span><a href="#1-chuang-jian-springboot-xiang-mu" class="header-anchor">.</a></h4><p>过程略</p>
<h4><span id="2-yin-ru-yi-lai">2.引入依赖</span><a href="#2-yin-ru-yi-lai" class="header-anchor">.</a></h4><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="3-xiu-gai-pei-zhi-wen-jian">3.修改配置文件</span><a href="#3-xiu-gai-pei-zhi-wen-jian" class="header-anchor">.</a></h4><pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8080</span>
<span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">springboot-application</span>
<span class="token attr-name">server.servlet.context-path</span><span class="token punctuation">=</span><span class="token attr-value">/</span>

<span class="token comment" spellcheck="true"># rabbitmq</span>
<span class="token attr-name">spring.rabbitmq.host</span><span class="token punctuation">=</span><span class="token attr-value">192.168.111.11</span>
<span class="token attr-name">spring.rabbitmq.port</span><span class="token punctuation">=</span><span class="token attr-value">5672</span>
<span class="token attr-name">spring.rabbitmq.virtual-host</span><span class="token punctuation">=</span><span class="token attr-value">/springboot</span>
<span class="token attr-name">spring.rabbitmq.username</span><span class="token punctuation">=</span><span class="token attr-value">liuyou</span>
<span class="token attr-name">spring.rabbitmq.password</span><span class="token punctuation">=</span><span class="token attr-value">lmk</span>
<span class="token attr-name">spring.rabbitmq.listener.simple.prefetch</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="4-simple">4.Simple</span><a href="#4-simple" class="header-anchor">.</a></h4><h5><span id="sheng-chan-zhe">生产者</span><a href="#sheng-chan-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> RabbitTemplate rabbitTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSimple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"_hello"</span><span class="token punctuation">,</span><span class="token string">"hello,rabbitmq"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="xiao-fei-zhe">消费者</span><a href="#xiao-fei-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queuesToDeclare <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span><span class="token string">"_hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitHandler</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Consumer 接收到："</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="5-work">5.Work</span><a href="#5-work" class="header-anchor">.</a></h4><h5><span id="sheng-chan-zhe">生产者</span><a href="#sheng-chan-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"_work"</span><span class="token punctuation">,</span><span class="token string">"work-message"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="xiao-fei-zhe">消费者</span><a href="#xiao-fei-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WorkConsumer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queuesToDeclare <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span><span class="token string">"_work"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ackMode <span class="token operator">=</span> <span class="token string">"MANUAL"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">comsume1</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者1 : "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queuesToDeclare <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">(</span><span class="token string">"_work"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ackMode <span class="token operator">=</span> <span class="token string">"MANUAL"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">comsume2</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> Channel channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">long</span> deliveryTag <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费者2 : "</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="6-fanout">6.Fanout</span><a href="#6-fanout" class="header-anchor">.</a></h4><h5><span id="sheng-chan-zhe">生产者</span><a href="#sheng-chan-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFanout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"_fanout"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token string">"广播模型的测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="xiao-fei-zhe">消费者</span><a href="#xiao-fei-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FanoutConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"_fanout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume1</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C1 : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">"fanout"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"_fanout"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume2</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C2 : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="7-routing-direct">7.Routing-Direct</span><a href="#7-routing-direct" class="header-anchor">.</a></h4><h5><span id="sheng-chan-zhe">生产者</span><a href="#sheng-chan-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"_direct"</span><span class="token punctuation">,</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token string">"direct发送info类型的消息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="xiao-fei-zhe">消费者</span><a href="#xiao-fei-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DirectConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"_direct"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"info"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume1</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C1 info : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"_direct"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"debug"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume2</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C2 debug : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"_direct"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"direct"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token string">"debug"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume3</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C3 info,debug : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="8-routing-topic">8.Routing-Topic</span><a href="#8-routing-topic" class="header-anchor">.</a></h4><h5><span id="sheng-chan-zhe">生产者</span><a href="#sheng-chan-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"_topic"</span><span class="token punctuation">,</span><span class="token string">"rabbit"</span><span class="token punctuation">,</span><span class="token string">"这里只测试#的使用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="xiao-fei-zhe">消费者</span><a href="#xiao-fei-zhe" class="header-anchor">.</a></h5><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TopicConsumer</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"_topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"topic"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"rabbit.#"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume1</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C1 rabbit.# : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>bindings <span class="token operator">=</span> <span class="token annotation punctuation">@QueueBinding</span><span class="token punctuation">(</span>
            value <span class="token operator">=</span> <span class="token annotation punctuation">@Queue</span><span class="token punctuation">,</span>
            exchange <span class="token operator">=</span> <span class="token annotation punctuation">@Exchange</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"_topic"</span><span class="token punctuation">,</span>type <span class="token operator">=</span> <span class="token string">"topic"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            key <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"rabbit.*"</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume2</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"C2 rabbit.* : "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2><span id="6-mq-de-ying-yong-chang-jing">6. MQ的应用场景</span><a href="#6-mq-de-ying-yong-chang-jing" class="header-anchor">.</a></h2><h3><span id="6-1-yi-bu-chu-li">6.1 异步处理</span><a href="#6-1-yi-bu-chu-li" class="header-anchor">.</a></h3><p><code>场景说明：用户注册后，需要发注册邮件和注册短信,传统的做法有两种 1.串行的方式 2.并行的方式</code></p>
<ul>
<li><p><code>串行方式:</code> 将注册信息写入数据库后,发送注册邮件,再发送注册短信,以上三个任务全部完成后才返回给客户端。 这有一个问题是,邮件,短信并不是必须的,它只是一个通知,而这种做法让客户端等待没有必要等待的东西. </p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135626.png" alt></p>
</li>
<li><p><code>并行方式:</code>将注册信息写入数据库后,发送邮件的同时,发送短信,以上三个任务完成后,返回给客户端,并行的方式能提高处理的时间。 </p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135620.png" alt></p>
</li>
<li><p><code>消息队列:</code>假设三个业务节点分别使用50ms,串行方式使用时间150ms,并行使用时间100ms。虽然并行已经提高的处理时间,但是,前面说过,邮件和短信对我正常的使用网站没有任何影响，客户端没有必要等着其发送完成才显示注册成功,应该是写入数据库后就返回.  <code>消息队列</code>: 引入消息队列后，把发送邮件,短信不是必须的业务逻辑异步处理 </p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218154712.jpg" alt></p>
</li>
</ul>
<p>由此可以看出,引入消息队列后，用户的响应时间就等于写入数据库的时间+写入消息队列的时间(可以忽略不计),引入消息队列后处理后,响应时间是串行的3倍,是并行的2倍。</p>
<h3><span id="6-2-ying-yong-jie-ou">6.2 应用解耦</span><a href="#6-2-ying-yong-jie-ou" class="header-anchor">.</a></h3><p><code>场景：双11是购物狂节,用户下单后,订单系统需要通知库存系统,传统的做法就是订单系统调用库存系统的接口.</code></p>
<p>  <img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155013.png" alt></p>
<p>这种做法有一个缺点:</p>
<p>当库存系统出现故障时,订单就会失败。 订单系统和库存系统高耦合.  引入消息队列 </p>
<p> <img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135637.png" alt></p>
<ul>
<li><p><code>订单系统:</code>用户下单后,订单系统完成持久化处理,将消息写入消息队列,返回用户订单下单成功。</p>
</li>
<li><p><code>库存系统:</code>订阅下单的消息,获取下单消息,进行库操作。  就算库存系统出现故障,消息队列也能保证消息的可靠投递,不会导致消息丢失.</p>
</li>
</ul>
<h3><span id="6-3-liu-liang-xue-feng">6.3 流量削峰</span><a href="#6-3-liu-liang-xue-feng" class="header-anchor">.</a></h3><p> <code>场景:</code> 秒杀活动，一般会因为流量过大，导致应用挂掉,为了解决这个问题，一般在应用前端加入消息队列。  </p>
<p>  <code>作用:</code> </p>
<p>​            1.可以控制活动人数，超过此一定阀值的订单直接丢弃(我为什么秒杀一次都没有成功过呢^^) </p>
<p>​            2.可以缓解短时间的高流量压垮应用(应用程序按自己的最大处理能力获取订单) </p>
<p> <img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201217135641.png" alt></p>
<p>1.用户的请求,服务器收到之后,首先写入消息队列,加入消息队列长度超过最大值,则直接抛弃用户请求或跳转到错误页面.  </p>
<p>2.秒杀业务根据消息队列中的请求信息，再做后续处理.</p>
<h2><span id="7-rabbitmq-de-ji-qun">7. RabbitMQ的集群</span><a href="#7-rabbitmq-de-ji-qun" class="header-anchor">.</a></h2><h3><span id="7-1-ji-qun-jia-gou">7.1 集群架构</span><a href="#7-1-ji-qun-jia-gou" class="header-anchor">.</a></h3><h4><span id="7-1-1-pu-tong-ji-qun-fu-ben-ji-qun">7.1.1 普通集群(副本集群)</span><a href="#7-1-1-pu-tong-ji-qun-fu-ben-ji-qun" class="header-anchor">.</a></h4><p><code>默认情况下:RabbitMQ代理操作所需的所有数据/状态都将跨所有节点复制。这方面的一个例外是消息队列，默认情况下，消息队列位于一个节点上，尽管它们可以从所有节点看到和访问</code></p>
<h5><span id="1-jia-gou-tu">1.架构图</span><a href="#1-jia-gou-tu" class="header-anchor">.</a></h5><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218155845.png" alt></p>
<p>​    核心解决问题:  <code>当集群中某一时刻master节点宕机,可以对Quene中信息,进行备份</code></p>
<h5><span id="2-ji-qun-da-jian">2.集群搭建</span><a href="#2-ji-qun-da-jian" class="header-anchor">.</a></h5><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 0.集群规划</span>
<span class="token attr-name">    node1</span><span class="token punctuation">:</span> <span class="token attr-value">192.168.111.11  mq1  master 主节点</span>
<span class="token attr-name">    node2</span><span class="token punctuation">:</span> <span class="token attr-value">192.168.111.12  mq2  repl1  副本节点</span>
<span class="token attr-name">    node3</span><span class="token punctuation">:</span> <span class="token attr-value">192.168.111.13  mq3  repl2  副本节点</span>

<span class="token comment" spellcheck="true"># 1.克隆三台机器</span>
<span class="token comment" spellcheck="true">## 1.1 更改主机名</span>
<span class="token attr-name">    主机mq2：hostnamectl</span> <span class="token attr-value">set-hostname mq2</span>
<span class="token attr-name">    主机mq3：hostnamectl</span> <span class="token attr-value">set-hostname mq3</span>
<span class="token comment" spellcheck="true">## 1.2 更改三台主机ip</span>
<span class="token attr-name">    只需更改</span> <span class="token attr-value">mq2、mq3</span>
<span class="token attr-name">    vim</span> <span class="token attr-value">/etc/sysconfig/network-scripts/ifcfg-ens33</span>
    内容修改：
<span class="token attr-name">    主机mq2</span> <span class="token attr-value">IPADDR=192.168.111.12</span>
<span class="token attr-name">    主机mq3</span> <span class="token attr-value">IPADDR=192.168.111.13</span>
<span class="token comment" spellcheck="true">    ## 修改后重启network服务</span>
<span class="token attr-name">    systemctl</span> <span class="token attr-value">restart network</span>
<span class="token comment" spellcheck="true">## 1.3 添加主机映射</span>
<span class="token attr-name">    ①主机mq1：vim</span> <span class="token attr-value">/etc/hosts 加入：</span>
<span class="token attr-name">        192.168.111.11</span> <span class="token attr-value">mq1</span>
<span class="token attr-name">        192.168.111.12</span> <span class="token attr-value">mq2</span>
<span class="token attr-name">        192.168.111.13</span> <span class="token attr-value">mq3</span>
        保存退出
<span class="token attr-name">    ②主机mq1</span><span class="token punctuation">:</span>  <span class="token attr-value">scp /etc/hosts root@mq2:/etc/hosts</span>
<span class="token attr-name">               scp</span> <span class="token attr-value">/etc/hosts root@mq3:/etc/hosts</span>

<span class="token comment" spellcheck="true"># 2.三个机器安装rabbitmq,并同步cookie文件,在mq1上执行:</span>
<span class="token attr-name">    scp</span> <span class="token attr-value">/var/lib/rabbitmq/.erlang.cookie root@mq2:/var/lib/rabbitmq/</span>
<span class="token attr-name">    scp</span> <span class="token attr-value">/var/lib/rabbitmq/.erlang.cookie root@mq3:/var/lib/rabbitmq/</span>
<span class="token comment" spellcheck="true">## 必须保证三台机器 .erlang.cookie 内容一致</span>

<span class="token comment" spellcheck="true"># 3.后台启动rabbitmq所有节点执行如下命令,启动成功访问管理界面:</span>
<span class="token attr-name">    rabbitmq-server</span> <span class="token attr-value">-detached</span>

<span class="token comment" spellcheck="true"># 4.在mq2和mq3执行加入集群命令:</span>
<span class="token attr-name">    1.关闭</span> <span class="token attr-value">      rabbitmqctl stop_app</span>
<span class="token attr-name">    2.加入集群</span> <span class="token attr-value">   rabbitmqctl join_cluster rabbit@mq1</span>
<span class="token attr-name">    3.启动服务</span> <span class="token attr-value">   rabbitmqctl start_app</span>
<span class="token comment" spellcheck="true"># 5.查看集群状态,任意节点执行:</span>
<span class="token attr-name">    rabbitmqctl</span> <span class="token attr-value">cluster_status    </span>

<span class="token comment" spellcheck="true"># 6.登录管理界面,展示如下状态:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218171735.png" alt></p>
<h5><span id="3-ce-shi">3.测试</span><a href="#3-ce-shi" class="header-anchor">.</a></h5><blockquote>
<p>普通集群，主机负责对交换机、队列等创建，消息进入队列，备机只是备份交换机、队列（不含队列里的消息），并不能做到故障转移</p>
</blockquote>
<h6><span id="zai-zhu-ji-chuang-jian-dui-lie-bei-ji-cha-kan">①在主机创建队列，备机查看</span><a href="#zai-zhu-ji-chuang-jian-dui-lie-bei-ji-cha-kan" class="header-anchor">.</a></h6><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218172418.png" alt></p>
<h6><span id="zhu-ji-dang-ji-cha-kan-bei-ji">②主机宕机，查看备机</span><a href="#zhu-ji-dang-ji-cha-kan-bei-ji" class="header-anchor">.</a></h6><pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> mq1 </span>
rabbitmqctl stop_app<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218173947.png" alt></p>
<h4><span id="7-1-2-jing-xiang-ji-qun">7.1.2 镜像集群</span><a href="#7-1-2-jing-xiang-ji-qun" class="header-anchor">.</a></h4><p><code>镜像队列机制就是将队列在三个节点之间设置主从关系，消息会在三个节点之间进行自动同步，且如果其中一个节点不可用，并不会导致消息丢失或服务不可用的情况，提升MQ集群的整体高可用性。</code></p>
<blockquote>
<p>队列数据可备份，但是还是无法实现故障转移</p>
</blockquote>
<h5><span id="1-jia-gou-tu">1.架构图</span><a href="#1-jia-gou-tu" class="header-anchor">.</a></h5><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201218160127.png" alt></p>
<h5><span id="2-ji-qun-pei-zhi">2.集群配置</span><a href="#2-ji-qun-pei-zhi" class="header-anchor">.</a></h5><blockquote>
<p>（在普通集群基础上）</p>
</blockquote>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 0.策略说明</span>
<span class="token attr-name">    rabbitmqctl</span> <span class="token attr-value">set_policy [-p &lt;vhost>] [--priority &lt;priority>] [--apply-to &lt;apply-to>] &lt;name> &lt;pattern>  &lt;definition></span>
<span class="token attr-name">    -p</span> <span class="token attr-value">Vhost： 可选参数，针对指定vhost下的queue进行设置</span>
<span class="token attr-name">    Name</span><span class="token punctuation">:</span>     <span class="token attr-value">policy的名称</span>
<span class="token attr-name">    Pattern</span><span class="token punctuation">:</span> <span class="token attr-value">queue的匹配模式(正则表达式)</span>
<span class="token attr-name">    Definition：镜像定义，包括三个部分ha-mode,</span> <span class="token attr-value">ha-params, ha-sync-mode</span>
<span class="token attr-name">                   ha-mode</span><span class="token punctuation">:</span><span class="token attr-value">指明镜像队列的模式，有效值为 all/exactly/nodes</span>
                        all：表示在集群中所有的节点上进行镜像
                        exactly：表示在指定个数的节点上进行镜像，节点的个数由ha-params指定
                        nodes：表示在指定的节点上进行镜像，节点名称通过ha-params指定
                ha-params：ha-mode模式需要用到的参数
                ha-sync-mode：进行队列中消息的同步方式，有效值为automatic和manual
                priority：可选参数，policy的优先级


<span class="token comment" spellcheck="true"># 1.查看当前策略</span>
<span class="token attr-name">    rabbitmqctl</span> <span class="token attr-value">list_policies</span>

<span class="token comment" spellcheck="true"># 2.添加策略</span>
<span class="token attr-name">    rabbitmqctl</span> <span class="token attr-value">set_policy ha-all '^hello' '{"ha-mode":"all","ha-sync-mode":"automatic"}' </span>
<span class="token attr-name">    说明</span><span class="token punctuation">:</span><span class="token attr-value">策略正则表达式为 “^” 表示所有匹配所有队列名称  ^hello:匹配hello开头队列</span>

<span class="token comment" spellcheck="true"># 3.删除策略</span>
<span class="token attr-name">    rabbitmqctl</span> <span class="token attr-value">clear_policy ha-all</span>

<span class="token comment" spellcheck="true"># 4.测试集群</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2><span id="pei-zhi-wen-jian">配置文件</span><a href="#pei-zhi-wen-jian" class="header-anchor">.</a></h2><h3><span id="rabbitmq-conf-example">rabbitmq.conf.example</span><a href="#rabbitmq-conf-example" class="header-anchor">.</a></h3><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># ======================================</span>
<span class="token comment" spellcheck="true"># RabbitMQ broker section</span>
<span class="token comment" spellcheck="true"># ======================================</span>

<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/configure.html. See</span>
<span class="token comment" spellcheck="true">## https://rabbitmq.com/documentation.html for documentation ToC.</span>

<span class="token comment" spellcheck="true">## Networking</span>
<span class="token comment" spellcheck="true">## ====================</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/networking.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## By default, RabbitMQ will listen on all interfaces, using</span>
<span class="token comment" spellcheck="true">## the standard (reserved) AMQP 0-9-1 and 1.0 port.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># listeners.tcp.default = 5672</span>


<span class="token comment" spellcheck="true">## To listen on a specific interface, provide an IP address with port.</span>
<span class="token comment" spellcheck="true">## For example, to listen only on localhost for both IPv4 and IPv6:</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># IPv4</span>
<span class="token comment" spellcheck="true"># listeners.tcp.local    = 127.0.0.1:5672</span>
<span class="token comment" spellcheck="true"># IPv6</span>
<span class="token comment" spellcheck="true"># listeners.tcp.local_v6 = ::1:5672</span>

<span class="token comment" spellcheck="true">## You can define multiple listeners using listener names</span>
<span class="token comment" spellcheck="true"># listeners.tcp.other_port = 5673</span>
<span class="token comment" spellcheck="true"># listeners.tcp.other_ip   = 10.10.10.10:5672</span>


<span class="token comment" spellcheck="true">## TLS listeners are configured in the same fashion as TCP listeners,</span>
<span class="token comment" spellcheck="true">## including the option to control the choice of interface.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># listeners.ssl.default = 5671</span>

<span class="token comment" spellcheck="true">## It is possible to disable regular TCP (non-TLS) listeners. Clients</span>
<span class="token comment" spellcheck="true">## not configured to use TLS and the correct TLS-enabled port won't be able</span>
<span class="token comment" spellcheck="true">## to connect to this node.</span>
<span class="token comment" spellcheck="true"># listeners.tcp = none</span>

<span class="token comment" spellcheck="true">## Number of Erlang processes that will accept connections for the TCP</span>
<span class="token comment" spellcheck="true">## and TLS listeners.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># num_acceptors.tcp = 10</span>
<span class="token comment" spellcheck="true"># num_acceptors.ssl = 10</span>

<span class="token comment" spellcheck="true">## Socket writer will force GC every so many bytes transferred.</span>
<span class="token comment" spellcheck="true">## Default is 1 GiB (`1000000000`). Set to 'off' to disable.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># socket_writer.gc_threshold = 1000000000</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">## To disable:</span>
<span class="token comment" spellcheck="true"># socket_writer.gc_threshold = off</span>

<span class="token comment" spellcheck="true">## Maximum amount of time allowed for the AMQP 0-9-1 and AMQP 1.0 handshake</span>
<span class="token comment" spellcheck="true">## (performed after socket connection and TLS handshake) to complete, in milliseconds.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># handshake_timeout = 10000</span>

<span class="token comment" spellcheck="true">## Set to 'true' to perform reverse DNS lookups when accepting a</span>
<span class="token comment" spellcheck="true">## connection. rabbitmqctl and management UI will then display hostnames</span>
<span class="token comment" spellcheck="true">## instead of IP addresses. Default value is `false`.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># reverse_dns_lookups = false</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Security, Access Control</span>
<span class="token comment" spellcheck="true">## ==============</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/access-control.html.</span>

<span class="token comment" spellcheck="true">## The default "guest" user is only permitted to access the server</span>
<span class="token comment" spellcheck="true">## via a loopback interface (e.g. localhost).</span>
<span class="token comment" spellcheck="true">## {loopback_users, [&lt;&lt;"guest">>]},</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># loopback_users.guest = true</span>

<span class="token comment" spellcheck="true">## Uncomment the following line if you want to allow access to the</span>
<span class="token comment" spellcheck="true">## guest user from anywhere on the network.</span>
<span class="token comment" spellcheck="true"># loopback_users.guest = false</span>

<span class="token comment" spellcheck="true">## TLS configuration.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/ssl.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># ssl_options.verify               = verify_peer</span>
<span class="token comment" spellcheck="true"># ssl_options.fail_if_no_peer_cert = false</span>
<span class="token comment" spellcheck="true"># ssl_options.cacertfile           = /path/to/cacert.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.certfile             = /path/to/cert.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.keyfile              = /path/to/key.pem</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># ssl_options.honor_cipher_order   = true</span>
<span class="token comment" spellcheck="true"># ssl_options.honor_ecc_order      = true</span>

<span class="token comment" spellcheck="true"># ssl_options.ciphers.1  = ECDHE-ECDSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.2  = ECDHE-RSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.3  = ECDHE-ECDSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.4  = ECDHE-RSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.5  = ECDH-ECDSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.6  = ECDH-RSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.7  = ECDH-ECDSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.8  = ECDH-RSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.9  = DHE-RSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.10 = DHE-DSS-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.11 = DHE-RSA-AES256-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.12 = DHE-DSS-AES256-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.13 = ECDHE-ECDSA-AES128-GCM-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.14 = ECDHE-RSA-AES128-GCM-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.15 = ECDHE-ECDSA-AES128-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.16 = ECDHE-RSA-AES128-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.17 = ECDH-ECDSA-AES128-GCM-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.18 = ECDH-RSA-AES128-GCM-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.19 = ECDH-ECDSA-AES128-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.20 = ECDH-RSA-AES128-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.21 = DHE-RSA-AES128-GCM-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.22 = DHE-DSS-AES128-GCM-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.23 = DHE-RSA-AES128-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.24 = DHE-DSS-AES128-SHA256</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.25 = ECDHE-ECDSA-AES256-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.26 = ECDHE-RSA-AES256-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.27 = DHE-RSA-AES256-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.28 = DHE-DSS-AES256-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.29 = ECDH-ECDSA-AES256-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.30 = ECDH-RSA-AES256-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.31 = ECDHE-ECDSA-AES128-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.32 = ECDHE-RSA-AES128-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.33 = DHE-RSA-AES128-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.34 = DHE-DSS-AES128-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.35 = ECDH-ECDSA-AES128-SHA</span>
<span class="token comment" spellcheck="true"># ssl_options.ciphers.36 = ECDH-RSA-AES128-SHA</span>

<span class="token comment" spellcheck="true">## Select an authentication/authorisation backend to use.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Alternative backends are provided by plugins, such as rabbitmq-auth-backend-ldap.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## NB: These settings require certain plugins to be enabled.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guides:</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">##  * https://rabbitmq.com/plugins.html</span>
<span class="token comment" spellcheck="true">##  * https://rabbitmq.com/access-control.html</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true"># auth_backends.1   = rabbit_auth_backend_internal</span>

<span class="token comment" spellcheck="true">## uses separate backends for authentication and authorisation,</span>
<span class="token comment" spellcheck="true">## see below.</span>
<span class="token comment" spellcheck="true"># auth_backends.1.authn = rabbit_auth_backend_ldap</span>
<span class="token comment" spellcheck="true"># auth_backends.1.authz = rabbit_auth_backend_internal</span>

<span class="token comment" spellcheck="true">## The rabbitmq_auth_backend_ldap plugin allows the broker to</span>
<span class="token comment" spellcheck="true">## perform authentication and authorisation by deferring to an</span>
<span class="token comment" spellcheck="true">## external LDAP server.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Relevant doc guides:</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## * https://rabbitmq.com/ldap.html</span>
<span class="token comment" spellcheck="true">## * https://rabbitmq.com/access-control.html</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## uses LDAP for both authentication and authorisation</span>
<span class="token comment" spellcheck="true"># auth_backends.1 = rabbit_auth_backend_ldap</span>

<span class="token comment" spellcheck="true">## uses HTTP service for both authentication and</span>
<span class="token comment" spellcheck="true">## authorisation</span>
<span class="token comment" spellcheck="true"># auth_backends.1 = rabbit_auth_backend_http</span>

<span class="token comment" spellcheck="true">## uses two backends in a chain: HTTP first, then internal</span>
<span class="token comment" spellcheck="true"># auth_backends.1   = rabbit_auth_backend_http</span>
<span class="token comment" spellcheck="true"># auth_backends.2   = rabbit_auth_backend_internal</span>

<span class="token comment" spellcheck="true">## Authentication</span>
<span class="token comment" spellcheck="true">## The built-in mechanisms are 'PLAIN',</span>
<span class="token comment" spellcheck="true">## 'AMQPLAIN', and 'EXTERNAL' Additional mechanisms can be added via</span>
<span class="token comment" spellcheck="true">## plugins.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/authentication.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_mechanisms.1 = PLAIN</span>
<span class="token comment" spellcheck="true"># auth_mechanisms.2 = AMQPLAIN</span>

<span class="token comment" spellcheck="true">## The rabbitmq-auth-mechanism-ssl plugin makes it possible to</span>
<span class="token comment" spellcheck="true">## authenticate a user based on the client's x509 (TLS) certificate.</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/authentication.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## To use auth-mechanism-ssl, the EXTERNAL mechanism should</span>
<span class="token comment" spellcheck="true">## be enabled:</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_mechanisms.1 = PLAIN</span>
<span class="token comment" spellcheck="true"># auth_mechanisms.2 = AMQPLAIN</span>
<span class="token comment" spellcheck="true"># auth_mechanisms.3 = EXTERNAL</span>

<span class="token comment" spellcheck="true">## To force x509 certificate-based authentication on all clients,</span>
<span class="token comment" spellcheck="true">## exclude all other mechanisms (note: this will disable password-based</span>
<span class="token comment" spellcheck="true">## authentication even for the management UI!):</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_mechanisms.1 = EXTERNAL</span>

<span class="token comment" spellcheck="true">## This pertains to both the rabbitmq-auth-mechanism-ssl plugin and</span>
<span class="token comment" spellcheck="true">## STOMP ssl_cert_login configurations. See the RabbitMQ STOMP plugin</span>
<span class="token comment" spellcheck="true">## configuration section later in this file and the README in</span>
<span class="token comment" spellcheck="true">## https://github.com/rabbitmq/rabbitmq-auth-mechanism-ssl for further</span>
<span class="token comment" spellcheck="true">## details.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## To use the TLS cert's CN instead of its DN as the username</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># ssl_cert_login_from   = common_name</span>

<span class="token comment" spellcheck="true">## TLS handshake timeout, in milliseconds.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># ssl_handshake_timeout = 5000</span>


<span class="token comment" spellcheck="true">## Cluster name</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># cluster_name = dev3.eng.megacorp.local</span>

<span class="token comment" spellcheck="true">## Password hashing implementation. Will only affect newly</span>
<span class="token comment" spellcheck="true">## created users. To recalculate hash for an existing user</span>
<span class="token comment" spellcheck="true">## it's necessary to update her password.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## To use SHA-512, set to rabbit_password_hashing_sha512.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># password_hashing_module = rabbit_password_hashing_sha256</span>

<span class="token comment" spellcheck="true">## When importing definitions exported from versions earlier</span>
<span class="token comment" spellcheck="true">## than 3.6.0, it is possible to go back to MD5 (only do this</span>
<span class="token comment" spellcheck="true">## as a temporary measure!) by setting this to rabbit_password_hashing_md5.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># password_hashing_module = rabbit_password_hashing_md5</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Default User / VHost</span>
<span class="token comment" spellcheck="true">## ====================</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## On first start RabbitMQ will create a vhost and a user. These</span>
<span class="token comment" spellcheck="true">## config items control what gets created.</span>
<span class="token comment" spellcheck="true">## Relevant doc guide: https://rabbitmq.com/access-control.html</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># default_vhost = /</span>
<span class="token comment" spellcheck="true"># default_user = guest</span>
<span class="token comment" spellcheck="true"># default_pass = guest</span>

<span class="token comment" spellcheck="true"># default_permissions.configure = .*</span>
<span class="token comment" spellcheck="true"># default_permissions.read = .*</span>
<span class="token comment" spellcheck="true"># default_permissions.write = .*</span>

<span class="token comment" spellcheck="true">## Tags for default user</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## For more details about tags, see the documentation for the</span>
<span class="token comment" spellcheck="true">## Management Plugin at https://rabbitmq.com/management.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># default_user_tags.administrator = true</span>

<span class="token comment" spellcheck="true">## Define other tags like this:</span>
<span class="token comment" spellcheck="true"># default_user_tags.management = true</span>
<span class="token comment" spellcheck="true"># default_user_tags.custom_tag = true</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Additional network and protocol related configuration</span>
<span class="token comment" spellcheck="true">## =====================================================</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Set the default AMQP 0-9-1 heartbeat interval (in seconds).</span>
<span class="token comment" spellcheck="true">## Related doc guides:</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## * https://rabbitmq.com/heartbeats.html</span>
<span class="token comment" spellcheck="true">## * https://rabbitmq.com/networking.html</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># heartbeat = 60</span>

<span class="token comment" spellcheck="true">## Set the max permissible size of an AMQP frame (in bytes).</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># frame_max = 131072</span>

<span class="token comment" spellcheck="true">## Set the max frame size the server will accept before connection</span>
<span class="token comment" spellcheck="true">## tuning occurs</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># initial_frame_max = 4096</span>

<span class="token comment" spellcheck="true">## Set the max permissible number of channels per connection.</span>
<span class="token comment" spellcheck="true">## 0 means "no limit".</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># channel_max = 128</span>

<span class="token comment" spellcheck="true">## Customising TCP Listener (Socket) Configuration.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guides:</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## * https://rabbitmq.com/networking.html</span>
<span class="token comment" spellcheck="true">## * https://www.erlang.org/doc/man/inet.html#setopts-2</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true"># tcp_listen_options.backlog = 128</span>
<span class="token comment" spellcheck="true"># tcp_listen_options.nodelay = true</span>
<span class="token comment" spellcheck="true"># tcp_listen_options.exit_on_close = false</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># tcp_listen_options.keepalive = true</span>
<span class="token comment" spellcheck="true"># tcp_listen_options.send_timeout = 15000</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># tcp_listen_options.buffer = 196608</span>
<span class="token comment" spellcheck="true"># tcp_listen_options.sndbuf = 196608</span>
<span class="token comment" spellcheck="true"># tcp_listen_options.recbuf = 196608</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Resource Limits &amp; Flow Control</span>
<span class="token comment" spellcheck="true">## ==============================</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/memory.html.</span>

<span class="token comment" spellcheck="true">## Memory-based Flow Control threshold.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># vm_memory_high_watermark.relative = 0.4</span>

<span class="token comment" spellcheck="true">## Alternatively, we can set a limit (in bytes) of RAM used by the node.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># vm_memory_high_watermark.absolute = 1073741824</span>

<span class="token comment" spellcheck="true">## Or you can set absolute value using memory units (with RabbitMQ 3.6.0+).</span>
<span class="token comment" spellcheck="true">## Absolute watermark will be ignored if relative is defined!</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># vm_memory_high_watermark.absolute = 2GB</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Supported unit symbols:</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## k, kiB: kibibytes (2^10 - 1,024 bytes)</span>
<span class="token comment" spellcheck="true">## M, MiB: mebibytes (2^20 - 1,048,576 bytes)</span>
<span class="token comment" spellcheck="true">## G, GiB: gibibytes (2^30 - 1,073,741,824 bytes)</span>
<span class="token comment" spellcheck="true">## kB: kilobytes (10^3 - 1,000 bytes)</span>
<span class="token comment" spellcheck="true">## MB: megabytes (10^6 - 1,000,000 bytes)</span>
<span class="token comment" spellcheck="true">## GB: gigabytes (10^9 - 1,000,000,000 bytes)</span>



<span class="token comment" spellcheck="true">## Fraction of the high watermark limit at which queues start to</span>
<span class="token comment" spellcheck="true">## page message out to disc in order to free up memory.</span>
<span class="token comment" spellcheck="true">## For example, when vm_memory_high_watermark is set to 0.4 and this value is set to 0.5,</span>
<span class="token comment" spellcheck="true">## paging can begin as early as when 20% of total available RAM is used by the node.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Values greater than 1.0 can be dangerous and should be used carefully.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## One alternative to this is to use durable queues and publish messages</span>
<span class="token comment" spellcheck="true">## as persistent (delivery mode = 2). With this combination queues will</span>
<span class="token comment" spellcheck="true">## move messages to disk much more rapidly.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Another alternative is to configure queues to page all messages (both</span>
<span class="token comment" spellcheck="true">## persistent and transient) to disk as quickly</span>
<span class="token comment" spellcheck="true">## as possible, see https://rabbitmq.com/lazy-queues.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># vm_memory_high_watermark_paging_ratio = 0.5</span>

<span class="token comment" spellcheck="true">## Selects Erlang VM memory consumption calculation strategy. Can be `allocated`, `rss` or `legacy` (aliased as `erlang`),</span>
<span class="token comment" spellcheck="true">## Introduced in 3.6.11. `rss` is the default as of 3.6.12.</span>
<span class="token comment" spellcheck="true">## See https://github.com/rabbitmq/rabbitmq-server/issues/1223 and rabbitmq/rabbitmq-common#224 for background.</span>
<span class="token comment" spellcheck="true"># vm_memory_calculation_strategy = rss</span>

<span class="token comment" spellcheck="true">## Interval (in milliseconds) at which we perform the check of the memory</span>
<span class="token comment" spellcheck="true">## levels against the watermarks.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># memory_monitor_interval = 2500</span>

<span class="token comment" spellcheck="true">## The total memory available can be calculated from the OS resources</span>
<span class="token comment" spellcheck="true">## - default option - or provided as a configuration parameter.</span>
<span class="token comment" spellcheck="true"># total_memory_available_override_value = 2GB</span>

<span class="token comment" spellcheck="true">## Set disk free limit (in bytes). Once free disk space reaches this</span>
<span class="token comment" spellcheck="true">## lower bound, a disk alarm will be set - see the documentation</span>
<span class="token comment" spellcheck="true">## listed above for more details.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Absolute watermark will be ignored if relative is defined!</span>
<span class="token comment" spellcheck="true"># disk_free_limit.absolute = 50000</span>

<span class="token comment" spellcheck="true">## Or you can set it using memory units (same as in vm_memory_high_watermark)</span>
<span class="token comment" spellcheck="true">## with RabbitMQ 3.6.0+.</span>
<span class="token comment" spellcheck="true"># disk_free_limit.absolute = 500KB</span>
<span class="token comment" spellcheck="true"># disk_free_limit.absolute = 50mb</span>
<span class="token comment" spellcheck="true"># disk_free_limit.absolute = 5GB</span>

<span class="token comment" spellcheck="true">## Alternatively, we can set a limit relative to total available RAM.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Values lower than 1.0 can be dangerous and should be used carefully.</span>
<span class="token comment" spellcheck="true"># disk_free_limit.relative = 2.0</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Clustering</span>
<span class="token comment" spellcheck="true">## =====================</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># cluster_partition_handling = ignore</span>

<span class="token comment" spellcheck="true">## pause_if_all_down strategy require additional configuration</span>
<span class="token comment" spellcheck="true"># cluster_partition_handling = pause_if_all_down</span>

<span class="token comment" spellcheck="true">## Recover strategy. Can be either 'autoheal' or 'ignore'</span>
<span class="token comment" spellcheck="true"># cluster_partition_handling.pause_if_all_down.recover = ignore</span>

<span class="token comment" spellcheck="true">## Node names to check</span>
<span class="token comment" spellcheck="true"># cluster_partition_handling.pause_if_all_down.nodes.1 = rabbit@localhost</span>
<span class="token comment" spellcheck="true"># cluster_partition_handling.pause_if_all_down.nodes.2 = hare@localhost</span>

<span class="token comment" spellcheck="true">## Mirror sync batch size, in messages. Increasing this will speed</span>
<span class="token comment" spellcheck="true">## up syncing but total batch size in bytes must not exceed 2 GiB.</span>
<span class="token comment" spellcheck="true">## Available in RabbitMQ 3.6.0 or later.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mirroring_sync_batch_size = 4096</span>

<span class="token comment" spellcheck="true">## Make clustering happen *automatically* at startup. Only applied</span>
<span class="token comment" spellcheck="true">## to nodes that have just been reset or started for the first time.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Relevant doc guide: https://rabbitmq.com//cluster-formation.html</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true"># cluster_formation.peer_discovery_backend     = rabbit_peer_discovery_classic_config</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># cluster_formation.classic_config.nodes.1 = rabbit1@hostname</span>
<span class="token comment" spellcheck="true"># cluster_formation.classic_config.nodes.2 = rabbit2@hostname</span>
<span class="token comment" spellcheck="true"># cluster_formation.classic_config.nodes.3 = rabbit3@hostname</span>
<span class="token comment" spellcheck="true"># cluster_formation.classic_config.nodes.4 = rabbit4@hostname</span>

<span class="token comment" spellcheck="true">## DNS-based peer discovery. This backend will list A records</span>
<span class="token comment" spellcheck="true">## of the configured hostname and perform reverse lookups for</span>
<span class="token comment" spellcheck="true">## the addresses returned.</span>

<span class="token comment" spellcheck="true"># cluster_formation.peer_discovery_backend = rabbit_peer_discovery_dns</span>
<span class="token comment" spellcheck="true"># cluster_formation.dns.hostname = discovery.eng.example.local</span>

<span class="token comment" spellcheck="true">## This node's type can be configured. If you are not sure</span>
<span class="token comment" spellcheck="true">## what node type to use, always use 'disc'.</span>
<span class="token comment" spellcheck="true"># cluster_formation.node_type = disc</span>

<span class="token comment" spellcheck="true">## Interval (in milliseconds) at which we send keepalive messages</span>
<span class="token comment" spellcheck="true">## to other cluster members. Note that this is not the same thing</span>
<span class="token comment" spellcheck="true">## as net_ticktime; missed keepalive messages will not cause nodes</span>
<span class="token comment" spellcheck="true">## to be considered down.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># cluster_keepalive_interval = 10000</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Statistics Collection</span>
<span class="token comment" spellcheck="true">## =====================</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Statistics collection interval (in milliseconds). Increasing</span>
<span class="token comment" spellcheck="true">## this will reduce the load on management database.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># collect_statistics_interval = 5000</span>

<span class="token comment" spellcheck="true">## Fine vs. coarse statistics</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># This value is no longer meant to be configured directly.</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># See https://www.rabbitmq.com/management.html#fine-stats.</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Ra Settings</span>
<span class="token comment" spellcheck="true">## =====================</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## NB: changing these on a node with existing data directory</span>
<span class="token comment" spellcheck="true">##     can lead to DATA LOSS.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># raft.segment_max_entries = 65536</span>
<span class="token comment" spellcheck="true"># raft.wal_max_size_bytes = 1048576</span>
<span class="token comment" spellcheck="true"># raft.wal_max_batch_size = 4096</span>
<span class="token comment" spellcheck="true"># raft.snapshot_chunk_size = 1000000</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Misc/Advanced Options</span>
<span class="token comment" spellcheck="true">## =====================</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## NB: Change these only if you understand what you are doing!</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Timeout used when waiting for Mnesia tables in a cluster to</span>
<span class="token comment" spellcheck="true">## become available.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mnesia_table_loading_retry_timeout = 30000</span>

<span class="token comment" spellcheck="true">## Retries when waiting for Mnesia tables in the cluster startup. Note that</span>
<span class="token comment" spellcheck="true">## this setting is not applied to Mnesia upgrades or node deletions.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mnesia_table_loading_retry_limit = 10</span>

<span class="token comment" spellcheck="true">## Size in bytes below which to embed messages in the queue index.</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/persistence-conf.html</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># queue_index_embed_msgs_below = 4096</span>

<span class="token comment" spellcheck="true">## You can also set this size in memory units</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># queue_index_embed_msgs_below = 4kb</span>

<span class="token comment" spellcheck="true">## Whether or not to enable background periodic forced GC runs for all</span>
<span class="token comment" spellcheck="true">## Erlang processes on the node in "waiting" state.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Disabling background GC may reduce latency for client operations,</span>
<span class="token comment" spellcheck="true">## keeping it enabled may reduce median RAM usage by the binary heap</span>
<span class="token comment" spellcheck="true">## (see https://www.erlang-solutions.com/blog/erlang-garbage-collector.html).</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Before trying this option, please take a look at the memory</span>
<span class="token comment" spellcheck="true">## breakdown (https://www.rabbitmq.com/memory-use.html).</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># background_gc_enabled = false</span>

<span class="token comment" spellcheck="true">## Target (desired) interval (in milliseconds) at which we run background GC.</span>
<span class="token comment" spellcheck="true">## The actual interval will vary depending on how long it takes to execute</span>
<span class="token comment" spellcheck="true">## the operation (can be higher than this interval). Values less than</span>
<span class="token comment" spellcheck="true">## 30000 milliseconds are not recommended.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># background_gc_target_interval = 60000</span>

<span class="token comment" spellcheck="true">## Whether or not to enable proxy protocol support.</span>
<span class="token comment" spellcheck="true">## Once enabled, clients cannot directly connect to the broker</span>
<span class="token comment" spellcheck="true">## anymore. They must connect through a load balancer that sends the</span>
<span class="token comment" spellcheck="true">## proxy protocol header to the broker at connection time.</span>
<span class="token comment" spellcheck="true">## This setting applies only to AMQP clients, other protocols</span>
<span class="token comment" spellcheck="true">## like MQTT or STOMP have their own setting to enable proxy protocol.</span>
<span class="token comment" spellcheck="true">## See the plugins documentation for more information.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># proxy_protocol = false</span>

<span class="token comment" spellcheck="true">## Overriden product name and version.</span>
<span class="token comment" spellcheck="true">## They are set to "RabbitMQ" and the release version by default.</span>
<span class="token comment" spellcheck="true"># product.name = RabbitMQ</span>
<span class="token comment" spellcheck="true"># product.version = 1.2.3</span>

<span class="token comment" spellcheck="true">## "Message of the day" file.</span>
<span class="token comment" spellcheck="true">## Its content is used to expand the logged and printed banners.</span>
<span class="token comment" spellcheck="true">## Default to /etc/rabbitmq/motd on Unix, %APPDATA%\RabbitMQ\motd.txt</span>
<span class="token comment" spellcheck="true">## on Windows.</span>
<span class="token comment" spellcheck="true"># motd_file = /etc/rabbitmq/motd</span>

<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">## Advanced Erlang Networking/Clustering Options.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/clustering.html</span>
<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>

<span class="token comment" spellcheck="true"># ======================================</span>
<span class="token comment" spellcheck="true"># Kernel section</span>
<span class="token comment" spellcheck="true"># ======================================</span>

<span class="token comment" spellcheck="true">## Timeout used to detect peer unavailability, including CLI tools.</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://www.rabbitmq.com/nettick.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># net_ticktime = 60</span>

<span class="token comment" spellcheck="true">## Inter-node communication port range.</span>
<span class="token comment" spellcheck="true">## The parameters inet_dist_listen_min and inet_dist_listen_max</span>
<span class="token comment" spellcheck="true">## can be configured in the classic config format only.</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://www.rabbitmq.com/networking.html#epmd-inet-dist-port-range.</span>


<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">## RabbitMQ Management Plugin</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/management.html.</span>
<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>

<span class="token comment" spellcheck="true"># =======================================</span>
<span class="token comment" spellcheck="true"># Management section</span>
<span class="token comment" spellcheck="true"># =======================================</span>

<span class="token comment" spellcheck="true">## Preload schema definitions from the following JSON file.</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/management.html#load-definitions.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># management.load_definitions = /path/to/exported/definitions.json</span>

<span class="token comment" spellcheck="true">## Log all requests to the management HTTP API to a file.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># management.http_log_dir = /path/to/access.log</span>

<span class="token comment" spellcheck="true">## HTTP listener and embedded Web server settings.</span>
<span class="token comment" spellcheck="true"># ## See https://rabbitmq.com/management.html for details.</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># management.tcp.port = 15672</span>
<span class="token comment" spellcheck="true"># management.tcp.ip   = 0.0.0.0</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># management.tcp.shutdown_timeout   = 7000</span>
<span class="token comment" spellcheck="true"># management.tcp.max_keepalive      = 120</span>
<span class="token comment" spellcheck="true"># management.tcp.idle_timeout       = 120</span>
<span class="token comment" spellcheck="true"># management.tcp.inactivity_timeout = 120</span>
<span class="token comment" spellcheck="true"># management.tcp.request_timeout    = 120</span>
<span class="token comment" spellcheck="true"># management.tcp.compress           = true</span>

<span class="token comment" spellcheck="true">## HTTPS listener settings.</span>
<span class="token comment" spellcheck="true">## See https://rabbitmq.com/management.html and https://rabbitmq.com/ssl.html for details.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># management.ssl.port       = 15671</span>
<span class="token comment" spellcheck="true"># management.ssl.cacertfile = /path/to/ca_certificate.pem</span>
<span class="token comment" spellcheck="true"># management.ssl.certfile   = /path/to/server_certificate.pem</span>
<span class="token comment" spellcheck="true"># management.ssl.keyfile    = /path/to/server_key.pem</span>

<span class="token comment" spellcheck="true">## More TLS options</span>
<span class="token comment" spellcheck="true"># management.ssl.honor_cipher_order   = true</span>
<span class="token comment" spellcheck="true"># management.ssl.honor_ecc_order      = true</span>
<span class="token comment" spellcheck="true"># management.ssl.client_renegotiation = false</span>
<span class="token comment" spellcheck="true"># management.ssl.secure_renegotiate   = true</span>

<span class="token comment" spellcheck="true">## Supported TLS versions</span>
<span class="token comment" spellcheck="true"># management.ssl.versions.1 = tlsv1.2</span>
<span class="token comment" spellcheck="true"># management.ssl.versions.2 = tlsv1.1</span>

<span class="token comment" spellcheck="true">## Cipher suites the server is allowed to use</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.1 = ECDHE-ECDSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.2 = ECDHE-RSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.3 = ECDHE-ECDSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.4 = ECDHE-RSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.5 = ECDH-ECDSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.6 = ECDH-RSA-AES256-GCM-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.7 = ECDH-ECDSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.8 = ECDH-RSA-AES256-SHA384</span>
<span class="token comment" spellcheck="true"># management.ssl.ciphers.9 = DHE-RSA-AES256-GCM-SHA384</span>

<span class="token comment" spellcheck="true">## URL path prefix for HTTP API and management UI</span>
<span class="token comment" spellcheck="true"># management.path_prefix = /a-prefix</span>

<span class="token comment" spellcheck="true">## One of 'basic', 'detailed' or 'none'. See</span>
<span class="token comment" spellcheck="true">## https://rabbitmq.com/management.html#fine-stats for more details.</span>
<span class="token comment" spellcheck="true"># management.rates_mode = basic</span>

<span class="token comment" spellcheck="true">## Configure how long aggregated data (such as message rates and queue</span>
<span class="token comment" spellcheck="true">## lengths) is retained. Please read the plugin's documentation in</span>
<span class="token comment" spellcheck="true">## https://rabbitmq.com/management.html#configuration for more</span>
<span class="token comment" spellcheck="true">## details.</span>
<span class="token comment" spellcheck="true">## Your can use 'minute', 'hour' and 'day' keys or integer key (in seconds)</span>
<span class="token comment" spellcheck="true"># management.sample_retention_policies.global.minute    = 5</span>
<span class="token comment" spellcheck="true"># management.sample_retention_policies.global.hour  = 60</span>
<span class="token comment" spellcheck="true"># management.sample_retention_policies.global.day = 1200</span>

<span class="token comment" spellcheck="true"># management.sample_retention_policies.basic.minute   = 5</span>
<span class="token comment" spellcheck="true"># management.sample_retention_policies.basic.hour = 60</span>

<span class="token comment" spellcheck="true"># management.sample_retention_policies.detailed.10 = 5</span>

<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">## RabbitMQ Shovel Plugin</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/shovel.html</span>
<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>

<span class="token comment" spellcheck="true">## See advanced.config.example for a Shovel plugin example</span>


<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">## RabbitMQ STOMP Plugin</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/stomp.html</span>
<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>

<span class="token comment" spellcheck="true"># =======================================</span>
<span class="token comment" spellcheck="true"># STOMP section</span>
<span class="token comment" spellcheck="true"># =======================================</span>

<span class="token comment" spellcheck="true">## See https://rabbitmq.com/stomp.html for details.</span>

<span class="token comment" spellcheck="true">## TCP listeners.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.listeners.tcp.1 = 127.0.0.1:61613</span>
<span class="token comment" spellcheck="true"># stomp.listeners.tcp.2 = ::1:61613</span>

<span class="token comment" spellcheck="true">## TCP listener settings</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.tcp_listen_options.backlog   = 2048</span>
<span class="token comment" spellcheck="true"># stomp.tcp_listen_options.recbuf    = 131072</span>
<span class="token comment" spellcheck="true"># stomp.tcp_listen_options.sndbuf    = 131072</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># stomp.tcp_listen_options.keepalive = true</span>
<span class="token comment" spellcheck="true"># stomp.tcp_listen_options.nodelay   = true</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># stomp.tcp_listen_options.exit_on_close = true</span>
<span class="token comment" spellcheck="true"># stomp.tcp_listen_options.send_timeout  = 120</span>

<span class="token comment" spellcheck="true">## Proxy protocol support</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.proxy_protocol = false</span>

<span class="token comment" spellcheck="true">## TLS listeners</span>
<span class="token comment" spellcheck="true">## See https://rabbitmq.com/stomp.html and https://rabbitmq.com/ssl.html for details.</span>
<span class="token comment" spellcheck="true"># stomp.listeners.ssl.default = 61614</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># ssl_options.cacertfile = path/to/cacert.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.certfile   = path/to/cert.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.keyfile    = path/to/key.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.verify     =  verify_peer</span>
<span class="token comment" spellcheck="true"># ssl_options.fail_if_no_peer_cert = true</span>


<span class="token comment" spellcheck="true">## Number of Erlang processes that will accept connections for the TCP</span>
<span class="token comment" spellcheck="true">## and TLS listeners.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.num_acceptors.tcp = 10</span>
<span class="token comment" spellcheck="true"># stomp.num_acceptors.ssl = 1</span>

<span class="token comment" spellcheck="true">## Additional TLS options</span>

<span class="token comment" spellcheck="true">## Extract a name from the client's certificate when using TLS.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.ssl_cert_login = true</span>

<span class="token comment" spellcheck="true">## Set a default user name and password. This is used as the default login</span>
<span class="token comment" spellcheck="true">## whenever a CONNECT frame omits the login and passcode headers.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Please note that setting this will allow clients to connect without</span>
<span class="token comment" spellcheck="true">## authenticating!</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.default_user = guest</span>
<span class="token comment" spellcheck="true"># stomp.default_pass = guest</span>

<span class="token comment" spellcheck="true">## If a default user is configured, or you have configured use TLS client</span>
<span class="token comment" spellcheck="true">## certificate based authentication, you can choose to allow clients to</span>
<span class="token comment" spellcheck="true">## omit the CONNECT frame entirely. If set to true, the client is</span>
<span class="token comment" spellcheck="true">## automatically connected as the default user or user supplied in the</span>
<span class="token comment" spellcheck="true">## TLS certificate whenever the first frame sent on a session is not a</span>
<span class="token comment" spellcheck="true">## CONNECT frame.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.implicit_connect = true</span>

<span class="token comment" spellcheck="true">## Whether or not to enable proxy protocol support.</span>
<span class="token comment" spellcheck="true">## Once enabled, clients cannot directly connect to the broker</span>
<span class="token comment" spellcheck="true">## anymore. They must connect through a load balancer that sends the</span>
<span class="token comment" spellcheck="true">## proxy protocol header to the broker at connection time.</span>
<span class="token comment" spellcheck="true">## This setting applies only to STOMP clients, other protocols</span>
<span class="token comment" spellcheck="true">## like MQTT or AMQP have their own setting to enable proxy protocol.</span>
<span class="token comment" spellcheck="true">## See the plugins or broker documentation for more information.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># stomp.proxy_protocol = false</span>

<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">## RabbitMQ MQTT Adapter</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## See https://github.com/rabbitmq/rabbitmq-mqtt/blob/stable/README.md</span>
<span class="token comment" spellcheck="true">## for details</span>
<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>

<span class="token comment" spellcheck="true"># =======================================</span>
<span class="token comment" spellcheck="true"># MQTT section</span>
<span class="token comment" spellcheck="true"># =======================================</span>

<span class="token comment" spellcheck="true">## TCP listener settings.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.listeners.tcp.1 = 127.0.0.1:61613</span>
<span class="token comment" spellcheck="true"># mqtt.listeners.tcp.2 = ::1:61613</span>

<span class="token comment" spellcheck="true">## TCP listener options (as per the broker configuration).</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.tcp_listen_options.backlog = 4096</span>
<span class="token comment" spellcheck="true"># mqtt.tcp_listen_options.recbuf  = 131072</span>
<span class="token comment" spellcheck="true"># mqtt.tcp_listen_options.sndbuf  = 131072</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># mqtt.tcp_listen_options.keepalive = true</span>
<span class="token comment" spellcheck="true"># mqtt.tcp_listen_options.nodelay   = true</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># mqtt.tcp_listen_options.exit_on_close = true</span>
<span class="token comment" spellcheck="true"># mqtt.tcp_listen_options.send_timeout  = 120</span>

<span class="token comment" spellcheck="true">## TLS listener settings</span>
<span class="token comment" spellcheck="true">## ## See https://rabbitmq.com/mqtt.html and https://rabbitmq.com/ssl.html for details.</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># mqtt.listeners.ssl.default = 8883</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># ssl_options.cacertfile = /path/to/tls/ca_certificate_bundle.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.certfile   = /path/to/tls/server_certificate.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.keyfile    = /path/to/tls/server_key.pem</span>
<span class="token comment" spellcheck="true"># ssl_options.verify     = verify_peer</span>
<span class="token comment" spellcheck="true"># ssl_options.fail_if_no_peer_cert  = true</span>
<span class="token comment" spellcheck="true">#</span>


<span class="token comment" spellcheck="true">## Number of Erlang processes that will accept connections for the TCP</span>
<span class="token comment" spellcheck="true">## and TLS listeners.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.num_acceptors.tcp = 10</span>
<span class="token comment" spellcheck="true"># mqtt.num_acceptors.ssl = 10</span>

<span class="token comment" spellcheck="true">## Whether or not to enable proxy protocol support.</span>
<span class="token comment" spellcheck="true">## Once enabled, clients cannot directly connect to the broker</span>
<span class="token comment" spellcheck="true">## anymore. They must connect through a load balancer that sends the</span>
<span class="token comment" spellcheck="true">## proxy protocol header to the broker at connection time.</span>
<span class="token comment" spellcheck="true">## This setting applies only to STOMP clients, other protocols</span>
<span class="token comment" spellcheck="true">## like STOMP or AMQP have their own setting to enable proxy protocol.</span>
<span class="token comment" spellcheck="true">## See the plugins or broker documentation for more information.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.proxy_protocol = false</span>

<span class="token comment" spellcheck="true">## Set the default user name and password used for anonymous connections (when client</span>
<span class="token comment" spellcheck="true">## provides no credentials). Anonymous connections are highly discouraged!</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.default_user = guest</span>
<span class="token comment" spellcheck="true"># mqtt.default_pass = guest</span>

<span class="token comment" spellcheck="true">## Enable anonymous connections. If this is set to false, clients MUST provide</span>
<span class="token comment" spellcheck="true">## credentials in order to connect. See also the mqtt.default_user/mqtt.default_pass</span>
<span class="token comment" spellcheck="true">## keys. Anonymous connections are highly discouraged!</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.allow_anonymous = true</span>

<span class="token comment" spellcheck="true">## If you have multiple vhosts, specify the one to which the</span>
<span class="token comment" spellcheck="true">## adapter connects.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.vhost = /</span>

<span class="token comment" spellcheck="true">## Specify the exchange to which messages from MQTT clients are published.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.exchange = amq.topic</span>

<span class="token comment" spellcheck="true">## Specify TTL (time to live) to control the lifetime of non-clean sessions.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.subscription_ttl = 1800000</span>

<span class="token comment" spellcheck="true">## Set the prefetch count (governing the maximum number of unacknowledged</span>
<span class="token comment" spellcheck="true">## messages that will be delivered).</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># mqtt.prefetch = 10</span>


<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">## RabbitMQ AMQP 1.0 Support</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## See https://github.com/rabbitmq/rabbitmq-amqp1.0/blob/stable/README.md.</span>
<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>

<span class="token comment" spellcheck="true"># =======================================</span>
<span class="token comment" spellcheck="true"># AMQP 1.0 section</span>
<span class="token comment" spellcheck="true"># =======================================</span>


<span class="token comment" spellcheck="true">## Connections that are not authenticated with SASL will connect as this</span>
<span class="token comment" spellcheck="true">## account. See the README for more information.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Please note that setting this will allow clients to connect without</span>
<span class="token comment" spellcheck="true">## authenticating!</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># amqp1_0.default_user = guest</span>

<span class="token comment" spellcheck="true">## Enable protocol strict mode. See the README for more information.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># amqp1_0.protocol_strict_mode = false</span>

<span class="token comment" spellcheck="true">## Logging settings.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## See https://rabbitmq.com/logging.html and https://github.com/erlang-lager/lager for details.</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Log directory, taken from the RABBITMQ_LOG_BASE env variable by default.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># log.dir = /var/log/rabbitmq</span>

<span class="token comment" spellcheck="true">## Logging to file. Can be false or a filename.</span>
<span class="token comment" spellcheck="true">## Default:</span>
<span class="token comment" spellcheck="true"># log.file = rabbit.log</span>

<span class="token comment" spellcheck="true">## To disable logging to a file</span>
<span class="token comment" spellcheck="true"># log.file = false</span>

<span class="token comment" spellcheck="true">## Log level for file logging</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># log.file.level = info</span>

<span class="token comment" spellcheck="true">## File rotation config. No rotation by default.</span>
<span class="token comment" spellcheck="true">## DO NOT SET rotation date to ''. Leave the value unset if "" is the desired value</span>
<span class="token comment" spellcheck="true"># log.file.rotation.date = $D0</span>
<span class="token comment" spellcheck="true"># log.file.rotation.size = 0</span>

<span class="token comment" spellcheck="true">## Logging to console (can be true or false)</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># log.console = false</span>

<span class="token comment" spellcheck="true">## Log level for console logging</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># log.console.level = info</span>

<span class="token comment" spellcheck="true">## Logging to the amq.rabbitmq.log exchange (can be true or false)</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># log.exchange = false</span>

<span class="token comment" spellcheck="true">## Log level to use when logging to the amq.rabbitmq.log exchange</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># log.exchange.level = info</span>



<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>
<span class="token comment" spellcheck="true">## RabbitMQ LDAP Plugin</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/ldap.html.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## ----------------------------------------------------------------------------</span>

<span class="token comment" spellcheck="true"># =======================================</span>
<span class="token comment" spellcheck="true"># LDAP section</span>
<span class="token comment" spellcheck="true"># =======================================</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Connecting to the LDAP server(s)</span>
<span class="token comment" spellcheck="true">## ================================</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Specify servers to bind to. You *must* set this in order for the plugin</span>
<span class="token comment" spellcheck="true">## to work properly.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.servers.1 = your-server-name-goes-here</span>

<span class="token comment" spellcheck="true">## You can define multiple servers</span>
<span class="token comment" spellcheck="true"># auth_ldap.servers.2 = your-other-server</span>

<span class="token comment" spellcheck="true">## Connect to the LDAP server using TLS</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.use_ssl = false</span>

<span class="token comment" spellcheck="true">## Specify the LDAP port to connect to</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.port = 389</span>

<span class="token comment" spellcheck="true">## LDAP connection timeout, in milliseconds or 'infinity'</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.timeout = infinity</span>

<span class="token comment" spellcheck="true">## Or number</span>
<span class="token comment" spellcheck="true"># auth_ldap.timeout = 500</span>

<span class="token comment" spellcheck="true">## Enable logging of LDAP queries.</span>
<span class="token comment" spellcheck="true">## One of</span>
<span class="token comment" spellcheck="true">##   - false (no logging is performed)</span>
<span class="token comment" spellcheck="true">##   - true (verbose logging of the logic used by the plugin)</span>
<span class="token comment" spellcheck="true">##   - network (as true, but additionally logs LDAP network traffic)</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Defaults to false.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.log = false</span>

<span class="token comment" spellcheck="true">## Also can be true or network</span>
<span class="token comment" spellcheck="true"># auth_ldap.log = true</span>
<span class="token comment" spellcheck="true"># auth_ldap.log = network</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Authentication</span>
<span class="token comment" spellcheck="true">## ==============</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Pattern to convert the username given through AMQP to a DN before</span>
<span class="token comment" spellcheck="true">## binding</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.user_dn_pattern = cn=${username},ou=People,dc=example,dc=com</span>

<span class="token comment" spellcheck="true">## Alternatively, you can convert a username to a Distinguished</span>
<span class="token comment" spellcheck="true">## Name via an LDAP lookup after binding. See the documentation for</span>
<span class="token comment" spellcheck="true">## full details.</span>

<span class="token comment" spellcheck="true">## When converting a username to a dn via a lookup, set these to</span>
<span class="token comment" spellcheck="true">## the name of the attribute that represents the user name, and the</span>
<span class="token comment" spellcheck="true">## base DN for the lookup query.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.dn_lookup_attribute = userPrincipalName</span>
<span class="token comment" spellcheck="true"># auth_ldap.dn_lookup_base      = DC=gopivotal,DC=com</span>

<span class="token comment" spellcheck="true">## Controls how to bind for authorisation queries and also to</span>
<span class="token comment" spellcheck="true">## retrieve the details of users logging in without presenting a</span>
<span class="token comment" spellcheck="true">## password (e.g., SASL EXTERNAL).</span>
<span class="token comment" spellcheck="true">## One of</span>
<span class="token comment" spellcheck="true">##  - as_user (to bind as the authenticated user - requires a password)</span>
<span class="token comment" spellcheck="true">##  - anon    (to bind anonymously)</span>
<span class="token comment" spellcheck="true">##  - {UserDN, Password} (to bind with a specified user name and password)</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Defaults to 'as_user'.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true"># auth_ldap.other_bind = as_user</span>

<span class="token comment" spellcheck="true">## Or can be more complex:</span>
<span class="token comment" spellcheck="true"># auth_ldap.other_bind.user_dn  = User</span>
<span class="token comment" spellcheck="true"># auth_ldap.other_bind.password = Password</span>

<span class="token comment" spellcheck="true">## If user_dn and password defined - other options is ignored.</span>

<span class="token comment" spellcheck="true"># -----------------------------</span>
<span class="token comment" spellcheck="true"># Too complex section of LDAP</span>
<span class="token comment" spellcheck="true"># -----------------------------</span>

<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Authorisation</span>
<span class="token comment" spellcheck="true">## =============</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## The LDAP plugin can perform a variety of queries against your</span>
<span class="token comment" spellcheck="true">## LDAP server to determine questions of authorisation.</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## Related doc guide: https://rabbitmq.com/ldap.html#authorisation.</span>

<span class="token comment" spellcheck="true">## Following configuration should be defined in advanced.config file</span>
<span class="token comment" spellcheck="true">## DO NOT UNCOMMENT THESE LINES!</span>

<span class="token comment" spellcheck="true">## Set the query to use when determining vhost access</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## {vhost_access_query, {in_group,</span>
<span class="token comment" spellcheck="true">##                       "ou=${vhost}-users,ou=vhosts,dc=example,dc=com"}},</span>

<span class="token comment" spellcheck="true">## Set the query to use when determining resource (e.g., queue) access</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## {resource_access_query, {constant, true}},</span>

<span class="token comment" spellcheck="true">## Set queries to determine which tags a user has</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token comment" spellcheck="true">## {tag_queries, []}</span>
<span class="token comment" spellcheck="true">#   ]},</span>
<span class="token comment" spellcheck="true"># -----------------------------</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="advanced-config-example">advanced.config.example</span><a href="#advanced-config-example" class="header-anchor">.</a></h4><pre class="line-numbers language-properties"><code class="language-properties">[


<span class="token attr-name"> %%</span> <span class="token attr-value">----------------------------------------------------------------------------</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">Advanced Erlang Networking/Clustering Options.</span>
 %%
<span class="token attr-name"> %%</span> <span class="token attr-value">See https://www.rabbitmq.com/clustering.html for details</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">----------------------------------------------------------------------------</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">Sets the net_kernel tick time.</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">Please see http://erlang.org/doc/man/kernel_app.html and</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">https://www.rabbitmq.com/nettick.html for further details.</span>
 %%
<span class="token attr-name"> %%</span> <span class="token attr-value">{kernel, [{net_ticktime, 60}]},</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">----------------------------------------------------------------------------</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">RabbitMQ Shovel Plugin</span>
 %%
<span class="token attr-name"> %%</span> <span class="token attr-value">See https://www.rabbitmq.com/shovel.html for details</span>
<span class="token attr-name"> %%</span> <span class="token attr-value">----------------------------------------------------------------------------</span>

 {rabbitmq_shovel,
  [{shovels,
<span class="token attr-name">    [%%</span> <span class="token attr-value">A named shovel worker.</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">{my_first_shovel,</span>
<span class="token attr-name">     %%</span> <span class="token attr-value"> [</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">List the source broker(s) from which to consume.</span>
     %%
<span class="token attr-name">     %%</span> <span class="token attr-value">  {sources,</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">   [%% URI(s) and pre-declarations for all source broker(s).</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">    {brokers, ["amqp://user:password@host.domain/my_vhost"]},</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">    {declarations, []}</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">   ]},</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">List the destination broker(s) to publish to.</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">  {destinations,</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">   [%% A singular version of the 'brokers' element.</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">    {broker, "amqp://"},</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">    {declarations, []}</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">   ]},</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">Name of the queue to shovel messages from.</span>
     %%
<span class="token attr-name">     %%</span> <span class="token attr-value">{queue, &lt;&lt;"your-queue-name-goes-here">>},</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">Optional prefetch count.</span>
     %%
<span class="token attr-name">     %%</span> <span class="token attr-value">{prefetch_count, 10},</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">when to acknowledge messages:</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">- no_ack: never (auto)</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">- on_publish: after each message is republished</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">- on_confirm: when the destination broker confirms receipt</span>
     %%
<span class="token attr-name">     %%</span> <span class="token attr-value">{ack_mode, on_confirm},</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">Overwrite fields of the outbound basic.publish.</span>
     %%
<span class="token attr-name">     %%</span> <span class="token attr-value">{publish_fields, [{exchange,    &lt;&lt;"my_exchange">>},</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">                  {routing_key, &lt;&lt;"from_shovel">>}]},</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">Static list of basic.properties to set on re-publication.</span>
     %%
<span class="token attr-name">     %%</span> <span class="token attr-value">{publish_properties, [{delivery_mode, 2}]},</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">The number of seconds to wait before attempting to</span>
<span class="token attr-name">     %%</span> <span class="token attr-value">reconnect in the event of a connection failure.</span>
     %%
<span class="token attr-name">     %%</span> <span class="token attr-value">{reconnect_delay, 2.5}</span>

<span class="token attr-name">     %%</span> <span class="token attr-value">]} %% End of my_first_shovel</span>
    ]}
<span class="token attr-name">   %%</span> <span class="token attr-value">Rather than specifying some values per-shovel, you can specify</span>
<span class="token attr-name">   %%</span> <span class="token attr-value">them for all shovels here.</span>
   %%
<span class="token attr-name">   %%</span> <span class="token attr-value">{defaults, [{prefetch_count,     0},</span>
<span class="token attr-name">   %%</span> <span class="token attr-value">            {ack_mode,           on_confirm},</span>
<span class="token attr-name">   %%</span> <span class="token attr-value">            {publish_fields,     []},</span>
<span class="token attr-name">   %%</span> <span class="token attr-value">            {publish_properties, [{delivery_mode, 2}]},</span>
<span class="token attr-name">   %%</span> <span class="token attr-value">            {reconnect_delay,    2.5}]}</span>
  ]},

<span class="token attr-name">  {rabbitmq_auth_backend_ldap,</span> <span class="token attr-value">[</span>
    %%
<span class="token attr-name">    %%</span> <span class="token attr-value">Authorisation</span>
<span class="token attr-name">    %%</span> <span class="token punctuation">=</span><span class="token attr-value">============</span>
    %%

<span class="token attr-name">    %%</span> <span class="token attr-value">The LDAP plugin can perform a variety of queries against your</span>
<span class="token attr-name">    %%</span> <span class="token attr-value">LDAP server to determine questions of authorisation. See</span>
<span class="token attr-name">    %%</span> <span class="token attr-value">https://www.rabbitmq.com/ldap.html#authorisation for more</span>
<span class="token attr-name">    %%</span> <span class="token attr-value">information.</span>

<span class="token attr-name">    %%</span> <span class="token attr-value">Set the query to use when determining vhost access</span>
    %%
<span class="token attr-name">    %%</span> <span class="token attr-value">{vhost_access_query, {in_group,</span>
<span class="token attr-name">    %%</span> <span class="token attr-value">                      "ou=${vhost}-users,ou=vhosts,dc=example,dc=com"}},</span>

<span class="token attr-name">    %%</span> <span class="token attr-value">Set the query to use when determining resource (e.g., queue) access</span>
    %%
<span class="token attr-name">    %%</span> <span class="token attr-value">{resource_access_query, {constant, true}},</span>

<span class="token attr-name">    %%</span> <span class="token attr-value">Set queries to determine which tags a user has</span>
    %%
<span class="token attr-name">    %%</span> <span class="token attr-value">{tag_queries, []}</span>
  ]}
].<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://www.liuminkai.top" rel="external nofollow noreferrer">liuminkai</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://www.liuminkai.top/2020/12/15/61945.html">http://www.liuminkai.top/2020/12/15/61945.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="http://www.liuminkai.top" target="_blank">liuminkai</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/message-queue/">
                                    <span class="chip bg-color">message queue</span>
                                </a>
                            
                                <a href="/tags/rabbitmq/">
                                    <span class="chip bg-color">rabbitmq</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '4e04421bf007cd448eb3',
        clientSecret: '98d0aaec7d39c4c8ba7ef6118575f68eafc77951',
        repo: 'blogtalk',
        owner: 'liuminkai-blog',
        admin: ["liuminkai-blog"],
        id: '2020-12-15T00-48-12',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/12/15/1674.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/featureimages/23.jpg" class="responsive-img" alt="linux-centos7系统配置">
                        
                        <span class="card-title">linux-centos7系统配置</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
以下所有操作都是在root管理员权限下进行的

1、配置网关.vi /etc/sysconfig/network

# network内容如下：
NETWORKING=yes # 系统是否使用网络
HOSTNAME=主机名 # 主机名设置
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-12-15
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" class="post-category">
                                    使用教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/linux/">
                        <span class="chip bg-color">linux</span>
                    </a>
                    
                    <a href="/tags/centos/">
                        <span class="chip bg-color">centos</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/12/13/14729.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/featureimages/10.jpg" class="responsive-img" alt="linux开放防火墙端口">
                        
                        <span class="card-title">linux开放防火墙端口</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            https://blog.csdn.net/luchenh/article/details/106329236
https://www.jianshu.com/p/dc49ed9fbfcf
linux开放防火墙端口.查看防火墙服务状态：
#
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-12-13
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" class="post-category">
                                    使用教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/linux/">
                        <span class="chip bg-color">linux</span>
                    </a>
                    
                    <a href="/tags/firewell/">
                        <span class="chip bg-color">firewell</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->


<script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="http://www.liuminkai.top" target="_blank">liuminkai</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">287.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/kaiminliu" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:liuyou2021@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>




    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1423928650" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1423928650" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//js/matery.js"></script>

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/others/busuanzi.pure.mini.js"></script>
    

    

	
    

    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/instantpage/instantpage.js" type="module"></script>
    
	
	
	<!-- 一言API -->
	<!-- 现代写法，推荐 -->
	<!-- 兼容低版本浏览器 (包括 IE)，可移除 -->
	<script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
	<!--End-->
	<script>
	  fetch('https://v1.hitokoto.cn')
		.then(function (res){
		  return res.json();
		})
		.then(function (data) {
		  var hitokoto = document.getElementById('hitokoto');
		  hitokoto.innerText = data.hitokoto + '——【' + data.from + '】';
		})
		.catch(function (err) {
		  console.error(err);
		})
	</script>
</body>

</html>
