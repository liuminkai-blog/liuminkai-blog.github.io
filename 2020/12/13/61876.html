<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Nginx学习(入门), 刘民锴的个人博客">
    <meta name="description" content="刘民锴使用hexo和githubpages 搭建的个人博客 主要用于记录学习笔记 和 技术分享">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', '');
</script>


    <title>Nginx学习(入门) | 刘民锴的个人博客</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">刘民锴的个人博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-sticky-note" style="zoom: 0.6;"></i>
      
      <span>Essay</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">刘民锴的个人博客</div>
        <div class="logo-desc">
            
            刘民锴使用hexo和githubpages 搭建的个人博客 主要用于记录学习笔记 和 技术分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-sticky-note"></i>
			
			Essay
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/kaiminliu" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/kaiminliu" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/featureimages/2.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Nginx学习(入门)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    .toc-fixed .toc-link::before{
        position: fixed!important;/*当toc的位置改为fixed时，.toc-link::before也要改为fixed*/
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/java/">
                                <span class="chip bg-color">java</span>
                            </a>
                        
                            <a href="/tags/nginx/">
                                <span class="chip bg-color">nginx</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                学习笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-12-13
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-12-19
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    34 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2><span id="yi-nginx-jian-jie">一、Nginx简介</span><a href="#yi-nginx-jian-jie" class="header-anchor">.</a></h2><h3><span id="1-shi-me-shi-nginx">1、什么是Nginx？</span><a href="#1-shi-me-shi-nginx" class="header-anchor">.</a></h3><p><em>Nginx</em> (engine x) 是一个高性能的<a href="https://baike.baidu.com/item/HTTP" target="_blank" rel="noopener">HTTP</a>和<a href="https://baike.baidu.com/item/反向代理/7793488" target="_blank" rel="noopener">反向代理</a>web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx是由伊戈尔·赛索耶夫为<a href="https://baike.baidu.com/item/俄罗斯/125568" target="_blank" rel="noopener">俄罗斯</a>访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。</p>
<p>其将<a href="https://baike.baidu.com/item/源代码/3814213" target="_blank" rel="noopener">源代码</a>以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而<a href="https://baike.baidu.com/item/闻名/2303308" target="_blank" rel="noopener">闻名</a>。2011年6月1日，nginx 1.0.4发布。</p>
<p>Nginx是一款<a href="https://baike.baidu.com/item/轻量级/10002835" target="_blank" rel="noopener">轻量级</a>的<a href="https://baike.baidu.com/item/Web/150564" target="_blank" rel="noopener">Web</a> 服务器/<a href="https://baike.baidu.com/item/反向代理/7793488" target="_blank" rel="noopener">反向代理</a>服务器及<a href="https://baike.baidu.com/item/电子邮件/111106" target="_blank" rel="noopener">电子邮件</a>（IMAP/POP3）代理服务器，在BSD-like 协议下发行。其特点是占有内存少，<a href="https://baike.baidu.com/item/并发/11024806" target="_blank" rel="noopener">并发</a>能力强，事实上nginx的并发能力在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、<a href="https://baike.baidu.com/item/京东/210931" target="_blank" rel="noopener">京东</a>、<a href="https://baike.baidu.com/item/新浪/125692" target="_blank" rel="noopener">新浪</a>、<a href="https://baike.baidu.com/item/网易/185754" target="_blank" rel="noopener">网易</a>、<a href="https://baike.baidu.com/item/腾讯/112204" target="_blank" rel="noopener">腾讯</a>、<a href="https://baike.baidu.com/item/淘宝/145661" target="_blank" rel="noopener">淘宝</a>等。</p>
<p>Nginx,可以作为静态页面的web服务器，同时还支持CGI协议的动态语言，比如perl、php等。但是不支持 java。Java程序只能通过与tomcat配合完成。Nginx.专为性能优化而开发，性能是其最重要的考量,实现上非常注重效率，能经受高负载的考验,有报告表明能支持高达50,000个并发连接数。</p>
<ul>
<li>反向代理</li>
<li>负载均衡</li>
<li>动静分离</li>
<li>高可用</li>
</ul>
<p>占内存小，可以实现高并发连接、处理响应快。<br>可以实现http服务器、虚拟主机、反向代理、负载均衡。<br>nginx配置简单<br>可以不暴露真实服务器IP地址</p>
<h3><span id="2-fan-xiang-dai-li">2、反向代理</span><a href="#2-fan-xiang-dai-li" class="header-anchor">.</a></h3><p><strong>正向代理：</strong></p>
<p>Nginx,.不仅可以做反向代理，实现负载均衡。还能用作正向代理来进行上网等功能。,正向代理:如果把局域网外的 Intemet想象成一个巨大的资源库，则局域网中的客户端要访问Internet，则需要通过代理服务器来访问，这种代理服务就称为正向代理。-</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213112450.png" alt="正向代理：在客户端（浏览器）配置代理服务器，通过代理服务器访问互联网的过程"></p>
<p><strong>反向代理：</strong></p>
<p>反向代理，其实客户端对代理是无感知的，因为客户端不需要任何配置就可以访问，我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据后，在返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器，暴露的是代理服务器地址，隐藏了真实服务器P地址。</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213112450.png" alt></p>
<h3><span id="3-fu-zai-jun-heng">3、负载均衡</span><a href="#3-fu-zai-jun-heng" class="header-anchor">.</a></h3><p>在大量并发访问情况下，传统单机应用存在性能问题，满足不了日常需求，为此我们可以采用 纵向扩展（升级配置）和横向扩展（廉价集群）的方式高并发问题。但是仅增加升级配置（即使是顶级配置）也无法满足我们日益增长的需求，为此使用横向扩展更加符合实际情况。</p>
<p><mark>单个服务器无法承载高并发量，如果我们增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器</mark>，该过程：负载均衡</p>
<p><img src="/2020/12/13/61876/image-20201213161311339.png" alt></p>
<h3><span id="4-dong-jing-fen-chi">4、动静分离</span><a href="#4-dong-jing-fen-chi" class="header-anchor">.</a></h3><p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。</p>
<p>Nginx动静分离简单来说就是把<strong>动态跟静态请求分开</strong>,不能理解成只是单纯的把动态页面和静态页面物理分离。严格意义上说应该是动态请求跟静态请求分开，可以理解成<strong>使用Nginx处理静态页面</strong>，<strong>Tomcat 处理动态页面</strong>。动静分离从目前实现角度来讲大致分为两种，</p>
<ul>
<li>一种是纯粹把静态文件独立成单独的域名,放在独立的服务器上,也是目前主流推崇的方案;</li>
<li>另外一种方法就是动态跟静态文件混合在一起发布，通过nginx来分开。·</li>
</ul>
<p>通过location指定不同的后缀名实现不同的请求转发。通过expires参数设置，可以使浏览器缓存过期时间，减少与服务器之前的请求和流量。具体Expires定义:是给一个资源设定一个过期时间,也就是说无需去服务端验证,直接通过浏览器自身确认是否过期即可，所以不会产生额外的流量。此种方法非常适合不经常变动的资源。(如果经常更新的文件，不建议使用Expires来缓存〉，我这里设置3d，表示在这3天之内访问这个URL，发送一个请求，比对服务器该文件最后更新时间没有变化，则不会从服务器抓取，返回状态码304，如果有修改，则直接从服务器重新下载，返回状态码 200。,</p>
<p><img src="/2020/12/13/61876/image-20201213170241881.png" alt="第一种"></p>
<h3><span id="5-gao-ke-yong">5、高可用</span><a href="#5-gao-ke-yong" class="header-anchor">.</a></h3><p><img src="/2020/12/13/61876/image-20201213173732189.png" alt></p>
<ul>
<li>需要两台或以上nginx服务器（两台linux设备）</li>
<li>需要keepalived</li>
<li>需要一个虚拟ip</li>
</ul>
<h2><span id="er-nginx-an-zhuang">二、nginx安装</span><a href="#er-nginx-an-zhuang" class="header-anchor">.</a></h2><h3><span id="1-xia-zai">1、下载</span><a href="#1-xia-zai" class="header-anchor">.</a></h3><p>下载地址：<a href="https://nginx.org/en/download.html" target="_blank" rel="noopener">https://nginx.org/en/download.html</a></p>
<p>下载稳定版即可</p>
<p><strong>安装之前需要的依赖：</strong></p>
<ul>
<li>pcre</li>
<li>openssl</li>
<li>zlib</li>
</ul>
<h3><span id="2-an-zhuang-bu-zou">2、安装步骤</span><a href="#2-an-zhuang-bu-zou" class="header-anchor">.</a></h3><h4><span id="shi-yong-xftp6-shang-chuan-nginx-ya-suo-bao-dao-linux-she-bei-shang">①使用xftp6上传 nginx压缩包到linux设备上</span><a href="#shi-yong-xftp6-shang-chuan-nginx-ya-suo-bao-dao-linux-she-bei-shang" class="header-anchor">.</a></h4><p><code>存放在/app目录下</code></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213112502.png" alt></p>
<h4><span id="an-zhuang-bu-zou">②安装步骤</span><a href="#an-zhuang-bu-zou" class="header-anchor">.</a></h4><pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> 进入安装目录</span>
cd /usr/local
mkdir nginx
cd nginx

<span class="token title important"><span class="token punctuation">#</span> 安装依赖</span>
yum -y install gcc gcc-c++ make libtool
yum -y install zlib zlib-devel pcre-devel openssl openssl-devel

<span class="token title important"><span class="token punctuation">#</span> 解压</span>
tar -zxvf /app/nginx-1.18.0.tar.gz -C /usr/local/nginx

<span class="token title important"><span class="token punctuation">#</span> 安装</span>
cd /usr/local/nginx/nginx-1.18.0
./configure
make &amp;&amp; make install

<span class="token title important"><span class="token punctuation">#</span> 启动</span>
cd /usr/local/nginx/sbin
./nginx

<span class="token title important"><span class="token punctuation">#</span> 查看启动情况</span>
ps -ef | grep nginx
<span class="token code keyword">    # 启动了两个进程</span>
<span class="token code keyword">    root nginx: master process ./nginx</span>
<span class="token code keyword">    nobody nginx: worker process</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="fang-wen-nginx">③访问nginx</span><a href="#fang-wen-nginx" class="header-anchor">.</a></h4><blockquote>
<p>如果有防火墙，需要开放80端口，<a href="https://blog.csdn.net/luchenh/article/details/106329236" target="_blank" rel="noopener">https://blog.csdn.net/luchenh/article/details/106329236</a></p>
</blockquote>
<p>浏览器地址栏：linux设备ip地址:80（或 linux设备ip地址），如 192.168.188.199:80</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213115405.png" alt></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213115617.png" alt></p>
<h2><span id="san-pei-zhi-wen-jian">三、配置文件</span><a href="#san-pei-zhi-wen-jian" class="header-anchor">.</a></h2><p><strong>打开配置文件：</strong></p>
<pre class="line-numbers language-markdown"><code class="language-markdown">cd /usr/local/nginx/conf
vim nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h4><span id="wen-jian-nei-rong-jie-xi">文件内容解析：</span><a href="#wen-jian-nei-rong-jie-xi" class="header-anchor">.</a></h4><p>nginx配置文件由三部分组成：</p>
<ul>
<li><p><code>nginx全局块</code></p>
<ul>
<li>从配置文件开始到events块之间内容：用于设置影响nginx服务器运行的配置指令    <ul>
<li>nginx的用户及用户组</li>
<li>允许生成的worker process数</li>
<li>进程PID存放路径、日志存放路径</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li><p><code>events块</code></p>
<ul>
<li>events大括号包含的内容：用于设置niginx服务器与用户的网络连接<ul>
<li>worker_connections 1024；支持最大的连接数</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li><p><code>http块</code><strong>(反向代理、动静分离、负载均衡、高可用)</strong></p>
<ul>
<li><p><strong><mark>http块中可以有多个server块</mark></strong></p>
</li>
<li><p><code>http全局块</code></p>
<ul>
<li>文件引入</li>
<li>MIME-TYPE定义</li>
<li>日志自定义</li>
<li>连接超时时间</li>
<li>单链接请求上限</li>
<li>…</li>
</ul>
</li>
<li><p><code>server块</code><strong>（虚拟主机）</strong></p>
<ul>
<li><p><strong><mark>server块中可以有多个location块</mark></strong></p>
</li>
<li><p><code>server全局块</code></p>
</li>
<li><p><code>location块</code></p>
<ul>
<li><p>location详解：<a href="https://www.cnblogs.com/cangqinglang/p/9173565.html" target="_blank" rel="noopener">https://www.cnblogs.com/cangqinglang/p/9173565.html</a></p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">location</span> <span class="token attr-value">[ = | ~ | ~* | ^~ ] uri {}</span>
<span class="token comment" spellcheck="true"># 1、=: 用于不含正则表达式的uri前，要求请求字符串与uri严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求。</span>
<span class="token comment" spellcheck="true"># 2、~: 用于表示 uri包含正则表达式，并且区分大小写。</span>
<span class="token comment" spellcheck="true"># 3、~*: 用于表示uri包含证则表达式，并且不区分大小写。</span>
<span class="token comment" spellcheck="true"># 4、^~: 用于不含正则表达式的uri前，要求 Nginx服务器找到标识uri和请求字符串匹配度最高的location后，立即使用此 location 处理请求，而不再使用location块中的正则uri和请求字符串做匹配。</span>

<span class="token attr-name">注意</span><span class="token punctuation">:</span><span class="token attr-value">如果uri包含正则表达式，则必须要有~或者~*标识。.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>原始完整nginx.conf:</strong></p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#user  nobody;</span>
<span class="token attr-name">worker_processes</span> <span class="token attr-value"> 1;</span>

<span class="token comment" spellcheck="true">#error_log  logs/error.log;</span>
<span class="token comment" spellcheck="true">#error_log  logs/error.log  notice;</span>
<span class="token comment" spellcheck="true">#error_log  logs/error.log  info;</span>

<span class="token comment" spellcheck="true">#pid        logs/nginx.pid;</span>


<span class="token attr-name">events</span> <span class="token attr-value">{</span>
<span class="token attr-name">    worker_connections</span> <span class="token attr-value"> 1024;</span>
}


<span class="token attr-name">http</span> <span class="token attr-value">{</span>
<span class="token attr-name">    include</span> <span class="token attr-value">      mime.types;</span>
<span class="token attr-name">    default_type</span> <span class="token attr-value"> application/octet-stream;</span>

<span class="token comment" spellcheck="true">    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span>
<span class="token comment" spellcheck="true">    #                  '$status $body_bytes_sent "$http_referer" '</span>
<span class="token comment" spellcheck="true">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</span>

<span class="token comment" spellcheck="true">    #access_log  logs/access.log  main;</span>

<span class="token attr-name">    sendfile</span> <span class="token attr-value">       on;</span>
<span class="token comment" spellcheck="true">    #tcp_nopush     on;</span>

<span class="token comment" spellcheck="true">    #keepalive_timeout  0;</span>
<span class="token attr-name">    keepalive_timeout</span> <span class="token attr-value"> 65;</span>

<span class="token comment" spellcheck="true">    #gzip  on;</span>

<span class="token attr-name">    server</span> <span class="token attr-value">{</span>
<span class="token attr-name">        listen</span> <span class="token attr-value">      80;</span>
<span class="token attr-name">        server_name</span> <span class="token attr-value"> localhost;</span>

<span class="token comment" spellcheck="true">        #charset koi8-r;</span>

<span class="token comment" spellcheck="true">        #access_log  logs/host.access.log  main;</span>

<span class="token attr-name">        location</span> <span class="token attr-value">/ {</span>
<span class="token attr-name">            root</span> <span class="token attr-value">  html;</span>
<span class="token attr-name">            index</span> <span class="token attr-value"> index.html index.htm;</span>
        }

<span class="token comment" spellcheck="true">        #error_page  404              /404.html;</span>

<span class="token comment" spellcheck="true">        # redirect server error pages to the static page /50x.html</span>
<span class="token comment" spellcheck="true">        #</span>
<span class="token attr-name">        error_page</span> <span class="token attr-value">  500 502 503 504  /50x.html;</span>
<span class="token attr-name">        location</span> <span class="token punctuation">=</span> <span class="token attr-value">/50x.html {</span>
<span class="token attr-name">            root</span> <span class="token attr-value">  html;</span>
        }

<span class="token comment" spellcheck="true">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span>
<span class="token comment" spellcheck="true">        #</span>
<span class="token comment" spellcheck="true">        #location ~ \.php$ {</span>
<span class="token comment" spellcheck="true">        #    proxy_pass   http://127.0.0.1;</span>
<span class="token comment" spellcheck="true">        #}</span>

<span class="token comment" spellcheck="true">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span>
<span class="token comment" spellcheck="true">        #</span>
<span class="token comment" spellcheck="true">        #location ~ \.php$ {</span>
<span class="token comment" spellcheck="true">        #    root           html;</span>
<span class="token comment" spellcheck="true">        #    fastcgi_pass   127.0.0.1:9000;</span>
<span class="token comment" spellcheck="true">        #    fastcgi_index  index.php;</span>
<span class="token comment" spellcheck="true">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span>
<span class="token comment" spellcheck="true">        #    include        fastcgi_params;</span>
<span class="token comment" spellcheck="true">        #}</span>

<span class="token comment" spellcheck="true">        # deny access to .htaccess files, if Apache's document root</span>
<span class="token comment" spellcheck="true">        # concurs with nginx's one</span>
<span class="token comment" spellcheck="true">        #</span>
<span class="token comment" spellcheck="true">        #location ~ /\.ht {</span>
<span class="token comment" spellcheck="true">        #    deny  all;</span>
<span class="token comment" spellcheck="true">        #}</span>
    }


<span class="token comment" spellcheck="true">    # another virtual host using mix of IP-, name-, and port-based configuration</span>
<span class="token comment" spellcheck="true">    #</span>
<span class="token comment" spellcheck="true">    #server {</span>
<span class="token comment" spellcheck="true">    #    listen       8000;</span>
<span class="token comment" spellcheck="true">    #    listen       somename:8080;</span>
<span class="token comment" spellcheck="true">    #    server_name  somename  alias  another.alias;</span>

<span class="token comment" spellcheck="true">    #    location / {</span>
<span class="token comment" spellcheck="true">    #        root   html;</span>
<span class="token comment" spellcheck="true">    #        index  index.html index.htm;</span>
<span class="token comment" spellcheck="true">    #    }</span>
<span class="token comment" spellcheck="true">    #}</span>


<span class="token comment" spellcheck="true">    # HTTPS server</span>
<span class="token comment" spellcheck="true">    #</span>
<span class="token comment" spellcheck="true">    #server {</span>
<span class="token comment" spellcheck="true">    #    listen       443 ssl;</span>
<span class="token comment" spellcheck="true">    #    server_name  localhost;</span>

<span class="token comment" spellcheck="true">    #    ssl_certificate      cert.pem;</span>
<span class="token comment" spellcheck="true">    #    ssl_certificate_key  cert.key;</span>

<span class="token comment" spellcheck="true">    #    ssl_session_cache    shared:SSL:1m;</span>
<span class="token comment" spellcheck="true">    #    ssl_session_timeout  5m;</span>

<span class="token comment" spellcheck="true">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</span>
<span class="token comment" spellcheck="true">    #    ssl_prefer_server_ciphers  on;</span>

<span class="token comment" spellcheck="true">    #    location / {</span>
<span class="token comment" spellcheck="true">    #        root   html;</span>
<span class="token comment" spellcheck="true">    #        index  index.html index.htm;</span>
<span class="token comment" spellcheck="true">    #    }</span>
<span class="token comment" spellcheck="true">    #}</span>

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Nginx配置文件nginx.conf中文详解：</strong></p>
<p>以下内容来自：<a href="https://www.cnblogs.com/paulwhw/articles/11116363.html" target="_blank" rel="noopener">https://www.cnblogs.com/paulwhw/articles/11116363.html</a></p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">######Nginx配置文件nginx.conf中文详解#####</span>

<span class="token comment" spellcheck="true">#定义Nginx运行的用户和用户组</span>
<span class="token attr-name">user</span> <span class="token attr-value">www www;</span>

<span class="token comment" spellcheck="true">#nginx进程数，建议设置为等于CPU总核心数。</span>
<span class="token attr-name">worker_processes</span> <span class="token attr-value">8;</span>

<span class="token comment" spellcheck="true">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</span>
<span class="token attr-name">error_log</span> <span class="token attr-value">/usr/local/nginx/logs/error.log info;</span>

<span class="token comment" spellcheck="true">#进程pid文件</span>
<span class="token attr-name">pid</span> <span class="token attr-value">/usr/local/nginx/logs/nginx.pid;</span>

<span class="token comment" spellcheck="true">#指定进程可以打开的最大描述符：数目</span>
<span class="token comment" spellcheck="true">#工作模式与连接数上限</span>
<span class="token comment" spellcheck="true">#这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx分配请求并不是那么均匀，所以最好与ulimit -n 的值保持一致。</span>
<span class="token comment" spellcheck="true">#现在在linux 2.6内核下开启文件打开数为65535，worker_rlimit_nofile就相应应该填写65535。</span>
<span class="token comment" spellcheck="true">#这是因为nginx调度时分配请求到进程并不是那么的均衡，所以假如填写10240，总并发量达到3-4万时就有进程可能超过10240了，这时会返回502错误。</span>
<span class="token attr-name">worker_rlimit_nofile</span> <span class="token attr-value">65535;</span>


events
{
<span class="token comment" spellcheck="true">    #参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll模型</span>
<span class="token comment" spellcheck="true">    #是Linux 2.6以上版本内核中的高性能网络I/O模型，linux建议epoll，如果跑在FreeBSD上面，就用kqueue模型。</span>
<span class="token comment" spellcheck="true">    #补充说明：</span>
<span class="token comment" spellcheck="true">    #与apache相类，nginx针对不同的操作系统，有不同的事件模型</span>
<span class="token comment" spellcheck="true">    #A）标准事件模型</span>
<span class="token comment" spellcheck="true">    #Select、poll属于标准事件模型，如果当前系统不存在更有效的方法，nginx会选择select或poll</span>
<span class="token comment" spellcheck="true">    #B）高效事件模型</span>
<span class="token comment" spellcheck="true">    #Kqueue：使用于FreeBSD 4.1+, OpenBSD 2.9+, NetBSD 2.0 和 MacOS X.使用双处理器的MacOS X系统使用kqueue可能会造成内核崩溃。</span>
<span class="token comment" spellcheck="true">    #Epoll：使用于Linux内核2.6版本及以后的系统。</span>
<span class="token comment" spellcheck="true">    #/dev/poll：使用于Solaris 7 11/99+，HP/UX 11.22+ (eventport)，IRIX 6.5.15+ 和 Tru64 UNIX 5.1A+。</span>
<span class="token comment" spellcheck="true">    #Eventport：使用于Solaris 10。 为了防止出现内核崩溃的问题， 有必要安装安全补丁。</span>
<span class="token attr-name">    use</span> <span class="token attr-value">epoll;</span>

<span class="token comment" spellcheck="true">    #单个进程最大连接数（最大连接数=连接数*进程数）</span>
<span class="token comment" spellcheck="true">    #根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到100%就行。每个进程允许的最多连接数，理论上每台nginx服务器的最大连接数为。</span>
<span class="token attr-name">    worker_connections</span> <span class="token attr-value">65535;</span>

<span class="token comment" spellcheck="true">    #keepalive超时时间。</span>
<span class="token attr-name">    keepalive_timeout</span> <span class="token attr-value">60;</span>

<span class="token comment" spellcheck="true">    #客户端请求头部的缓冲区大小。这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。</span>
<span class="token comment" spellcheck="true">    #分页大小可以用命令getconf PAGESIZE 取得。</span>
<span class="token comment" spellcheck="true">    #[root@web001 ~]# getconf PAGESIZE</span>
<span class="token comment" spellcheck="true">    #4096</span>
<span class="token comment" spellcheck="true">    #但也有client_header_buffer_size超过4k的情况，但是client_header_buffer_size该值必须设置为“系统分页大小”的整倍数。</span>
<span class="token attr-name">    client_header_buffer_size</span> <span class="token attr-value">4k;</span>

<span class="token comment" spellcheck="true">    #这个将为打开文件指定缓存，默认是没有启用的，max指定缓存数量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删除缓存。</span>
<span class="token attr-name">    open_file_cache</span> <span class="token attr-value">max=65535 inactive=60s;</span>

<span class="token comment" spellcheck="true">    #这个是指多长时间检查一次缓存的有效信息。</span>
<span class="token comment" spellcheck="true">    #语法:open_file_cache_valid time 默认值:open_file_cache_valid 60 使用字段:http, server, location 这个指令指定了何时需要检查open_file_cache中缓存项目的有效信息.</span>
<span class="token attr-name">    open_file_cache_valid</span> <span class="token attr-value">80s;</span>

<span class="token comment" spellcheck="true">    #open_file_cache指令中的inactive参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive时间内一次没被使用，它将被移除。</span>
<span class="token comment" spellcheck="true">    #语法:open_file_cache_min_uses number 默认值:open_file_cache_min_uses 1 使用字段:http, server, location  这个指令指定了在open_file_cache指令无效的参数中一定的时间范围内可以使用的最小文件数,如果使用更大的值,文件描述符在cache中总是打开状态.</span>
<span class="token attr-name">    open_file_cache_min_uses</span> <span class="token attr-value">1;</span>

<span class="token comment" spellcheck="true">    #语法:open_file_cache_errors on | off 默认值:open_file_cache_errors off 使用字段:http, server, location 这个指令指定是否在搜索一个文件是记录cache错误.</span>
<span class="token attr-name">    open_file_cache_errors</span> <span class="token attr-value">on;</span>
}



<span class="token comment" spellcheck="true">#设定http服务器，利用它的反向代理功能提供负载均衡支持</span>
http
{
<span class="token comment" spellcheck="true">    #文件扩展名与文件类型映射表</span>
<span class="token attr-name">    include</span> <span class="token attr-value">mime.types;</span>

<span class="token comment" spellcheck="true">    #默认文件类型</span>
<span class="token attr-name">    default_type</span> <span class="token attr-value">application/octet-stream;</span>

<span class="token comment" spellcheck="true">    #默认编码</span>
<span class="token comment" spellcheck="true">    #charset utf-8;</span>

<span class="token comment" spellcheck="true">    #服务器名字的hash表大小</span>
<span class="token comment" spellcheck="true">    #保存服务器名字的hash表是由指令server_names_hash_max_size 和server_names_hash_bucket_size所控制的。参数hash bucket size总是等于hash表的大小，并且是一路处理器缓存大小的倍数。在减少了在内存中的存取次数后，使在处理器中加速查找hash表键值成为可能。如果hash bucket size等于一路处理器缓存的大小，那么在查找键的时候，最坏的情况下在内存中查找的次数为2。第一次是确定存储单元的地址，第二次是在存储单元中查找键 值。因此，如果Nginx给出需要增大hash max size 或 hash bucket size的提示，那么首要的是增大前一个参数的大小.</span>
<span class="token attr-name">    server_names_hash_bucket_size</span> <span class="token attr-value">128;</span>

<span class="token comment" spellcheck="true">    #客户端请求头部的缓冲区大小。这个可以根据你的系统分页大小来设置，一般一个请求的头部大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。分页大小可以用命令getconf PAGESIZE取得。</span>
<span class="token attr-name">    client_header_buffer_size</span> <span class="token attr-value">32k;</span>

<span class="token comment" spellcheck="true">    #客户请求头缓冲大小。nginx默认会用client_header_buffer_size这个buffer来读取header值，如果header过大，它会使用large_client_header_buffers来读取。</span>
<span class="token attr-name">    large_client_header_buffers</span> <span class="token attr-value">4 64k;</span>

<span class="token comment" spellcheck="true">    #设定通过nginx上传文件的大小</span>
<span class="token attr-name">    client_max_body_size</span> <span class="token attr-value">8m;</span>

<span class="token comment" spellcheck="true">    #开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。</span>
<span class="token comment" spellcheck="true">    #sendfile指令指定 nginx 是否调用sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为on。如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络IO处理速度，降低系统uptime。</span>
<span class="token attr-name">    sendfile</span> <span class="token attr-value">on;</span>

<span class="token comment" spellcheck="true">    #开启目录列表访问，合适下载服务器，默认关闭。</span>
<span class="token attr-name">    autoindex</span> <span class="token attr-value">on;</span>

<span class="token comment" spellcheck="true">    #此选项允许或禁止使用socke的TCP_CORK的选项，此选项仅在使用sendfile的时候使用</span>
<span class="token attr-name">    tcp_nopush</span> <span class="token attr-value">on;</span>

<span class="token attr-name">    tcp_nodelay</span> <span class="token attr-value">on;</span>

<span class="token comment" spellcheck="true">    #长连接超时时间，单位是秒</span>
<span class="token attr-name">    keepalive_timeout</span> <span class="token attr-value">120;</span>

<span class="token comment" spellcheck="true">    #FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解。</span>
<span class="token attr-name">    fastcgi_connect_timeout</span> <span class="token attr-value">300;</span>
<span class="token attr-name">    fastcgi_send_timeout</span> <span class="token attr-value">300;</span>
<span class="token attr-name">    fastcgi_read_timeout</span> <span class="token attr-value">300;</span>
<span class="token attr-name">    fastcgi_buffer_size</span> <span class="token attr-value">64k;</span>
<span class="token attr-name">    fastcgi_buffers</span> <span class="token attr-value">4 64k;</span>
<span class="token attr-name">    fastcgi_busy_buffers_size</span> <span class="token attr-value">128k;</span>
<span class="token attr-name">    fastcgi_temp_file_write_size</span> <span class="token attr-value">128k;</span>

<span class="token comment" spellcheck="true">    #gzip模块设置</span>
<span class="token attr-name">    gzip</span> <span class="token attr-value">on; #开启gzip压缩输出</span>
<span class="token attr-name">    gzip_min_length</span> <span class="token attr-value">1k;    #最小压缩文件大小</span>
<span class="token attr-name">    gzip_buffers</span> <span class="token attr-value">4 16k;    #压缩缓冲区</span>
<span class="token attr-name">    gzip_http_version</span> <span class="token attr-value">1.0;    #压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span>
<span class="token attr-name">    gzip_comp_level</span> <span class="token attr-value">2;    #压缩等级</span>
<span class="token attr-name">    gzip_types</span> <span class="token attr-value">text/plain application/x-javascript text/css application/xml;    #压缩类型，默认就已经包含textml，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。</span>
<span class="token attr-name">    gzip_vary</span> <span class="token attr-value">on;</span>

<span class="token comment" spellcheck="true">    #开启限制IP连接数的时候需要使用</span>
<span class="token comment" spellcheck="true">    #limit_zone crawler $binary_remote_addr 10m;</span>



<span class="token comment" spellcheck="true">    #负载均衡配置</span>
<span class="token attr-name">    upstream</span> <span class="token attr-value">jh.w3cschool.cn {</span>

<span class="token comment" spellcheck="true">        #upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span>
<span class="token attr-name">        server</span> <span class="token attr-value">192.168.80.121:80 weight=3;</span>
<span class="token attr-name">        server</span> <span class="token attr-value">192.168.80.122:80 weight=2;</span>
<span class="token attr-name">        server</span> <span class="token attr-value">192.168.80.123:80 weight=3;</span>

<span class="token comment" spellcheck="true">        #nginx的upstream目前支持4种方式的分配</span>
<span class="token comment" spellcheck="true">        #1、轮询（默认）</span>
<span class="token comment" spellcheck="true">        #每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</span>
<span class="token comment" spellcheck="true">        #2、weight</span>
<span class="token comment" spellcheck="true">        #指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</span>
<span class="token comment" spellcheck="true">        #例如：</span>
<span class="token comment" spellcheck="true">        #upstream bakend {</span>
<span class="token comment" spellcheck="true">        #    server 192.168.0.14 weight=10;</span>
<span class="token comment" spellcheck="true">        #    server 192.168.0.15 weight=10;</span>
<span class="token comment" spellcheck="true">        #}</span>
<span class="token comment" spellcheck="true">        #2、ip_hash</span>
<span class="token comment" spellcheck="true">        #每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</span>
<span class="token comment" spellcheck="true">        #例如：</span>
<span class="token comment" spellcheck="true">        #upstream bakend {</span>
<span class="token comment" spellcheck="true">        #    ip_hash;</span>
<span class="token comment" spellcheck="true">        #    server 192.168.0.14:88;</span>
<span class="token comment" spellcheck="true">        #    server 192.168.0.15:80;</span>
<span class="token comment" spellcheck="true">        #}</span>
<span class="token comment" spellcheck="true">        #3、fair（第三方）</span>
<span class="token comment" spellcheck="true">        #按后端服务器的响应时间来分配请求，响应时间短的优先分配。</span>
<span class="token comment" spellcheck="true">        #upstream backend {</span>
<span class="token comment" spellcheck="true">        #    server server1;</span>
<span class="token comment" spellcheck="true">        #    server server2;</span>
<span class="token comment" spellcheck="true">        #    fair;</span>
<span class="token comment" spellcheck="true">        #}</span>
<span class="token comment" spellcheck="true">        #4、url_hash（第三方）</span>
<span class="token comment" spellcheck="true">        #按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。</span>
<span class="token comment" spellcheck="true">        #例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法</span>
<span class="token comment" spellcheck="true">        #upstream backend {</span>
<span class="token comment" spellcheck="true">        #    server squid1:3128;</span>
<span class="token comment" spellcheck="true">        #    server squid2:3128;</span>
<span class="token comment" spellcheck="true">        #    hash $request_uri;</span>
<span class="token comment" spellcheck="true">        #    hash_method crc32;</span>
<span class="token comment" spellcheck="true">        #}</span>

<span class="token comment" spellcheck="true">        #tips:</span>
<span class="token comment" spellcheck="true">        #upstream bakend</span>
<span class="token comment" spellcheck="true">        #在需要使用负载均衡的server中增加 proxy_pass http://bakend/;</span>

<span class="token comment" spellcheck="true">        #每个设备的状态设置为:</span>
<span class="token comment" spellcheck="true">        #1.down表示单前的server暂时不参与负载</span>
<span class="token comment" spellcheck="true">        #2.weight为weight越大，负载的权重就越大。</span>
<span class="token comment" spellcheck="true">        #3.max_fails：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream模块定义的错误</span>
<span class="token comment" spellcheck="true">        #4.fail_timeout:max_fails次失败后，暂停的时间。</span>
<span class="token comment" spellcheck="true">        #5.backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</span>

<span class="token comment" spellcheck="true">        #nginx支持同时设置多组的负载均衡，用来给不用的server来使用。</span>
<span class="token comment" spellcheck="true">        #client_body_in_file_only设置为On 可以讲client post过来的数据记录到文件中用来做debug</span>
<span class="token comment" spellcheck="true">        #client_body_temp_path设置记录文件的目录 可以设置最多3层目录</span>
<span class="token comment" spellcheck="true">        #location对URL进行匹配.可以进行重定向或者进行新的代理 负载均衡</span>
    }



<span class="token comment" spellcheck="true">    #虚拟主机的配置</span>
    server
    {
<span class="token comment" spellcheck="true">        #监听端口</span>
<span class="token attr-name">        listen</span> <span class="token attr-value">80;</span>

<span class="token comment" spellcheck="true">        #域名可以有多个，用空格隔开</span>
<span class="token attr-name">        server_name</span> <span class="token attr-value">www.w3cschool.cn w3cschool.cn;</span>
<span class="token attr-name">        index</span> <span class="token attr-value">index.html index.htm index.php;</span>
<span class="token attr-name">        root</span> <span class="token attr-value">/data/www/w3cschool;</span>

<span class="token comment" spellcheck="true">        #对******进行负载均衡</span>
<span class="token attr-name">        location</span> <span class="token attr-value">~ .*.(php|php5)?$</span>
        {
<span class="token attr-name">            fastcgi_pass</span> <span class="token attr-value">127.0.0.1:9000;</span>
<span class="token attr-name">            fastcgi_index</span> <span class="token attr-value">index.php;</span>
<span class="token attr-name">            include</span> <span class="token attr-value">fastcgi.conf;</span>
        }

<span class="token comment" spellcheck="true">        #图片缓存时间设置</span>
<span class="token attr-name">        location</span> <span class="token attr-value">~ .*.(gif|jpg|jpeg|png|bmp|swf)$</span>
        {
<span class="token attr-name">            expires</span> <span class="token attr-value">10d;</span>
        }

<span class="token comment" spellcheck="true">        #JS和CSS缓存时间设置</span>
<span class="token attr-name">        location</span> <span class="token attr-value">~ .*.(js|css)?$</span>
        {
<span class="token attr-name">            expires</span> <span class="token attr-value">1h;</span>
        }

<span class="token comment" spellcheck="true">        #日志格式设定</span>
<span class="token comment" spellcheck="true">        #$remote_addr与$http_x_forwarded_for用以记录客户端的ip地址；</span>
<span class="token comment" spellcheck="true">        #$remote_user：用来记录客户端用户名称；</span>
<span class="token comment" spellcheck="true">        #$time_local： 用来记录访问时间与时区；</span>
<span class="token comment" spellcheck="true">        #$request： 用来记录请求的url与http协议；</span>
<span class="token comment" spellcheck="true">        #$status： 用来记录请求状态；成功是200，</span>
<span class="token comment" spellcheck="true">        #$body_bytes_sent ：记录发送给客户端文件主体内容大小；</span>
<span class="token comment" spellcheck="true">        #$http_referer：用来记录从那个页面链接访问过来的；</span>
<span class="token comment" spellcheck="true">        #$http_user_agent：记录客户浏览器的相关信息；</span>
<span class="token comment" spellcheck="true">        #通常web服务器放在反向代理的后面，这样就不能获取到客户的IP地址了，通过$remote_add拿到的IP地址是反向代理服务器的iP地址。反向代理服务器在转发请求的http头信息中，可以增加x_forwarded_for信息，用以记录原有客户端的IP地址和原来客户端的请求的服务器地址。</span>
<span class="token attr-name">        log_format</span> <span class="token attr-value">access '$remote_addr - $remote_user [$time_local] "$request" '</span>
<span class="token attr-name">        '$status</span> <span class="token attr-value">$body_bytes_sent "$http_referer" '</span>
<span class="token attr-name">        '"$http_user_agent"</span> <span class="token attr-value">$http_x_forwarded_for';</span>

<span class="token comment" spellcheck="true">        #定义本虚拟主机的访问日志</span>
<span class="token attr-name">        access_log</span> <span class="token attr-value"> /usr/local/nginx/logs/host.access.log  main;</span>
<span class="token attr-name">        access_log</span> <span class="token attr-value"> /usr/local/nginx/logs/host.access.404.log  log404;</span>

<span class="token comment" spellcheck="true">        #对 "/" 启用反向代理</span>
<span class="token attr-name">        location</span> <span class="token attr-value">/ {</span>
<span class="token attr-name">            proxy_pass</span> <span class="token attr-value">http://127.0.0.1:88;</span>
<span class="token attr-name">            proxy_redirect</span> <span class="token attr-value">off;</span>
<span class="token attr-name">            proxy_set_header</span> <span class="token attr-value">X-Real-IP $remote_addr;</span>

<span class="token comment" spellcheck="true">            #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span>
<span class="token attr-name">            proxy_set_header</span> <span class="token attr-value">X-Forwarded-For $proxy_add_x_forwarded_for;</span>

<span class="token comment" spellcheck="true">            #以下是一些反向代理的配置，可选。</span>
<span class="token attr-name">            proxy_set_header</span> <span class="token attr-value">Host $host;</span>

<span class="token comment" spellcheck="true">            #允许客户端请求的最大单文件字节数</span>
<span class="token attr-name">            client_max_body_size</span> <span class="token attr-value">10m;</span>

<span class="token comment" spellcheck="true">            #缓冲区代理缓冲用户端请求的最大字节数，</span>
<span class="token comment" spellcheck="true">            #如果把它设置为比较大的数值，例如256k，那么，无论使用firefox还是IE浏览器，来提交任意小于256k的图片，都很正常。如果注释该指令，使用默认的client_body_buffer_size设置，也就是操作系统页面大小的两倍，8k或者16k，问题就出现了。</span>
<span class="token comment" spellcheck="true">            #无论使用firefox4.0还是IE8.0，提交一个比较大，200k左右的图片，都返回500 Internal Server Error错误</span>
<span class="token attr-name">            client_body_buffer_size</span> <span class="token attr-value">128k;</span>

<span class="token comment" spellcheck="true">            #表示使nginx阻止HTTP应答代码为400或者更高的应答。</span>
<span class="token attr-name">            proxy_intercept_errors</span> <span class="token attr-value">on;</span>

<span class="token comment" spellcheck="true">            #后端服务器连接的超时时间_发起握手等候响应超时时间</span>
<span class="token comment" spellcheck="true">            #nginx跟后端服务器连接超时时间(代理连接超时)</span>
<span class="token attr-name">            proxy_connect_timeout</span> <span class="token attr-value">90;</span>

<span class="token comment" spellcheck="true">            #后端服务器数据回传时间(代理发送超时)</span>
<span class="token comment" spellcheck="true">            #后端服务器数据回传时间_就是在规定时间之内后端服务器必须传完所有的数据</span>
<span class="token attr-name">            proxy_send_timeout</span> <span class="token attr-value">90;</span>

<span class="token comment" spellcheck="true">            #连接成功后，后端服务器响应时间(代理接收超时)</span>
<span class="token comment" spellcheck="true">            #连接成功后_等候后端服务器响应时间_其实已经进入后端的排队之中等候处理（也可以说是后端服务器处理请求的时间）</span>
<span class="token attr-name">            proxy_read_timeout</span> <span class="token attr-value">90;</span>

<span class="token comment" spellcheck="true">            #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span>
<span class="token comment" spellcheck="true">            #设置从被代理服务器读取的第一部分应答的缓冲区大小，通常情况下这部分应答中包含一个小的应答头，默认情况下这个值的大小为指令proxy_buffers中指定的一个缓冲区的大小，不过可以将其设置为更小</span>
<span class="token attr-name">            proxy_buffer_size</span> <span class="token attr-value">4k;</span>

<span class="token comment" spellcheck="true">            #proxy_buffers缓冲区，网页平均在32k以下的设置</span>
<span class="token comment" spellcheck="true">            #设置用于读取应答（来自被代理服务器）的缓冲区数目和大小，默认情况也为分页大小，根据操作系统的不同可能是4k或者8k</span>
<span class="token attr-name">            proxy_buffers</span> <span class="token attr-value">4 32k;</span>

<span class="token comment" spellcheck="true">            #高负荷下缓冲大小（proxy_buffers*2）</span>
<span class="token attr-name">            proxy_busy_buffers_size</span> <span class="token attr-value">64k;</span>

<span class="token comment" spellcheck="true">            #设置在写入proxy_temp_path时数据的大小，预防一个工作进程在传递文件时阻塞太长</span>
<span class="token comment" spellcheck="true">            #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span>
<span class="token attr-name">            proxy_temp_file_write_size</span> <span class="token attr-value">64k;</span>
        }


<span class="token comment" spellcheck="true">        #设定查看Nginx状态的地址</span>
<span class="token attr-name">        location</span> <span class="token attr-value">/NginxStatus {</span>
<span class="token attr-name">            stub_status</span> <span class="token attr-value">on;</span>
<span class="token attr-name">            access_log</span> <span class="token attr-value">on;</span>
<span class="token attr-name">            auth_basic</span> <span class="token attr-value">"NginxStatus";</span>
<span class="token attr-name">            auth_basic_user_file</span> <span class="token attr-value">confpasswd;</span>
<span class="token comment" spellcheck="true">            #htpasswd文件的内容可以用apache提供的htpasswd工具来产生。</span>
        }

<span class="token comment" spellcheck="true">        #本地动静分离反向代理配置</span>
<span class="token comment" spellcheck="true">        #所有jsp的页面均交由tomcat或resin处理</span>
<span class="token attr-name">        location</span> <span class="token attr-value">~ .(jsp|jspx|do)?$ {</span>
<span class="token attr-name">            proxy_set_header</span> <span class="token attr-value">Host $host;</span>
<span class="token attr-name">            proxy_set_header</span> <span class="token attr-value">X-Real-IP $remote_addr;</span>
<span class="token attr-name">            proxy_set_header</span> <span class="token attr-value">X-Forwarded-For $proxy_add_x_forwarded_for;</span>
<span class="token attr-name">            proxy_pass</span> <span class="token attr-value">http://127.0.0.1:8080;</span>
        }

<span class="token comment" spellcheck="true">        #所有静态文件由nginx直接读取不经过tomcat或resin</span>
<span class="token attr-name">        location</span> <span class="token attr-value">~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|</span>
        pdf|xls|mp3|wma)$
        {
<span class="token attr-name">            expires</span> <span class="token attr-value">15d; </span>
        }

<span class="token attr-name">        location</span> <span class="token attr-value">~ .*.(js|css)?$</span>
        {
<span class="token attr-name">            expires</span> <span class="token attr-value">1h;</span>
        }
    }
}
<span class="token comment" spellcheck="true">######Nginx配置文件nginx.conf中文详解#####</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2><span id="si-chang-yong-ming-ling">四、常用命令</span><a href="#si-chang-yong-ming-ling" class="header-anchor">.</a></h2><pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> 进入nginx可执行文件目录</span>
cd /usr/local/nginx/sbin

<span class="token title important"><span class="token punctuation">#</span> 1.查看nginx版本</span>
./nginx -v
<span class="token code keyword">    nginx version: nginx/1.18.0</span>

<span class="token title important"><span class="token punctuation">#</span> 2.启动nginx</span>
./nginx

<span class="token title important"><span class="token punctuation">#</span> 3.停止nginx</span>
./nginx -s stop

<span class="token title important"><span class="token punctuation">#</span> 4.重新加载nginx（修改配置文件后使用）</span>
./nginx -s reload
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2><span id="wu-nginx-de-pei-zhi">五、Nginx的配置</span><a href="#wu-nginx-de-pei-zhi" class="header-anchor">.</a></h2><h3><span id="1-fan-xiang-dai-li-1">1、反向代理-1</span><a href="#1-fan-xiang-dai-li-1" class="header-anchor">.</a></h3><h4><span id="shi-xian-xiao-guo-jie-shi">①实现效果解释：</span><a href="#shi-xian-xiao-guo-jie-shi" class="header-anchor">.</a></h4><blockquote>
<p><strong>通过nginx访问到 tomcat服务</strong></p>
<p>打开浏览器，地址栏输入 <a href="http://www.123.com" target="_blank" rel="noopener">www.123.com</a> ，跳转到linux设备上tomcat主页</p>
</blockquote>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213140251.png" alt></p>
<p>前提安装tomcat服务器，并启动tomcat，如果有防火墙需要开放8080端口</p>
<p>安装教程:<a href="https://blog.csdn.net/qq_40618664/article/details/94875995" target="_blank" rel="noopener">https://blog.csdn.net/qq_40618664/article/details/94875995</a></p>
<p>开放端口：<a href="https://blog.csdn.net/luchenh/article/details/106329236" target="_blank" rel="noopener">https://blog.csdn.net/luchenh/article/details/106329236</a></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213135950.png" alt="访问tomcat服务"></p>
<h4><span id="pei-zhi-bu-zou">②配置步骤</span><a href="#pei-zhi-bu-zou" class="header-anchor">.</a></h4><h5><span id="1-zai-window-de-hosts-wen-jian-zhong-tian-jia">（1）在window的hosts文件中，添加</span><a href="#1-zai-window-de-hosts-wen-jian-zhong-tian-jia" class="header-anchor">.</a></h5><p><code>C:\Windows\System32\drivers\etc\hosts</code></p>
<blockquote>
<p>修改hosts需要管理员权限</p>
</blockquote>
<pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> nginx所在linux设备的ip地址(根据实际的修改)  域名，如下</span>
192.168.17.129 www.123.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5><span id="2-pei-zhi-nginx-conf-server-kuai-de-location-kuai-zhong">（2）配置nginx.conf(server块的location块中)</span><a href="#2-pei-zhi-nginx-conf-server-kuai-de-location-kuai-zhong" class="header-anchor">.</a></h5><pre class="line-numbers language-markdown"><code class="language-markdown">proxy_pass http://127.0.0.1:8080;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213141954.png" alt></p>
<blockquote>
<p>保存，重加载nginx</p>
</blockquote>
<h5><span id="3-fang-wen-www-123-com">（3）访问</span><a href="#3-fang-wen-www-123-com" class="header-anchor">.</a></h5><p><img src="/2020/12/13/61876/image-20201213142916658.png" alt></p>
<h3><span id="2-fan-xiang-dai-li-2">2、反向代理-2</span><a href="#2-fan-xiang-dai-li-2" class="header-anchor">.</a></h3><h4><span id="shi-xian-xiao-guo-jie-shi">①实现效果解释：</span><a href="#shi-xian-xiao-guo-jie-shi" class="header-anchor">.</a></h4><blockquote>
<p><strong>通过不同路径，访问到不同应用</strong></p>
<p>访问：<a href="http://www.123.com/tomcat8" target="_blank" rel="noopener">http://www.123.com/tomcat8</a> 跳转到 <a href="http://www.123.com:8080/tomcat8,访问到tomcat8界面" target="_blank" rel="noopener">www.123.com:8080/tomcat8,访问到tomcat8界面</a>;</p>
<p>访问：<a href="http://www.123.com/tomcat9" target="_blank" rel="noopener">http://www.123.com/tomcat9</a>  跳转到 <a href="http://www.123.com:8081/tomcat9,访问到tomcat8界面" target="_blank" rel="noopener">www.123.com:8081/tomcat9,访问到tomcat8界面</a>;</p>
</blockquote>
<p>前提：再安装一个版本为9的tomcat服务器，更改端口为8081，并启动服务</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213150326.png" alt="tomcat8"></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213150343.png" alt="tomcat9"></p>
<h4><span id="pei-zhi-bu-zou">②配置步骤</span><a href="#pei-zhi-bu-zou" class="header-anchor">.</a></h4><h5><span id="1-fu-zhi-webapps-xia-root-mu-lu-gt-tomcat8-9-liang-ge-an-zhuang-mu-lu">（1）复制webapps下 ROOT目录==&gt; tomcat8/9 (两个安装目录)</span><a href="#1-fu-zhi-webapps-xia-root-mu-lu-gt-tomcat8-9-liang-ge-an-zhuang-mu-lu" class="header-anchor">.</a></h5><p><img src="/2020/12/13/61876/image-20201213160613378.png" alt></p>
<h5><span id="2-pei-zhi-nginx-conf-server-kuai-de-location-kuai-zhong">（2）配置nginx.conf(server块的location块中)</span><a href="#2-pei-zhi-nginx-conf-server-kuai-de-location-kuai-zhong" class="header-anchor">.</a></h5><pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">location</span> <span class="token attr-value">~ /tomcat8/ {</span>
<span class="token attr-name">    proxy_pass</span> <span class="token attr-value">http://127.0.0.1:8080; # 访问www.123.com/tomcat8/ => www.123.com:8080/tomcat8/</span>
}

<span class="token attr-name">location</span> <span class="token attr-value">~ /tomcat9/ {</span>
<span class="token attr-name">    proxy_pass</span> <span class="token attr-value">http://127.0.0.1:8081; # 访问www.123.com/tomcat9/ => www.123.com:8080/tomcat9/</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213152044.png" alt></p>
<blockquote>
<p>重启服务nginx</p>
</blockquote>
<h4><span id="fang-wen-liuyou-tomcat8-he-liuyou-tomcat9">③访问liuyou/tomcat8/和liuyou/tomcat9/</span><a href="#fang-wen-liuyou-tomcat8-he-liuyou-tomcat9" class="header-anchor">.</a></h4><blockquote>
<p>因为服务器没有备案，所以<a href="http://www.123.com被禁用了，以下使用liuyou代替" target="_blank" rel="noopener">www.123.com被禁用了，以下使用liuyou代替</a></p>
</blockquote>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213164109.png" alt></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213164158.png" alt></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213164224.png" alt></p>
<h3><span id="3-fu-zai-jun-heng">3、负载均衡</span><a href="#3-fu-zai-jun-heng" class="header-anchor">.</a></h3><h4><span id="shi-xian-xiao-guo-jie-shi">①实现效果解释：</span><a href="#shi-xian-xiao-guo-jie-shi" class="header-anchor">.</a></h4><blockquote>
<p>多次请求<a href="http://www.123.com/nginx，这些平均请求分担到8080和8081上的两台服务器上" target="_blank" rel="noopener">http://www.123.com/nginx，这些平均请求分担到8080和8081上的两台服务器上</a></p>
</blockquote>
<h4><span id="pei-zhi-bu-zou">②配置步骤</span><a href="#pei-zhi-bu-zou" class="header-anchor">.</a></h4><h5><span id="pei-zhi-nginx-conf">配置nginx.conf</span><a href="#pei-zhi-nginx-conf" class="header-anchor">.</a></h5><pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">upstream</span> <span class="token attr-value">myserver{</span>
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8080;</span>
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8081;</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">location</span> <span class="token attr-value">/ {</span>
<span class="token attr-name">    root</span> <span class="token attr-value">  html;</span>
<span class="token attr-name">    proxy_pass</span> <span class="token attr-value">http://myserver; # /下的请求会 平均分发到8080和8081</span>
<span class="token attr-name">    index</span> <span class="token attr-value"> index.html index.htm;</span>
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213164445.png" alt></p>
<blockquote>
<p>重加载nginx</p>
</blockquote>
<h4><span id="fang-wen-liuyou">③访问liuyou/</span><a href="#fang-wen-liuyou" class="header-anchor">.</a></h4><p>第一次：</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213164431.png" alt></p>
<p>第二次：</p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213164437.png" alt></p>
<h4><span id="fen-pei-ce-lue">分配策略：</span><a href="#fen-pei-ce-lue" class="header-anchor">.</a></h4><h5><span id="1-lun-xun-mo-ren">1、轮询（默认）</span><a href="#1-lun-xun-mo-ren" class="header-anchor">.</a></h5><p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>
<h5><span id="2-weight">2、weight</span><a href="#2-weight" class="header-anchor">.</a></h5><p>weight 代表权重，默认为1,权重越高被分配的客户端越多。<br>指定轮询几率，weight和访间比率成正比，用于后端服务器性能不均的情况。例如,</p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">upstream</span> <span class="token attr-value">myserver{</span>
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8080 weight=1;</span>
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8081 weight=10;</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="3-ip-hash">3、ip_hash</span><a href="#3-ip-hash" class="header-anchor">.</a></h5><p>每个请求按访问ip的hash结果分配,这样每个访客固定访问一个后端服务器,可以解决 session的问题。例如：</p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">upstream</span> <span class="token attr-value">myserver{</span>
    ip_hash;
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8080;</span>
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8081;</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5><span id="4-fair-di-san-fang">4、fair（第三方）</span><a href="#4-fair-di-san-fang" class="header-anchor">.</a></h5><p>按后端服务器的响应时间分配请求，响应时间短的优先分配。</p>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token attr-name">upstream</span> <span class="token attr-value">myserver{</span>
    fair;
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8080;</span>
<span class="token attr-name">    server</span> <span class="token attr-value">127.0.0.1:8081;</span>
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3><span id="4-dong-jing-fen-chi">4、动静分离</span><a href="#4-dong-jing-fen-chi" class="header-anchor">.</a></h3><h4><span id="shi-xian-xiao-guo-jie-shi">①实现效果解释：</span><a href="#shi-xian-xiao-guo-jie-shi" class="header-anchor">.</a></h4><blockquote>
<p>通过liuyou/img/.png访问到图片（使用nginx）</p>
</blockquote>
<h4><span id="pei-zhi-bu-zou">②配置步骤</span><a href="#pei-zhi-bu-zou" class="header-anchor">.</a></h4><h5><span id="1-zhun-bei-gong-zuo">（1）准备工作：</span><a href="#1-zhun-bei-gong-zuo" class="header-anchor">.</a></h5><p>在/下创建data/img目录，并将 本地图片 上传到该目录下</p>
<pre><code>cd /
mkdir -p /data/img

# 使用 xftp上传图片到该目录
[root@liuyou img]# ll
total 60
-rw-r--r-- 1 root root 57381 Dec 13 17:19 饼图.gif</code></pre><h5><span id="2-pei-zhi-nginx-conf-server-kuai-de-location-kuai-zhong">（2）配置nginx.conf(server块的location块中)</span><a href="#2-pei-zhi-nginx-conf-server-kuai-de-location-kuai-zhong" class="header-anchor">.</a></h5><h4><span id="fang-wen-liuyou-img-he-liuyou-img-bing-tu-gif">③访问liuyou/img/ 和 liuyou/img/饼图.gif</span><a href="#fang-wen-liuyou-img-he-liuyou-img-bing-tu-gif" class="header-anchor">.</a></h4><p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213172755.png" alt></p>
<p><img src="https://liuyou-images.oss-cn-hangzhou.aliyuncs.com/markdown/20201213172748.png" alt></p>
<h3><span id="5-gao-ke-yong">5、高可用</span><a href="#5-gao-ke-yong" class="header-anchor">.</a></h3><h4><span id>①</span><a href="#" class="header-anchor">.</a></h4><h4><span id>②</span><a href="#" class="header-anchor">.</a></h4><h5><span id="1-zhun-bei-gong-zuo">（1）准备工作</span><a href="#1-zhun-bei-gong-zuo" class="header-anchor">.</a></h5><h6><span id="liang-tai-fu-wu-qi">两台服务器</span><a href="#liang-tai-fu-wu-qi" class="header-anchor">.</a></h6><ul>
<li>主：hadoop：192.168.111.10</li>
<li>备：hadoop1：192.168.111.20</li>
</ul>
<h6><span id="liang-tai-fu-wu-qi-du-yi-an-zhuang-tomcat-fu-wu-qi">两台服务器 都已安装tomcat服务器</span><a href="#liang-tai-fu-wu-qi-du-yi-an-zhuang-tomcat-fu-wu-qi" class="header-anchor">.</a></h6><ul>
<li>hadoop：tomcat8</li>
<li>hadoop1：tomcat9</li>
</ul>
<h6><span id="liang-tai-fu-wu-qi-du-an-zhuang-pei-zhi-liao-nginx">两台服务器都 安装配置了nginx</span><a href="#liang-tai-fu-wu-qi-du-an-zhuang-pei-zhi-liao-nginx" class="header-anchor">.</a></h6><p><strong>nginx.conf内容如下：</strong></p>
<p><img src="/2020/12/13/61876/image-20201213200338903.png" alt></p>
<h6><span id="liang-tai-fu-wu-qi-an-zhuang-liao-keepalived">两台服务器 安装了keepalived</span><a href="#liang-tai-fu-wu-qi-an-zhuang-liao-keepalived" class="header-anchor">.</a></h6><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true"># 安装keepalived</span>
<span class="token attr-name">yum</span> <span class="token attr-value">install keepalived -y</span>
<span class="token comment" spellcheck="true"># 查看安装情况 安装位置在: /etc/keepalived</span>
<span class="token attr-name">rpm</span> <span class="token attr-value">-qa keepalived</span>

<span class="token comment" spellcheck="true"># 打开配置文件</span>
<span class="token attr-name">vim</span> <span class="token attr-value">/etc/keepalived/keepalived.conf</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6><span id="xu-ni-ip">虚拟ip</span><a href="#xu-ni-ip" class="header-anchor">.</a></h6><ul>
<li><code>192.168.111.100</code></li>
</ul>
<h6><span id="liang-tai-fu-wu-qi-zhuang-tai">两台服务器状态：</span><a href="#liang-tai-fu-wu-qi-zhuang-tai" class="header-anchor">.</a></h6><ul>
<li>tomcat已开启</li>
<li>nginx已开启</li>
</ul>
<h5><span id="2-pei-zhi-keepalived-conf">（2）配置（keepalived.conf）</span><a href="#2-pei-zhi-keepalived-conf" class="header-anchor">.</a></h5><blockquote>
<p>vim /etc/keepalived/keepalived.conf</p>
</blockquote>
<p><strong>注意：需要注释 <code>vrrp_strict</code></strong>，不然会出现ping不通VIP的情况</p>
<h6><span id="zhu-ji-hadoop-pei-zhi-wen-jian-nei-rong-geng-gai-wei">主机（hadoop）配置文件内容更改为：</span><a href="#zhu-ji-hadoop-pei-zhi-wen-jian-nei-rong-geng-gai-wei" class="header-anchor">.</a></h6><pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">! Configuration File for keepalived</span>

<span class="token comment" spellcheck="true">## 全局配置</span>
<span class="token attr-name">global_defs</span> <span class="token attr-value">{</span>
<span class="token attr-name">   notification_email</span> <span class="token attr-value">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
<span class="token attr-name">   notification_email_from</span> <span class="token attr-value">Alexandre.Cassen@firewall.loc</span>
<span class="token attr-name">   smtp_server</span> <span class="token attr-value">192.168.111.10</span>
<span class="token attr-name">   smtp_connect_timeout</span> <span class="token attr-value">30</span>
<span class="token attr-name">   router_id</span> <span class="token attr-value">LVS_DEVEL        # 标识本节点的字符串，通常为 hostname，也可以是本机ip</span>
   vrrp_skip_check_adv_addr
<span class="token comment" spellcheck="true">   # vrrp_strict</span>
<span class="token attr-name">   vrrp_garp_interval</span> <span class="token attr-value">0</span>
<span class="token attr-name">   vrrp_gna_interval</span> <span class="token attr-value">0</span>
}

<span class="token comment" spellcheck="true">## keepalived 会定时执行脚本并对脚本执行的结果进行分析，动态调整vrrp_instance 的优先级</span>
<span class="token attr-name">vrrp_script</span> <span class="token attr-value">chk_http_port {</span>
<span class="token attr-name">    script</span> <span class="token attr-value">"/usr/local/src/nginx_check.sh" # 检测 nginx 状态的脚本路径</span>
<span class="token attr-name">    interval</span> <span class="token attr-value">2    # 检测脚本执行的间隔</span>
<span class="token attr-name">    weight</span> <span class="token attr-value">-20    # 如果条件成立，权重-20</span>
}

<span class="token comment" spellcheck="true">## 定义虚拟路由， VI_1 为虚拟路由的标示符，自己定义名称</span>
<span class="token attr-name">vrrp_instance</span> <span class="token attr-value">VI_1 {</span>
<span class="token attr-name">    state</span> <span class="token attr-value">MASTER # 主节点为 MASTER， 对应的备份节点为 BACKUP</span>
<span class="token attr-name">    interface</span> <span class="token attr-value">ens33 # 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网络接口相同</span>
<span class="token attr-name">    virtual_router_id</span> <span class="token attr-value">51 # 虚拟路由的 ID 号， 两个节点设置必须一样， 可选 IP 最后一段使用, 相同的 VRID 为一个组，他将决定多播的 MAC 地址</span>
<span class="token attr-name">    priority</span> <span class="token attr-value">100 #节点优先级， 值范围 0-254， MASTER 要比 BACKUP 高</span>
<span class="token attr-name">    advert_int</span> <span class="token attr-value">1 # 组播信息发送间隔，两个节点设置必须一样， 默认 1s</span>
<span class="token attr-name">    authentication</span> <span class="token attr-value">{ # 设置验证信息，两个节点必须一致</span>
<span class="token attr-name">        auth_type</span> <span class="token attr-value">PASS</span>
<span class="token attr-name">        auth_pass</span> <span class="token attr-value">1111  # 真实生产，按需求对应该过来</span>
    }
<span class="token attr-name">    virtual</span> <span class="token attr-value">_ipaddress {</span>
<span class="token attr-name">        192.168.111.100</span> <span class="token attr-value"># 虚拟 ip，可以定义多个</span>
    }

<span class="token attr-name">    track_script</span> <span class="token attr-value">{</span>
<span class="token attr-name">        chk_http_port</span> <span class="token attr-value"># 追踪脚本，和上面的脚本名一致</span>
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6><span id="bei-ji-hadoop1-pei-zhi-wen-jian-nei-rong-geng-gai-wei">备机（hadoop1）配置文件内容更改为：</span><a href="#bei-ji-hadoop1-pei-zhi-wen-jian-nei-rong-geng-gai-wei" class="header-anchor">.</a></h6><blockquote>
<p>相较于主机更改了‘<code>state</code>(BACKUP)、<code>priority</code>(80)、<code>route_id</code>(192.168.111.20)</p>
</blockquote>
<pre class="line-numbers language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">! Configuration File for keepalived</span>

<span class="token comment" spellcheck="true">## 全局配置</span>
<span class="token attr-name">global_defs</span> <span class="token attr-value">{</span>
<span class="token attr-name">   notification_email</span> <span class="token attr-value">{</span>
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
<span class="token attr-name">   notification_email_from</span> <span class="token attr-value">Alexandre.Cassen@firewall.loc</span>
<span class="token attr-name">   smtp_server</span> <span class="token attr-value">192.168.111.20</span>
<span class="token attr-name">   smtp_connect_timeout</span> <span class="token attr-value">30</span>
<span class="token attr-name">   router_id</span> <span class="token attr-value">LVS_DEVEL        # 标识本节点的字符串，通常为 hostname，也可以是本机ip</span>
   vrrp_skip_check_adv_addr
<span class="token comment" spellcheck="true">   # vrrp_strict</span>
<span class="token attr-name">   vrrp_garp_interval</span> <span class="token attr-value">0</span>
<span class="token attr-name">   vrrp_gna_interval</span> <span class="token attr-value">0</span>
}

<span class="token comment" spellcheck="true">## keepalived 会定时执行脚本并对脚本执行的结果进行分析，动态调整vrrp_instance 的优先级</span>
<span class="token attr-name">vrrp_script</span> <span class="token attr-value">chk_http_port {</span>
<span class="token attr-name">    script</span> <span class="token attr-value">"/usr/local/src/nginx_check.sh" # 检测 nginx 状态的脚本路径</span>
<span class="token attr-name">    interval</span> <span class="token attr-value">2    # 检测脚本执行的间隔</span>
<span class="token attr-name">    weight</span> <span class="token attr-value">-20    # 如果条件成立，权重-20</span>
}

<span class="token comment" spellcheck="true">## 定义虚拟路由， VI_1 为虚拟路由的标示符，自己定义名称</span>
<span class="token attr-name">vrrp_instance</span> <span class="token attr-value">VI_1 {</span>
<span class="token attr-name">    state</span> <span class="token attr-value">BACKUP # 主节点为 MASTER， 对应的备份节点为 BACKUP</span>
<span class="token attr-name">    interface</span> <span class="token attr-value">ens33 # 绑定虚拟 IP 的网络接口，与本机 IP 地址所在的网络接口相同</span>
<span class="token attr-name">    virtual_router_id</span> <span class="token attr-value">51 # 虚拟路由的 ID 号， 两个节点设置必须一样， 可选 IP 最后一段使用, 相同的 VRID 为一个组，他将决定多播的 MAC 地址</span>
<span class="token attr-name">    priority</span> <span class="token attr-value">80 #节点优先级， 值范围 0-254， MASTER 要比 BACKUP 高</span>
<span class="token attr-name">    advert_int</span> <span class="token attr-value">1 # 组播信息发送间隔，两个节点设置必须一样， 默认 1s</span>
<span class="token attr-name">    authentication</span> <span class="token attr-value">{ # 设置验证信息，两个节点必须一致</span>
<span class="token attr-name">        auth_type</span> <span class="token attr-value">PASS</span>
<span class="token attr-name">        auth_pass</span> <span class="token attr-value">1111  # 真实生产，按需求对应该过来</span>
    }
<span class="token attr-name">    virtual</span> <span class="token attr-value">_ipaddress {</span>
<span class="token attr-name">        192.168.111.100</span> <span class="token attr-value"># 虚拟 ip，可以定义多个</span>
    }

<span class="token attr-name">    track_script</span> <span class="token attr-value">{</span>
<span class="token attr-name">        chk_http_port</span> <span class="token attr-value"># 追踪脚本，和上面的脚本名一致</span>
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6><span id="chuang-jian-jiao-ben-wen-jian-nginx-check-sh">创建脚本文件（nginx_check.sh）</span><a href="#chuang-jian-jiao-ben-wen-jian-nginx-check-sh" class="header-anchor">.</a></h6><blockquote>
<p>其存放路径为 <code>/usr/local/src/nginx_check.sh</code>，两台服务器都需要配置</p>
</blockquote>
<blockquote>
<p>更改器文件权限：<code>chmod 744 /usr/local/src/nginx_check.sh</code> </p>
</blockquote>
<p><code>解读脚本，定义变量，此变量为检查nginx进程脚本，如果进程为0，则启动nginx服务，再次检查nginx服务，如果仍没启动 ，杀掉所有keepalived的进程。</code></p>
<pre class="line-numbers language-sh"><code class="language-sh">#!/bin/bash
A=`ps -C nginx --no-header | wc -l`
if [ $A -eq 0 ]; then
    /usr/local/nginx/sbin/nginx
    sleep 2
    if [ `ps -C nginx --no-header | wc -l` -eq 0 ];then
        killall keepalived
    fi
fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="qi-dong-fu-wu">③启动服务</span><a href="#qi-dong-fu-wu" class="header-anchor">.</a></h4><blockquote>
<p>两台服务器 启动服务</p>
</blockquote>
<pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> 启动 tomcat 服务 进入tomcat安装目录下bin</span>
./startup.sh
<span class="token title important"><span class="token punctuation">#</span> 查看服务启动情况</span>
ps -ef | grep tomcat

<span class="token title important"><span class="token punctuation">#</span> 启动 nginx 服务 进入nginx安装目录下sbin</span>
<span class="token title important"><span class="token punctuation">#</span> 若已启动,使用 ./nginx -s reload </span>
./nginx
<span class="token title important"><span class="token punctuation">#</span> 查看服务启动情况</span>
ps -ef | grep nginx

<span class="token title important"><span class="token punctuation">#</span> 启动 keepalived 服务</span>
systemctl start keepalived
<span class="token title important"><span class="token punctuation">#</span> 查看服务启动情况</span>
ps -ef | grep keepalived<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="ce-shi">④测试</span><a href="#ce-shi" class="header-anchor">.</a></h4><blockquote>
<p>浏览器地址栏访问 虚拟ip <a href="http://192.168.111.100/" target="_blank" rel="noopener">http://192.168.111.100/</a></p>
</blockquote>
<p><strong>可以正常访问到页面</strong></p>
<p><img src="/2020/12/13/61876/image-20201214194617687.png" alt></p>
<p><strong>主机可以查看到已绑定VIP</strong></p>
<pre><code>ip a</code></pre><p><img src="/2020/12/13/61876/image-20201214194841148.png" alt></p>
<blockquote>
<p>如果主服务器的keepalived停止服务，从服务器会自动接管VIP对外服务；一旦主服务器的keepalived恢复，会重新接管VIP</p>
</blockquote>
<h5><span id="yan-zheng-guo-cheng-bu-zuo-yan-shi">验证（过程不做演示）：</span><a href="#yan-zheng-guo-cheng-bu-zuo-yan-shi" class="header-anchor">.</a></h5><p><strong>（1）先后在主、从服务器上启动keepalived；<br>（2）在主服务器上查看是否已经绑定了虚拟IP： ip addr；<br>（3）停止主服务器上的keepalived，然后在从服务器上查看是否已经绑定了虚拟IP：<br>（4）启动主服务器上的keepalived，看看主服务器能否重新接管虚拟IP。</strong></p>
<blockquote>
<p>但这我们需要的是当NginX停止服务的时候能够自动切换。<br>keepalived支持配置监控脚本，我们可以通过脚本监控Nginx的状态，如果状态不正常则进行一系列的操作，最终仍不能恢复Nginx则杀掉keepalived，使得从服务器能够接管服务。</p>
<p>这个脚本就是 之前配置的脚本 <code>nginx_check.sh</code>，当nginx死掉，会重启该nginx或vip绑定其他nginx</p>
</blockquote>
<h2><span id="liu-zhi-xing-yuan-li">六、执行原理</span><a href="#liu-zhi-xing-yuan-li" class="header-anchor">.</a></h2><p><img src="/2020/12/13/61876/image-20201213214551953.png" alt></p>
<p><img src="/2020/12/13/61876/image-20201213214907576.png" alt></p>
<h3><span id="master-he-worker">master 和 worker</span><a href="#master-he-worker" class="header-anchor">.</a></h3><blockquote>
<p>下面默认nginx启动是一个master和一个worker</p>
<p>worker可以有多个</p>
</blockquote>
<p><img src="/2020/12/13/61876/image-20201213214753978.png" alt></p>
<ul>
<li><code>master</code> ：管理worker</li>
<li><code>worker</code></li>
</ul>
<p>master接收到用户的请求，它把请求给其下的worker，worker通过争抢的方式获取请求；获取请求的worker通过反向代理转发请求</p>
<h3><span id="cai-yong-master-worker-de-hao-chu">采用master-worker的好处</span><a href="#cai-yong-master-worker-de-hao-chu" class="header-anchor">.</a></h3><h4><span id="1-li-yu-nginx-s-reload-jin-xing-re-bu-shu">1、利于 nginx -s reload进行热部署</span><a href="#1-li-yu-nginx-s-reload-jin-xing-re-bu-shu" class="header-anchor">.</a></h4><blockquote>
<p>当项目部署后，nginx接收到用户请求，其中一个worker处理请求；当我们此时使用重加载，之前的worker继续处理请求，其他worker进行重加载。</p>
</blockquote>
<p>首先，对于每个worker进程来说，独立的进程，不需要加锁，所以省掉了锁带来的开销，同时在编程以及问题查找时，也会方便很多。其次，采用独立的进程，可以让互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master进程则很快启动新的worker进程。当然，worker进程的异常退出，肯定是程序有 bug了，异常退出，会导致当前worker上的所有请求失败，不过不会影响到所有请求，所以降低了风险。</p>
<h3><span id="worker-de-ge-shu">worker的个数？</span><a href="#worker-de-ge-shu" class="header-anchor">.</a></h3><p>Nginx同Redis类似都采用了io多路复用机制，每个worker都是一个独立的进程，但每个进程里只有一个主线程，异步非阻塞的方式来处理请求，即使是成千上万个请求也不在话下。每个worker的线程可以把一个cpu的性能发挥极致。所以<mark>worker数和服务器的cpu数相等时最为适宜的</mark>。设少了会浪费cpu，设多了会造成cpu频繁切换上下文带来的损耗。</p>
<h3><span id="worker-de-lian-jie-shu">worker的连接数</span><a href="#worker-de-lian-jie-shu" class="header-anchor">.</a></h3><h4><span id="1-fa-song-yi-ge-qing-qiu-zhan-yong-liao-worker-de-ji-ge-lian-jie-shu">1、发送一个请求，占用了worker的几个连接数？</span><a href="#1-fa-song-yi-ge-qing-qiu-zhan-yong-liao-worker-de-ji-ge-lian-jie-shu" class="header-anchor">.</a></h4><p><code>2或4个</code></p>
<pre class="line-numbers language-markdown"><code class="language-markdown"><span class="token title important"><span class="token punctuation">#</span> 2个</span>
如果请求的是静态资源
client ==> worker
worker ==> client

<span class="token title important"><span class="token punctuation">#</span> 4个</span>
如果请求的是动态资源
client ==> worker ==> tomcat
tomcat ==> worker ==> client<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4><span id="2-jia-ru-you-4-ge-worker-mei-ge-worker-lian-jie-shu-wei-1024-na-me-neng-gou-jie-shou-de-bing-fa-liang-shi-duo-shao">2、假如有4个worker，每个worker连接数为1024，那么能够接受的并发量是多少</span><a href="#2-jia-ru-you-4-ge-worker-mei-ge-worker-lian-jie-shu-wei-1024-na-me-neng-gou-jie-shou-de-bing-fa-liang-shi-duo-shao" class="header-anchor">.</a></h4><p><code>最多2048 最少1024</code></p>
<pre><code># worker支持的最大连接数
# worker数 * worker连接数 = 最大连接数
4 * 1024 = 4096

# 并发量 2048 如果所有请求都是静态资源
4096 / 2 = 2048

# 并发量 1024 如果所有请求都是动态资源
4096 / 4 = 1024</code></pre>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://www.liuminkai.top" rel="external nofollow noreferrer">liuminkai</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://www.liuminkai.top/2020/12/13/61876.html">http://www.liuminkai.top/2020/12/13/61876.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="http://www.liuminkai.top" target="_blank">liuminkai</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/java/">
                                    <span class="chip bg-color">java</span>
                                </a>
                            
                                <a href="/tags/nginx/">
                                    <span class="chip bg-color">nginx</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/gitalk/gitalk.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '4e04421bf007cd448eb3',
        clientSecret: '98d0aaec7d39c4c8ba7ef6118575f68eafc77951',
        repo: 'blogtalk',
        owner: 'liuminkai-blog',
        admin: ["liuminkai-blog"],
        id: '2020-12-13T02-39-41',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/12/13/14729.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/featureimages/10.jpg" class="responsive-img" alt="linux开放防火墙端口">
                        
                        <span class="card-title">linux开放防火墙端口</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            https://blog.csdn.net/luchenh/article/details/106329236
https://www.jianshu.com/p/dc49ed9fbfcf
linux开放防火墙端口.查看防火墙服务状态：
#
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-12-13
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/" class="post-category">
                                    使用教程
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/linux/">
                        <span class="chip bg-color">linux</span>
                    </a>
                    
                    <a href="/tags/firewell/">
                        <span class="chip bg-color">firewell</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/12/10/63295.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//medias/featureimages/10.jpg" class="responsive-img" alt="elementUI实战应用">
                        
                        <span class="card-title">elementUI实战应用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
官网：https://element.eleme.cn/

element ui 就是基于Vue的一个ui框架，该框架基于vue开发了很多相关组件，方便我们快速开发页面
实战软件：WebStorm
一、安装ElementUI.1、安装vu
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-12-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-category">
                                    学习笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/elementUI/">
                        <span class="chip bg-color">elementUI</span>
                    </a>
                    
                    <a href="/tags/vue-cli/">
                        <span class="chip bg-color">vue-cli</span>
                    </a>
                    
                    <a href="/tags/vue/">
                        <span class="chip bg-color">vue</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->


<script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="http://www.liuminkai.top" target="_blank">liuminkai</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">287.4k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/kaiminliu" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:liuyou2021@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>




    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1423928650" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1423928650" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//js/matery.js"></script>

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/others/busuanzi.pure.mini.js"></script>
    

    

	
    

    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/liuminkai-blog/liuminkai-blog.github.io//libs/instantpage/instantpage.js" type="module"></script>
    
	
	
	<!-- 一言API -->
	<!-- 现代写法，推荐 -->
	<!-- 兼容低版本浏览器 (包括 IE)，可移除 -->
	<script src="https://cdn.jsdelivr.net/npm/bluebird@3/js/browser/bluebird.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@2.0.3/fetch.min.js"></script>
	<!--End-->
	<script>
	  fetch('https://v1.hitokoto.cn')
		.then(function (res){
		  return res.json();
		})
		.then(function (data) {
		  var hitokoto = document.getElementById('hitokoto');
		  hitokoto.innerText = data.hitokoto + '——【' + data.from + '】';
		})
		.catch(function (err) {
		  console.error(err);
		})
	</script>
</body>

</html>
